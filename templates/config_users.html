<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Utilisateurs - Sonneries Collège</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Barre de Navigation -->
    <div style="text-align: right; margin-bottom: 10px; font-size: 0.9em;">
       {% if current_user and current_user.is_authenticated %}
         Connecté: <strong>{{ current_user.id }}</strong> (Rôle: {{ current_user.role }}) |
         {% if user_has_permission('page:view_control') %}<a href="{{ url_for('index') }}">Contrôle Principal</a> |{% endif %}
         {% if user_has_permission('page:view_config_general') %}<a href="{{ url_for('config_general_page') }}">Config Générale</a> |{% endif %}
         {% if user_has_permission('page:view_config_weekly') %}<a href="{{ url_for('config_weekly_page') }}">Config Hebdo</a> |{% endif %}
         {% if user_has_permission('page:view_config_day_types') %}<a href="{{ url_for('config_day_types_page') }}">Journées Types</a> |{% endif %}
         {% if user_has_permission('page:view_config_exceptions') %}<a href="{{ url_for('config_exceptions_page') }}">Exceptions</a> |{% endif %}
         {% if user_has_permission('page:view_config_sounds') %}<a href="{{ url_for('config_sounds_page') }}">Sonneries</a> |{% endif %}
         {% if user_has_permission('page:view_config_users') %}<a href="{{ url_for('config_users_page') }}">Gestion Utilisateurs</a> |{% endif %}
         <a href="{{ url_for('logout') }}">Déconnexion</a>
       {% else %}
         (Non Connecté) <a href="{{ url_for('login') }}">Se connecter</a>
       {% endif %}
     </div>

    <h1>Gestion des Utilisateurs</h1>

    <div class="config-section">
        <h2>Liste des Utilisateurs</h2>
        <button id="show-add-user-form-btn" style="margin-bottom: 10px;" {% if not user_has_permission('user:create') %}disabled{% endif %}>Ajouter un Utilisateur</button>
        <table id="users-table" class="config-table">
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Nom complet</th>
                    <th>Rôle</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <tr><td colspan="4">Chargement des utilisateurs...</td></tr>
            </tbody>
        </table>
        <div id="users-feedback" class="feedback-message" style="display: none;"></div>
    </div>

    <!-- Nouvelle Section pour la Configuration des Rôles -->
    <div class="config-section" {% if not user_has_permission('user_management:edit_role_permissions') %}style="display:none;"{% endif %}>
        <h2>Configuration des Rôles</h2>
        <div class="form-group">
            <label for="role-selector">Choisir un rôle à configurer:</label>
            <select id="role-selector" name="role_selector">
                <!-- Les options de rôle seront peuplées par JavaScript -->
            </select>
        </div>
        <div id="role-permissions-tree" class="permissions-checkbox-container" style="margin-top: 10px; margin-bottom: 10px; border: 1px solid #ccc; padding: 10px;">
            <p>Sélectionnez un rôle pour voir et modifier ses permissions.</p>
        </div>
        <button id="save-role-permissions-btn">Sauvegarder les Permissions du Rôle</button>
        <div id="roles-config-feedback" class="feedback-message" style="display: none; margin-top:10px;"></div>
    </div>

    <!-- Formulaire d'Ajout d'Utilisateur (initialement caché) -->
    <div id="add-user-form-container" class="form-container" style="display:none; margin-top: 20px;">
        <h2>Ajouter un Nouvel Utilisateur</h2>
        <form id="add-user-form">
            <div class="form-group">
                <label for="add-username">Nom d'utilisateur:</label>
                <input type="text" id="add-username" name="username" required>
            </div>
            <div class="form-group">
                <label for="add-full-name">Nom complet:</label>
                <input type="text" id="add-full-name" name="full_name" required>
            </div>
            <div class="form-group">
                <label for="add-password">Mot de passe:</label>
                <input type="password" id="add-password" name="password" required>
            </div>
            <div class="form-group">
                <label for="add-confirm-password">Confirmer le mot de passe:</label>
                <input type="password" id="add-confirm-password" name="confirm_password" required>
            </div>
            <div class="form-group">
                <label for="add-role">Rôle:</label>
                <select id="add-role" name="role">
                </select>
            </div>
            <button type="submit">Enregistrer le Nouvel Utilisateur</button>
            <button type="button" id="cancel-add-user-btn">Annuler</button>
        </form>
    </div>

    <!-- Formulaire de Modification d'Utilisateur (initialement caché) -->
    <div id="edit-user-form-container" class="form-container" style="display:none; margin-top: 20px;">
        <h2>Modifier l'Utilisateur</h2>
        <form id="edit-user-form">
            <input type="hidden" id="edit-original-username" name="original_username">
            <div class="form-group">
                <label for="edit-username">Nom d'utilisateur:</label>
                <input type="text" id="edit-username" name="username" readonly style="background-color: #eee;">
            </div>
            <div class="form-group">
                <label for="edit-full-name">Nom complet:</label>
                <input type="text" id="edit-full-name" name="full_name" required>
            </div>
            <div class="form-group">
                <label for="edit-password">Nouveau mot de passe (laisser vide pour ne pas changer):</label>
                <input type="password" id="edit-password" name="password">
            </div>
            <div class="form-group">
                <label for="edit-confirm-password">Confirmer le nouveau mot de passe:</label>
                <input type="password" id="edit-confirm-password" name="confirm_password">
            </div>
            <div class="form-group">
                <label for="edit-role">Rôle:</label>
                <select id="edit-role" name="role">
                </select>
            </div>
            <button type="submit">Sauvegarder les Modifications</button>
            <button type="button" id="cancel-edit-user-btn">Annuler</button>
        </form>
    </div>

    <script>
        // Données globales pour la configuration des rôles et le modèle de permissions
        let rolesConfigData = {};
        let permissionsModelData = {};
    </script>
    <script>
        const MIN_PASSWORD_LENGTH = 8;

        document.addEventListener('DOMContentLoaded', function() {
            // --- Elements DOM ---
            const usersTableBody = document.getElementById('users-table-body');
            const feedbackDiv = document.getElementById('users-feedback');
            const rolesConfigFeedbackDiv = document.getElementById('roles-config-feedback');

            const showAddUserFormBtn = document.getElementById('show-add-user-form-btn');
            const addUserFormContainer = document.getElementById('add-user-form-container');
            const addUserForm = document.getElementById('add-user-form');
            const cancelAddUserBtn = document.getElementById('cancel-add-user-btn');
            const addRoleSelect = document.getElementById('add-role');

            const editUserFormContainer = document.getElementById('edit-user-form-container');
            const editUserForm = document.getElementById('edit-user-form');
            const cancelEditUserBtn = document.getElementById('cancel-edit-user-btn');
            const editOriginalUsernameField = document.getElementById('edit-original-username');
            const editRoleSelect = document.getElementById('edit-role');

            const roleSelector = document.getElementById('role-selector');
            const rolePermissionsTreeDiv = document.getElementById('role-permissions-tree');
            const saveRolePermissionsBtn = document.getElementById('save-role-permissions-btn');

            // --- Utility: Feedback ---
            function showFeedback(element, message, type = 'info', duration = 4000) {
                if (!element) return;
                element.textContent = message;
                element.className = 'feedback-message'; // Reset classes
                element.classList.add(type, 'show');
                element.style.display = 'block';
                setTimeout(() => {
                    element.classList.remove('show');
                    setTimeout(() => { if (!element.classList.contains('show')) element.style.display = 'none'; }, 500);
                }, duration);
            }

            function showUsersFeedback(message, type = 'info', duration = 4000) {
                showFeedback(feedbackDiv, message, type, duration);
            }
            function showRolesConfigFeedback(message, type = 'info', duration = 4000) {
                showFeedback(rolesConfigFeedbackDiv, message, type, duration);
            }

            // --- Utility: Reset Forms ---
            function resetAndHideForms() {
                addUserForm.reset();
                addUserFormContainer.style.display = 'none';
                editUserForm.reset();
                editUserFormContainer.style.display = 'none';
                editOriginalUsernameField.value = '';
            }

            // --- Load Users ---
            async function loadUsers() {
                resetAndHideForms();
                usersTableBody.innerHTML = '<tr><td colspan="4">Chargement des utilisateurs...</td></tr>';
                try {
                    const response = await fetch('/api/users');
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Erreur HTTP ${response.status}`);
                    }
                    const users = await response.json();
                    populateUsersTable(users);
                } catch (error) {
                    console.error("Erreur chargement utilisateurs:", error);
                    usersTableBody.innerHTML = `<tr><td colspan="4" style="color:red;">Erreur: ${error.message}</td></tr>`;
                    showUsersFeedback(`Erreur chargement: ${error.message}`, 'error');
                }
            }

            function populateUsersTable(users) {
                usersTableBody.innerHTML = '';
                if (!users || users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="4">Aucun utilisateur configuré.</td></tr>';
                    return;
                }
                users.forEach(user => {
                    const row = usersTableBody.insertRow();
                    row.dataset.username = user.username;
                    row.insertCell().textContent = user.username;
                    row.insertCell().textContent = user.full_name;
                    row.insertCell().textContent = user.role;
                    const actionsCell = row.insertCell();
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Modifier';
                    editBtn.classList.add('btn-small');
                    editBtn.onclick = () => showEditForm(user.username, user.full_name, user.role);
                    actionsCell.appendChild(editBtn);
                    // Désactiver le bouton si l'utilisateur n'a pas la permission user:delete
                    // Note: user_has_permission n'est pas directement dispo en JS pur sans injection spécifique
                    // La protection principale est côté serveur. Ici, c'est pour l'UI.
                    // Pour une version simple, on peut le laisser actif et le serveur refusera.
                    // Ou injecter la permission user:delete pour current_user.
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Supprimer';
                    deleteBtn.classList.add('btn-small', 'btn-danger');
                    deleteBtn.onclick = () => deleteUser(user.username);
                    actionsCell.appendChild(deleteBtn);
                });
            }

            // --- Add User Form Logic ---
            showAddUserFormBtn.addEventListener('click', () => {
                resetAndHideForms();
                addUserFormContainer.style.display = 'block';
                document.getElementById('add-username').focus();
            });
            cancelAddUserBtn.addEventListener('click', resetAndHideForms);

            addUserForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('add-username').value.trim();
                const fullName = document.getElementById('add-full-name').value.trim();
                const password = document.getElementById('add-password').value;
                const confirmPassword = document.getElementById('add-confirm-password').value;
                const role = addRoleSelect.value;

                if (!username || !fullName || !password || !confirmPassword || !role) {
                    showUsersFeedback("Tous les champs sont requis.", 'error'); return;
                }
                if (password !== confirmPassword) {
                    showUsersFeedback("Les mots de passe ne correspondent pas.", 'error'); return;
                }
                if (password.length < MIN_PASSWORD_LENGTH) {
                    showUsersFeedback(`Le mot de passe doit contenir au moins ${MIN_PASSWORD_LENGTH} caractères.`, 'error'); return;
                }

                try {
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username, full_name: fullName, password, role })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    showUsersFeedback(data.message || "Utilisateur ajouté avec succès!", 'success');
                    loadUsers(); // Recharge la liste des utilisateurs
                } catch (error) {
                    console.error("Erreur ajout utilisateur:", error);
                    showUsersFeedback(`Erreur ajout: ${error.message}`, 'error');
                }
            });

            // --- Edit User Form Logic ---
            function showEditForm(username, fullName, role) {
                resetAndHideForms();
                editOriginalUsernameField.value = username;
                document.getElementById('edit-username').value = username;
                document.getElementById('edit-full-name').value = fullName;
                editRoleSelect.value = role.toLowerCase(); // Assurer la correspondance avec les valeurs des options
                editUserFormContainer.style.display = 'block';
                document.getElementById('edit-full-name').focus();
            }
            cancelEditUserBtn.addEventListener('click', resetAndHideForms);

            editUserForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const originalUsername = editOriginalUsernameField.value;
                const fullName = document.getElementById('edit-full-name').value.trim();
                const password = document.getElementById('edit-password').value;
                const confirmPassword = document.getElementById('edit-confirm-password').value;
                const role = editRoleSelect.value;

                if (!fullName || !role) {
                    showUsersFeedback("Le nom complet et le rôle sont requis.", 'error'); return;
                }
                let payload = { full_name: fullName, role: role };
                if (password) {
                    if (password !== confirmPassword) {
                        showUsersFeedback("Les nouveaux mots de passe ne correspondent pas.", 'error'); return;
                    }
                    if (password.length < MIN_PASSWORD_LENGTH) {
                        showUsersFeedback(`Le nouveau mot de passe doit contenir au moins ${MIN_PASSWORD_LENGTH} caractères.`, 'error'); return;
                    }
                    payload.password = password;
                }

                try {
                    const response = await fetch(`/api/users/${encodeURIComponent(originalUsername)}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    showUsersFeedback(data.message || "Utilisateur modifié avec succès!", 'success');
                    loadUsers();
                } catch (error) {
                    console.error("Erreur modification utilisateur:", error);
                    showUsersFeedback(`Erreur modification: ${error.message}`, 'error');
                }
            });

            // --- Delete User Logic ---
            async function deleteUser(username) {
                if (!confirm(`Êtes-vous sûr de vouloir supprimer l'utilisateur "${username}" ? Cette action est irréversible.`)) return;
                try {
                    const response = await fetch(`/api/users/${encodeURIComponent(username)}`, { method: 'DELETE' });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    showUsersFeedback(data.message || `Utilisateur "${username}" supprimé avec succès.`, 'success');
                    loadUsers();
                } catch (error) {
                    console.error("Erreur suppression utilisateur:", error);
                    showUsersFeedback(`Erreur suppression: ${error.message}`, 'error');
                }
            }

            // --- Nouvelle Logique pour la Configuration des Rôles ---

            // Old mappings sectionKeyToPageViewPermKey and pageViewPermKeyToSectionKey are removed
            // as the new PERMISSIONS_MODEL structure allows more direct relationship derivation.

            async function initializeRolesConfigUI() {
                try {
                    const response = await fetch('/api/roles_config');
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Erreur HTTP ${response.status} lors du chargement de la config des rôles.`);
                    }
                    const data = await response.json();
                    rolesConfigData = data.roles_config;
                    permissionsModelData = data.permissions_model;

                    // Peupler les sélecteurs de rôle (celui pour la config des rôles et ceux des formulaires utilisateur)
                    roleSelector.innerHTML = '';
                    addRoleSelect.innerHTML = ''; // Vider avant de peupler
                    editRoleSelect.innerHTML = '';// Vider avant de peupler

                    if (rolesConfigData && rolesConfigData.roles) {
                        Object.keys(rolesConfigData.roles).forEach(roleName => {
                            const option = document.createElement('option');
                            option.value = roleName;
                            option.textContent = roleName;
                            roleSelector.appendChild(option.cloneNode(true));

                            // Pour les formulaires add/edit, la valeur est en minuscule
                            const formOption = document.createElement('option');
                            formOption.value = roleName.toLowerCase();
                            formOption.textContent = roleName;
                            addRoleSelect.appendChild(formOption.cloneNode(true));
                            editRoleSelect.appendChild(formOption.cloneNode(true));
                        });
                    }

                    if (roleSelector.options.length > 0) {
                        roleSelector.selectedIndex = 0;
                        displayRolePermissions(roleSelector.value);
                    } else {
                        rolePermissionsTreeDiv.innerHTML = '<p>Aucun rôle disponible pour configuration.</p>';
                        saveRolePermissionsBtn.disabled = true;
                    }

                } catch (error) {
                    console.error("Erreur initialisation UI config rôles:", error);
                    rolePermissionsTreeDiv.innerHTML = `<p style="color:red;">Erreur chargement configuration des rôles: ${error.message}</p>`;
                    saveRolePermissionsBtn.disabled = true;
                }

                roleSelector.addEventListener('change', () => displayRolePermissions(roleSelector.value));
                saveRolePermissionsBtn.addEventListener('click', saveRolePermissions);
            }

            function displayRolePermissions(selectedRoleName) {
                rolePermissionsTreeDiv.innerHTML = '';
                const roleData = rolesConfigData.roles[selectedRoleName];
                const currentRolePermissions = roleData ? roleData.permissions : {};
                const isAdministrateur = selectedRoleName === 'Administrateur';
                saveRolePermissionsBtn.disabled = isAdministrateur;

                if (!permissionsModelData || Object.keys(permissionsModelData).length === 0) {
                    rolePermissionsTreeDiv.innerHTML = '<p>Modèle de permissions non chargé.</p>';
                    return;
                }

                // Helper pour vérifier une permission dans la structure potentiellement imbriquée
                function checkPerm(permissionsObject, permKeyString) {
                    if (permKeyString.includes(':')) {
                        const [mainKey, subKey] = permKeyString.split(':', 2);
                        if (mainKey === "page") {
                            return permissionsObject[permKeyString] === true;
                        } else {
                            return (permissionsObject[mainKey] && permissionsObject[mainKey][subKey] === true);
                        }
                    } else {
                        return permissionsObject[permKeyString] === true;
                    }
                }

                // Helper function to create a permission checkbox
                function createPermissionCheckbox(permKey, permLabel, sectionKey, isPageView, pageViewKey, isAdministrateur, currentRolePermissions) {
                    const permDiv = document.createElement('div');
                    permDiv.classList.add('permission-item');
                    if (isPageView) {
                        permDiv.classList.add('permission-item-page-view');
                    }

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `role-perm-${sectionKey}-${permKey.replace(/:/g, '-')}`;
                    checkbox.dataset.permString = permKey;
                    checkbox.dataset.sectionKey = sectionKey;
                    if (isPageView) {
                        checkbox.dataset.isPageView = 'true';
                    }
                    if (pageViewKey) { // For functional permissions, store their page view key
                        checkbox.dataset.pageViewKey = pageViewKey;
                        checkbox.dataset.isFunctional = 'true';
                    }
                    checkbox.checked = checkPerm(currentRolePermissions, permKey);
                    if (isAdministrateur) {
                        checkbox.checked = true;
                        checkbox.disabled = true;
                    }

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = permLabel || permKey;
                    permDiv.appendChild(checkbox);
                    permDiv.appendChild(label);
                    return permDiv;
                }

                for (const sectionKey in permissionsModelData) {
                    const section = permissionsModelData[sectionKey];
                    const sectionDiv = document.createElement('div');
                    sectionDiv.classList.add('permission-section');
                    const sectionTitle = document.createElement('h4');
                    sectionTitle.textContent = section.label || sectionKey;
                    sectionDiv.appendChild(sectionTitle);

                    // Render Page View Permission First
                    if (section.page_view_meta) {
                        const pageViewDiv = createPermissionCheckbox(
                            section.page_view_meta.key,
                            section.page_view_meta.label,
                            sectionKey,
                            true, // isPageView
                            null, // pageViewKey (it is its own page view)
                            isAdministrateur,
                            currentRolePermissions
                        );
                        sectionDiv.appendChild(pageViewDiv);
                    }

                    // Render Functional Permissions
                    if (section.functional_permissions) {
                        for (const permKey in section.functional_permissions) {
                            const permLabel = section.functional_permissions[permKey];
                            const functionalPermDiv = createPermissionCheckbox(
                                permKey,
                                permLabel,
                                sectionKey,
                                false, // isPageView
                                section.page_view_meta ? section.page_view_meta.key : null, // pageViewKey
                                isAdministrateur,
                                currentRolePermissions
                            );
                            sectionDiv.appendChild(functionalPermDiv);
                        }
                    }

                    // Handle Old Structure (e.g., for special_permissions)
                    if (section.permissions) { // Typically for sections like 'special_permissions'
                        for (const permKey in section.permissions) {
                            const permLabel = section.permissions[permKey];
                            const specialPermDiv = createPermissionCheckbox(
                                permKey,
                                permLabel,
                                sectionKey,
                                false, // isPageView
                                null,  // pageViewKey
                                isAdministrateur,
                                currentRolePermissions
                            );
                            sectionDiv.appendChild(specialPermDiv);
                        }
                    }
                    rolePermissionsTreeDiv.appendChild(sectionDiv);
                }

                // --- Updated logic for permission dependencies ---
                const allCheckboxes = rolePermissionsTreeDiv.querySelectorAll('input[type="checkbox"]');

                // Initial state adjustment
                allCheckboxes.forEach(cb => {
                    if (cb.dataset.isFunctional === 'true') {
                        const pageViewKey = cb.dataset.pageViewKey;
                        const sectionKey = cb.dataset.sectionKey;
                        if (pageViewKey) {
                            const pageViewCheckboxId = `role-perm-${sectionKey}-${pageViewKey.replace(/:/g, '-')}`;
                            const pageViewCheckbox = document.getElementById(pageViewCheckboxId);
                            if (pageViewCheckbox && !pageViewCheckbox.checked) {
                                cb.disabled = true;
                            }
                        }
                    }
                });

                // Add event listeners
                allCheckboxes.forEach(cb => {
                    const currentSectionKey = cb.dataset.sectionKey;

                    if (cb.dataset.isFunctional === 'true') { // Functional permission
                        cb.addEventListener('change', function() {
                            if (this.checked) {
                                const pageViewKey = this.dataset.pageViewKey;
                                if (pageViewKey) {
                                    const pageViewCheckboxId = `role-perm-${currentSectionKey}-${pageViewKey.replace(/:/g, '-')}`;
                                    const pageViewCheckbox = document.getElementById(pageViewCheckboxId);
                                    if (pageViewCheckbox && !pageViewCheckbox.disabled) { // Don't auto-check if admin disabled it
                                        pageViewCheckbox.checked = true;
                                        pageViewCheckbox.dispatchEvent(new Event('change'));
                                    }
                                }
                            }
                        });
                    } else if (cb.dataset.isPageView === 'true') { // Page view permission
                        cb.addEventListener('change', function() {
                            const pageViewKeyForThisCb = this.dataset.permString;
                            allCheckboxes.forEach(funcCb => {
                                if (funcCb.dataset.sectionKey === currentSectionKey && 
                                    funcCb.dataset.isFunctional === 'true' &&
                                    funcCb.dataset.pageViewKey === pageViewKeyForThisCb) {
                                    if (!this.checked) { // Page view is unchecked
                                        funcCb.checked = false;
                                        funcCb.disabled = true;
                                    } else { // Page view is checked
                                        funcCb.disabled = false;
                                    }
                                }
                            });
                        });
                    }
                });
            }

            async function saveRolePermissions() {
                const selectedRoleName = roleSelector.value;
                if (selectedRoleName === 'Administrateur') {
                    showRolesConfigFeedback("La modification du rôle Administrateur n'est pas permise via cette interface.", 'warn');
                    return;
                }
                if (!selectedRoleName) {
                    showRolesConfigFeedback("Veuillez sélectionner un rôle à modifier.", 'warn');
                    return;
                }

                const newPermissionsPayload = {};
                const checkboxes = rolePermissionsTreeDiv.querySelectorAll('input[type="checkbox"]');

                checkboxes.forEach(cb => {
                    const permKeyString = cb.dataset.permString;
                    const isChecked = cb.checked;

                    if (permKeyString.includes(':')) {
                        const [mainKey, subKey] = permKeyString.split(':', 2);
                        if (mainKey === "page") {
                            newPermissionsPayload[permKeyString] = isChecked;
                        } else {
                            if (!newPermissionsPayload[mainKey]) {
                                newPermissionsPayload[mainKey] = {};
                            }
                            newPermissionsPayload[mainKey][subKey] = isChecked;
                        }
                    } else {
                        newPermissionsPayload[permKeyString] = isChecked;
                    }
                });

                // console.log("Permissions à sauvegarder pour", selectedRoleName, ":", JSON.stringify(newPermissionsPayload, null, 2));

                try {
                    const response = await fetch(`/api/roles_config/${encodeURIComponent(selectedRoleName)}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(newPermissionsPayload)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    }
                    showRolesConfigFeedback(data.message || "Permissions du rôle sauvegardées avec succès!", 'success');

                    // Mettre à jour rolesConfigData localement et rafraîchir l'affichage
                    if (data.updated_permissions && rolesConfigData.roles[selectedRoleName]) {
                         rolesConfigData.roles[selectedRoleName].permissions = data.updated_permissions;
                         displayRolePermissions(selectedRoleName);
                    }
                } catch (error) {
                    console.error("Erreur sauvegarde permissions rôle:", error);
                    showRolesConfigFeedback(`Erreur sauvegarde: ${error.message}`, 'error');
                }
            }

            // --- Initial Load ---
            loadUsers();
            initializeRolesConfigUI();
        });
    </script>

</body>
</html>