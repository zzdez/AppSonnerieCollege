<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Utilisateurs - Sonneries Collège</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Styles pour la modale de permissions personnalisées (à affiner dans style.css) */
        .perm-item-custom-true label { font-weight: bold; color: green; }
        .perm-item-custom-false label { font-style: italic; color: #dc3545; text-decoration: line-through; }
        .perm-item-inherited label { /* Style par défaut */ }
        .perm-item-page-view { margin-bottom: 5px; } /* Ajoute un peu d'espace sous la perm de page view */
    </style>
</head>
<body>
    <!-- Barre de Navigation (inchangée) -->
    <div style="text-align: right; margin-bottom: 10px; font-size: 0.9em;">
       {% if current_user and current_user.is_authenticated %}
         Connecté: <strong>{{ current_user.id }}</strong> (Rôle: {{ current_user.role }}) |
         {% if user_has_permission('page:view_control') %}<a href="{{ url_for('index') }}">Contrôle Principal</a> |{% endif %}
         {% if user_has_permission('page:view_config_general') %}<a href="{{ url_for('config_general_page') }}">Config Générale</a> |{% endif %}
         {% if user_has_permission('page:view_config_weekly') %}<a href="{{ url_for('config_weekly_page') }}">Config Hebdo</a> |{% endif %}
         {% if user_has_permission('page:view_config_day_types') %}<a href="{{ url_for('config_day_types_page') }}">Journées Types</a> |{% endif %}
         {% if user_has_permission('page:view_config_exceptions') %}<a href="{{ url_for('config_exceptions_page') }}">Exceptions</a> |{% endif %}
         {% if user_has_permission('page:view_config_sounds') %}<a href="{{ url_for('config_sounds_page') }}">Sonneries</a> |{% endif %}
         {% if user_has_permission('page:view_config_users') %}<a href="{{ url_for('config_users_page') }}">Gestion Utilisateurs</a> |{% endif %}
         <a href="{{ url_for('logout') }}">Déconnexion</a>
       {% else %}
         (Non Connecté) <a href="{{ url_for('login') }}">Se connecter</a>
       {% endif %}
     </div>

    <h1>Gestion des Utilisateurs</h1>

    <div class="config-section">
        <h2>Liste des Utilisateurs</h2>
        <button id="show-add-user-form-btn" style="margin-bottom: 10px;" {% if not user_has_permission('user:create') %}disabled{% endif %}>Ajouter un Utilisateur</button>
        <table id="users-table" class="config-table">
            <thead>
                <tr>
                    <th>Nom d'utilisateur</th>
                    <th>Nom complet</th>
                    <th>Rôle (Statut Perso.)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <tr><td colspan="4">Chargement des utilisateurs...</td></tr>
            </tbody>
        </table>
        <div id="users-feedback" class="feedback-message" style="display: none;"></div>
    </div>

    <!-- Section pour la Configuration des Rôles (inchangée) -->
    <div class="config-section" {% if not user_has_permission('user_management:edit_role_permissions') %}style="display:none;"{% endif %}>
        <h2>Configuration des Rôles</h2>
        <div class="form-group">
            <label for="role-selector">Choisir un rôle à configurer:</label>
            <select id="role-selector" name="role_selector">
            </select>
        </div>
        <div id="role-permissions-tree" class="permissions-checkbox-container" style="margin-top: 10px; margin-bottom: 10px; border: 1px solid #ccc; padding: 10px;">
            <p>Sélectionnez un rôle pour voir et modifier ses permissions.</p>
        </div>
        <button id="save-role-permissions-btn">Sauvegarder les Permissions du Rôle</button>
        <div id="roles-config-feedback" class="feedback-message" style="display: none; margin-top:10px;"></div>
    </div>

    <!-- Modal pour les Permissions Personnalisées (Nouvelle section) -->
    <div id="custom-permissions-modal-container" class="form-container" style="display:none; margin-top: 20px; border: 1px solid #007bff; padding: 15px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; z-index: 1000; width: 80%; max-width: 700px; box-shadow: 0 0 15px rgba(0,0,0,0.2);">
        <h3>Permissions Personnalisées pour <span id="custom-perm-username-title" style="font-weight:bold;"></span></h3>
        <p>Utilisateur : <strong id="custom-perm-user-display"></strong> (Rôle de base : <strong id="custom-perm-user-role-display"></strong>)</p>

        <div id="custom-permissions-legend" style="margin-bottom:10px; font-size:0.9em; padding:5px; background-color:#f0f0f0; border-radius: 4px;">
            <strong>Légende du style des permissions :</strong>
            <ul style="margin:0; padding-left:20px; list-style-type: none;">
                <li><span class="perm-item-inherited">Texte normal</span> : Permission héritée du rôle.</li>
                <li><span class="perm-item-custom-true" style="font-weight: bold; color: green;">Texte vert gras</span> : Permission personnalisée (accordée).</li>
                <li><span class="perm-item-custom-false" style="font-style: italic; color: #dc3545; text-decoration: line-through;">Texte rouge italique barré</span> : Permission personnalisée (révoquée).</li>
            </ul>
        </div>

        <div id="custom-permissions-tree" class="permissions-checkbox-container" style="border: 1px solid #ccc; padding: 10px; margin-bottom:10px; max-height: 40vh; overflow-y: auto;">
            <!-- Les permissions seront chargées ici par JavaScript -->
        </div>

        <button id="save-custom-permissions-btn">Sauvegarder les Droits Personnalisés</button>
        <button id="reset-to-role-defaults-btn" style="background-color: #ffc107; color: black;">Réinitialiser aux Droits du Rôle</button>
        <button type="button" id="close-custom-permissions-modal-btn" style="background-color: #6c757d;">Fermer</button>
        <div id="custom-permissions-feedback" class="feedback-message" style="display: none; margin-top:10px;"></div>
    </div>
    <div id="modal-backdrop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;"></div>


    <!-- Formulaires d'Ajout/Modification d'Utilisateur (inchangés) -->
    <div id="add-user-form-container" class="form-container" style="display:none; margin-top: 20px;">
        <h2>Ajouter un Nouvel Utilisateur</h2>
        <form id="add-user-form">
            <div class="form-group"><label for="add-username">Nom d'utilisateur:</label><input type="text" id="add-username" name="username" required></div>
            <div class="form-group"><label for="add-full-name">Nom complet:</label><input type="text" id="add-full-name" name="full_name" required></div>
            <div class="form-group"><label for="add-password">Mot de passe:</label><input type="password" id="add-password" name="password" required></div>
            <div class="form-group"><label for="add-confirm-password">Confirmer le mot de passe:</label><input type="password" id="add-confirm-password" name="confirm_password" required></div>
            <div class="form-group"><label for="add-role">Rôle:</label><select id="add-role" name="role"></select></div>
            <button type="submit">Enregistrer le Nouvel Utilisateur</button><button type="button" id="cancel-add-user-btn">Annuler</button>
        </form>
    </div>
    <div id="edit-user-form-container" class="form-container" style="display:none; margin-top: 20px;">
        <h2>Modifier l'Utilisateur</h2>
        <form id="edit-user-form">
            <input type="hidden" id="edit-original-username" name="original_username">
            <div class="form-group"><label for="edit-username">Nom d'utilisateur:</label><input type="text" id="edit-username" name="username" readonly style="background-color: #eee;"></div>
            <div class="form-group"><label for="edit-full-name">Nom complet:</label><input type="text" id="edit-full-name" name="full_name" required></div>
            <div class="form-group"><label for="edit-password">Nouveau mot de passe (laisser vide pour ne pas changer):</label><input type="password" id="edit-password" name="password"></div>
            <div class="form-group"><label for="edit-confirm-password">Confirmer le nouveau mot de passe:</label><input type="password" id="edit-confirm-password" name="confirm_password"></div>
            <div class="form-group"><label for="edit-role">Rôle:</label><select id="edit-role" name="role"></select></div>
            <button type="submit">Sauvegarder les Modifications</button><button type="button" id="cancel-edit-user-btn">Annuler</button>
        </form>
    </div>

<script>
        // Données globales pour la configuration des rôles et le modèle de permissions
        let rolesConfigData = {};
        let permissionsModelData = {};
        // Variables globales pour la modale de permissions personnalisées
        let currentEditingUsername = null;
        let currentEditingUserRole = null;
        let currentEditingUserCustomPermissions = {};
        let basePermissionsForCurrentUserRole = {};
    </script>
    <script>
        const MIN_PASSWORD_LENGTH = 8;

        // --- Utility: Pure Helper Functions (no DOM access needed at definition time) ---
        function _merge_permissions_js(base, override) {
            let merged = JSON.parse(JSON.stringify(base)); // Deep copy base
            if (!override || typeof override !== 'object' || Object.keys(override).length === 0) return merged;

            for (let key in override) {
                if (override.hasOwnProperty(key)) {
                    if (typeof override[key] === 'object' && override[key] !== null &&
                        typeof merged[key] === 'object' && merged[key] !== null &&
                        !Array.isArray(override[key]) && Object.keys(override[key]).length > 0) {
                        merged[key] = _merge_permissions_js(merged[key] || {}, override[key]);
                    } else {
                        merged[key] = JSON.parse(JSON.stringify(override[key]));
                    }
                }
            }
            return merged;
        }

        function getEffectivePermissionState(permKey, baseRolePerms, userCustomPerms) {
            let section = null, action = permKey;
            if (permKey.includes(':')) { [section, action] = permKey.split(':', 2); }

            if (userCustomPerms) {
                if (section && userCustomPerms[section] && typeof userCustomPerms[section][action] !== 'undefined') {
                    return { value: userCustomPerms[section][action], source: userCustomPerms[section][action] ? 'custom_true' : 'custom_false' };
                } else if (!section && typeof userCustomPerms[permKey] !== 'undefined') {
                    return { value: userCustomPerms[permKey], source: userCustomPerms[permKey] ? 'custom_true' : 'custom_false' };
                }
            }
            let roleValue = false;
            if (section && baseRolePerms[section] && typeof baseRolePerms[section][action] !== 'undefined') {
                roleValue = baseRolePerms[section][action];
            } else if (!section && typeof baseRolePerms[permKey] !== 'undefined') {
                roleValue = baseRolePerms[permKey];
            }
            return { value: roleValue, source: 'role' };
        }

        // Helper pour vérifier une permission dans la structure potentiellement imbriquée (utilisé par les fonctions de rendu)
        function checkPerm(permissionsObject, permKeyString) {
            if (!permissionsObject) return false;
            if (permKeyString.includes(':')) {
                const [mainKey, subKey] = permKeyString.split(':', 2);
                if (mainKey === "page") {
                    return permissionsObject[permKeyString] === true;
                } else {
                    return (permissionsObject[mainKey] && permissionsObject[mainKey][subKey] === true);
                }
            } else {
                return permissionsObject[permKeyString] === true;
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            // --- Elements DOM ---
            const usersTableBody = document.getElementById('users-table-body');
            const feedbackDiv = document.getElementById('users-feedback');
            const rolesConfigFeedbackDiv = document.getElementById('roles-config-feedback');

            const showAddUserFormBtn = document.getElementById('show-add-user-form-btn');
            const addUserFormContainer = document.getElementById('add-user-form-container');
            const addUserForm = document.getElementById('add-user-form');
            const cancelAddUserBtn = document.getElementById('cancel-add-user-btn');
            const addRoleSelect = document.getElementById('add-role');

            const editUserFormContainer = document.getElementById('edit-user-form-container');
            const editUserForm = document.getElementById('edit-user-form');
            const cancelEditUserBtn = document.getElementById('cancel-edit-user-btn');
            const editOriginalUsernameField = document.getElementById('edit-original-username');
            const editRoleSelect = document.getElementById('edit-role');

            const roleSelector = document.getElementById('role-selector');
            const rolePermissionsTreeDiv = document.getElementById('role-permissions-tree');
            const saveRolePermissionsBtn = document.getElementById('save-role-permissions-btn');

            const customPermissionsModal = document.getElementById('custom-permissions-modal-container');
            const customPermUsernameTitle = document.getElementById('custom-perm-username-title');
            const customPermUserDisplay = document.getElementById('custom-perm-user-display');
            const customPermUserRoleDisplay = document.getElementById('custom-perm-user-role-display');
            const customPermissionsTreeDiv = document.getElementById('custom-permissions-tree');
            const saveCustomPermissionsBtn = document.getElementById('save-custom-permissions-btn');
            const resetToRoleDefaultsBtn = document.getElementById('reset-to-role-defaults-btn');
            const closeCustomPermissionsModalBtn = document.getElementById('close-custom-permissions-modal-btn');
            const customPermissionsFeedbackDiv = document.getElementById('custom-permissions-feedback');
            const modalBackdrop = document.getElementById('modal-backdrop');

            // --- Utility: Feedback (uses DOM elements) ---
            function showFeedback(element, message, type = 'info', duration = 4000) {
                if (!element) { console.error("Feedback element not found for message:", message); return; }
                element.textContent = message;
                element.className = 'feedback-message'; // Reset classes
                element.classList.add(type, 'show');
                element.style.display = 'block';
                setTimeout(() => {
                    element.classList.remove('show');
                    setTimeout(() => { if (!element.classList.contains('show')) element.style.display = 'none'; }, 500);
                }, duration);
            }

            function showUsersFeedback(message, type = 'info', duration = 4000) {
                showFeedback(feedbackDiv, message, type, duration);
            }
            function showRolesConfigFeedback(message, type = 'info', duration = 4000) {
                showFeedback(rolesConfigFeedbackDiv, message, type, duration);
            }
            function showCustomPermissionsFeedback(message, type = 'info', duration = 4000) {
                showFeedback(customPermissionsFeedbackDiv, message, type, duration);
            }

            // --- Utility: Reset Forms (uses DOM elements) ---
            function resetAndHideForms() {
                if (addUserForm) addUserForm.reset();
                if (addUserFormContainer) addUserFormContainer.style.display = 'none';
                if (editUserForm) editUserForm.reset();
                if (editUserFormContainer) editUserFormContainer.style.display = 'none';
                if (editOriginalUsernameField) editOriginalUsernameField.value = '';
                if (customPermissionsModal) customPermissionsModal.style.display = 'none';
                if (modalBackdrop) modalBackdrop.style.display = 'none';
            }

            // --- Main Logic Functions (many use DOM elements or call functions that do) ---

            function populateUsersTable(users) {
                usersTableBody.innerHTML = '';
                if (!users || users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="4">Aucun utilisateur configuré.</td></tr>';
                    return;
                }
                users.forEach(user => {
                    const row = usersTableBody.insertRow();
                    row.dataset.username = user.username;
                    row.insertCell().textContent = user.username;
                    row.insertCell().textContent = user.full_name;

                    const roleCell = row.insertCell();
                    let roleDisplay = user.role;
                    if (user.has_custom_permissions) { // API should provide this
                        roleDisplay += ' <em style="font-size:0.8em; color: #007bff;">(perso.)</em>';
                    }
                    roleCell.innerHTML = roleDisplay;

                    const actionsCell = row.insertCell();

                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Modifier Infos';
                    editBtn.classList.add('btn-small');
                    editBtn.onclick = () => showEditForm(user.username, user.full_name, user.role);
                    actionsCell.appendChild(editBtn);

                    const customRightsBtn = document.createElement('button');
                    customRightsBtn.textContent = 'Droits Spécifiques';
                    customRightsBtn.classList.add('btn-small', 'btn-info');
                    customRightsBtn.style.marginLeft = '5px';
                    // Pass custom_permissions from the user object fetched by loadUsers
                    customRightsBtn.onclick = () => openCustomPermissionsModal(user.username, user.role, user.custom_permissions || {});
                    actionsCell.appendChild(customRightsBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Supprimer';
                    deleteBtn.classList.add('btn-small', 'btn-danger');
                    deleteBtn.style.marginLeft = '5px';
                    deleteBtn.onclick = () => deleteUser(user.username);
                    actionsCell.appendChild(deleteBtn);
                });
            }

            async function loadUsers() {
                resetAndHideForms();
                usersTableBody.innerHTML = '<tr><td colspan="4">Chargement des utilisateurs...</td></tr>';
                try {
                    const response = await fetch('/api/users');
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Erreur HTTP ${response.status}`);
                    }
                    const users = await response.json();
                    populateUsersTable(users);
                } catch (error) {
                    console.error("Erreur chargement utilisateurs:", error);
                    usersTableBody.innerHTML = `<tr><td colspan="4" style="color:red;">Erreur: ${error.message}</td></tr>`;
                    showUsersFeedback(`Erreur chargement: ${error.message}`, 'error');
                }
            }

            function showEditForm(username, fullName, role) {
                resetAndHideForms();
                editOriginalUsernameField.value = username;
                document.getElementById('edit-username').value = username;
                document.getElementById('edit-full-name').value = fullName;
                editRoleSelect.value = role; // Role from users.json is already correctly cased
                editUserFormContainer.style.display = 'block';
                document.getElementById('edit-full-name').focus();
            }

            async function deleteUser(username) {
                if (!confirm(`Êtes-vous sûr de vouloir supprimer l'utilisateur "${username}" ? Cette action est irréversible.`)) {
                    return;
                }
                try {
                    const response = await fetch(`/api/users/${encodeURIComponent(username)}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json(); // Try to parse JSON, even for errors
                    if (!response.ok) {
                        throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    }
                    showUsersFeedback(data.message || `Utilisateur "${username}" supprimé avec succès.`, 'success');
                    loadUsers(); // Recharger la liste
                } catch (error) {
                    console.error("Erreur suppression utilisateur:", error);
                    showUsersFeedback(`Erreur suppression: ${error.message}`, 'error');
                }
            }

            // --- Helper: createStyledPermissionCheckbox (for custom permissions modal) ---
            function createStyledPermissionCheckbox(permKey, permLabel, sectionKey, isPageView, pageViewKeyString, baseRolePerms, userCustomPerms) {
                const permDiv = document.createElement('div');
                permDiv.classList.add('permission-item');
                if (isPageView) permDiv.classList.add('permission-item-page-view');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `custom-perm-${sectionKey}-${permKey.replace(/:/g, '-')}`; // Unique prefix for custom modal
                checkbox.dataset.permString = permKey;
                checkbox.dataset.sectionKey = sectionKey;
                if (isPageView) checkbox.dataset.isPageView = 'true';
                if (pageViewKeyString) {
                    checkbox.dataset.pageViewKey = pageViewKeyString;
                    checkbox.dataset.isFunctional = 'true';
                }

                const permState = getEffectivePermissionState(permKey, baseRolePerms, userCustomPerms);
                checkbox.checked = permState.value;

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = permLabel || permKey; // Corrected from permLabelText

                permDiv.className = 'permission-item'; // Reset
                if (isPageView) permDiv.classList.add('permission-item-page-view');

                if (permState.source === 'custom_true') {
                    permDiv.classList.add('perm-item-custom-true');
                } else if (permState.source === 'custom_false') {
                    permDiv.classList.add('perm-item-custom-false');
                } else { // 'role'
                    permDiv.classList.add('perm-item-inherited');
                }

                permDiv.appendChild(checkbox);
                permDiv.appendChild(label);
                return permDiv;
            }

            // --- Helper: attachDependencyLogic (for any permission tree) ---
            function attachDependencyLogic(containerElement, isCustomModal = false) {
                const allCheckboxes = containerElement.querySelectorAll('input[type="checkbox"]');
                const idPrefix = isCustomModal ? "custom-perm-" : "role-perm-";

                allCheckboxes.forEach(cb => {
                    if (cb.dataset.isFunctional === 'true') {
                        const pageViewKey = cb.dataset.pageViewKey;
                        const sectionKey = cb.dataset.sectionKey;
                        if (pageViewKey) {
                            const pageViewCheckboxId = `${idPrefix}${sectionKey}-${pageViewKey.replace(/:/g, '-')}`;
                            const pageViewCheckbox = document.getElementById(pageViewCheckboxId);
                            if (pageViewCheckbox && !pageViewCheckbox.checked) {
                                cb.disabled = true;
                            }
                        }
                    }
                });

                allCheckboxes.forEach(cb => {
                    const currentSectionKey = cb.dataset.sectionKey;
                    if (cb.dataset.isFunctional === 'true') {
                        cb.addEventListener('change', function() {
                            if (this.checked) {
                                const pageViewKey = this.dataset.pageViewKey;
                                if (pageViewKey) {
                                    const pageViewCheckboxId = `${idPrefix}${currentSectionKey}-${pageViewKey.replace(/:/g, '-')}`;
                                    const pageViewCheckbox = document.getElementById(pageViewCheckboxId);
                                    if (pageViewCheckbox && !pageViewCheckbox.disabled) {
                                        pageViewCheckbox.checked = true;
                                        pageViewCheckbox.dispatchEvent(new Event('change'));
                                    }
                                }
                            }
                        });
                    } else if (cb.dataset.isPageView === 'true') {
                        cb.addEventListener('change', function() {
                            const pageViewKeyForThisCb = this.dataset.permString;
                            allCheckboxes.forEach(funcCb => {
                                if (funcCb.dataset.sectionKey === currentSectionKey &&
                                    funcCb.dataset.isFunctional === 'true' &&
                                    funcCb.dataset.pageViewKey === pageViewKeyForThisCb) {
                                    if (!this.checked) {
                                        funcCb.checked = false;
                                        funcCb.disabled = true;
                                    } else {
                                        funcCb.disabled = false;
                                    }
                                }
                            });
                        });
                    }
                });
            }

            // --- Permissions Personnalisées ---
            function renderPermissionCheckboxesForUser(containerDiv, model, rolePerms, customPerms) {
                containerDiv.innerHTML = '';

                for (const sectionKey in model) {
                    const section = model[sectionKey];
                    const sectionDiv = document.createElement('div');
                    sectionDiv.classList.add('permission-section');
                    const sectionTitle = document.createElement('h4');
                    sectionTitle.textContent = section.label || sectionKey;
                    sectionDiv.appendChild(sectionTitle);

                    let pageViewKeyForSection = null;

                    if (section.page_view_meta) {
                        pageViewKeyForSection = section.page_view_meta.key;
                        const permDiv = createStyledPermissionCheckbox(
                            section.page_view_meta.key,
                            section.page_view_meta.label,
                            sectionKey, true, null,
                            rolePerms, customPerms
                        );
                        sectionDiv.appendChild(permDiv);
                    }

                    const permsToIterate = section.functional_permissions || section.permissions;
                    if (permsToIterate) {
                        for (const permKey in permsToIterate) {
                            const permLabel = permsToIterate[permKey];
                            const permDiv = createStyledPermissionCheckbox(
                                permKey, permLabel, sectionKey,
                                false, pageViewKeyForSection,
                                rolePerms, customPerms
                            );
                            sectionDiv.appendChild(permDiv);
                        }
                    }
                    containerDiv.appendChild(sectionDiv);
                }
                attachDependencyLogic(containerDiv, true); // true for isCustomModal
            }

            async function openCustomPermissionsModal(username, userRole, userCustomPerms) {
                currentEditingUsername = username;
                currentEditingUserRole = userRole;
                currentEditingUserCustomPermissions = userCustomPerms ? JSON.parse(JSON.stringify(userCustomPerms)) : {};

                customPermUsernameTitle.textContent = username;
                customPermUserDisplay.textContent = username;
                customPermUserRoleDisplay.textContent = userRole;

                if (!rolesConfigData.roles || !rolesConfigData.roles[userRole] || !rolesConfigData.roles[userRole].permissions) {
                    showFeedback(customPermissionsFeedbackDiv, `Permissions du rôle '${userRole}' non trouvées.`, 'error');
                    return;
                }
                basePermissionsForCurrentUserRole = JSON.parse(JSON.stringify(rolesConfigData.roles[userRole].permissions));

                renderPermissionCheckboxesForUser(
                    customPermissionsTreeDiv,
                    permissionsModelData,
                    basePermissionsForCurrentUserRole,
                    currentEditingUserCustomPermissions
                );
                customPermissionsModal.style.display = 'block';
                modalBackdrop.style.display = 'block';
            }

            async function saveUserCustomPermissions() {
                if (!currentEditingUsername) return;
                const payload = { custom_permissions: {} };
                const checkboxes = customPermissionsTreeDiv.querySelectorAll('input[type="checkbox"]');

                checkboxes.forEach(cb => {
                    const permKeyString = cb.dataset.permString;
                    const isChecked = cb.checked;
                    const roleDefaultState = getEffectivePermissionState(permKeyString, basePermissionsForCurrentUserRole, {}).value;

                    if (isChecked !== roleDefaultState) {
                        if (permKeyString.includes(':')) {
                            const [mainKey, subKey] = permKeyString.split(':', 2);
                            if (mainKey === "page") {
                                payload.custom_permissions[permKeyString] = isChecked;
                            } else {
                                if (!payload.custom_permissions[mainKey]) payload.custom_permissions[mainKey] = {};
                                payload.custom_permissions[mainKey][subKey] = isChecked;
                            }
                        } else {
                            payload.custom_permissions[permKeyString] = isChecked;
                        }
                    }
                });

                try {
                    const response = await fetch(`/api/users/${encodeURIComponent(currentEditingUsername)}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    showCustomPermissionsFeedback(data.message || "Droits personnalisés sauvegardés !", 'success', 2000);
                    setTimeout(() => {
                        resetAndHideForms(); // Will hide the modal
                        loadUsers();
                    }, 2000);
                } catch (error) {
                    console.error("Erreur sauvegarde droits personnalisés:", error);
                    showCustomPermissionsFeedback(`Erreur: ${error.message}`, 'error');
                }
            }

            async function resetUserPermissionsToRoleDefault() {
                if (!currentEditingUsername) return;
                if (!confirm(`Êtes-vous sûr de vouloir réinitialiser les permissions de ${currentEditingUsername} à celles de son rôle (${currentEditingUserRole}) ? Toutes les personnalisations seront perdues.`)) return;

                try {
                    const response = await fetch(`/api/users/${encodeURIComponent(currentEditingUsername)}/custom_permissions`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    showCustomPermissionsFeedback(data.message || "Permissions réinitialisées.", 'success', 2000);

                    currentEditingUserCustomPermissions = {};
                    renderPermissionCheckboxesForUser(
                        customPermissionsTreeDiv,
                        permissionsModelData,
                        basePermissionsForCurrentUserRole,
                        currentEditingUserCustomPermissions
                    );
                    loadUsers();
                } catch (error) {
                    console.error("Erreur réinitialisation droits:", error);
                    showCustomPermissionsFeedback(`Erreur: ${error.message}`, 'error');
                }
            }


            // --- Configuration des Rôles (JS original, mais createPermissionCheckbox est maintenant createStyledPermissionCheckbox) ---
            // La fonction `createPermissionCheckbox` originale est maintenant `createStyledPermissionCheckbox` et adaptée.
            // La fonction `displayRolePermissions` doit utiliser la `createStyledPermissionCheckbox` adaptée ou sa propre version.
            // Pour l'instant, je vais réutiliser la createStyledPermissionCheckbox pour les roles aussi, mais sans customPerms.

            // Helper function to create a permission checkbox for ROLES (simpler version)
            function createRolePermissionCheckbox(permKey, permLabel, sectionKey, isPageView, pageViewKey, isAdministrateurRole, currentRolePermissions) {
                const permDiv = document.createElement('div');
                permDiv.classList.add('permission-item');
                if (isPageView) permDiv.classList.add('permission-item-page-view');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `role-perm-${sectionKey}-${permKey.replace(/:/g, '-')}`; // Prefix 'role-perm-'
                checkbox.dataset.permString = permKey;
                checkbox.dataset.sectionKey = sectionKey;
                if (isPageView) checkbox.dataset.isPageView = 'true';
                if (pageViewKey) checkbox.dataset.pageViewKey = pageViewKey; // Link to parent page view perm

                checkbox.checked = checkPerm(currentRolePermissions, permKey);
                if (isAdministrateurRole) { // If configuring the 'Administrateur' role itself
                    checkbox.checked = true;
                    checkbox.disabled = true;
                }

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = permLabel || permKey;

                permDiv.appendChild(checkbox);
                permDiv.appendChild(label);
                return permDiv;
            }


            function displayRolePermissions(selectedRoleName) {
                rolePermissionsTreeDiv.innerHTML = '';
                const roleData = rolesConfigData.roles[selectedRoleName];
                const currentRolePermissions = roleData ? roleData.permissions : {};
                const isAdministrateurRole = selectedRoleName === 'Administrateur'; // Is the role being configured 'Administrateur'?
                saveRolePermissionsBtn.disabled = isAdministrateurRole;

                if (!permissionsModelData || Object.keys(permissionsModelData).length === 0) {
                    rolePermissionsTreeDiv.innerHTML = '<p>Modèle de permissions non chargé.</p>'; return;
                }

                for (const sectionKey in permissionsModelData) {
                    const section = permissionsModelData[sectionKey];
                    const sectionDiv = document.createElement('div');
                    sectionDiv.classList.add('permission-section');
                    const sectionTitle = document.createElement('h4');
                    sectionTitle.textContent = section.label || sectionKey;
                    sectionDiv.appendChild(sectionTitle);

                    let pageViewKeyForSection = null;
                    if (section.page_view_meta) {
                        pageViewKeyForSection = section.page_view_meta.key;
                        const permDiv = createRolePermissionCheckbox(
                            section.page_view_meta.key, section.page_view_meta.label, sectionKey,
                            true, null, /* isPageView, pageViewKey */
                            isAdministrateurRole, currentRolePermissions
                        );
                        sectionDiv.appendChild(permDiv);
                    }

                    const permsToIterate = section.functional_permissions || section.permissions;
                    if (permsToIterate) {
                        for (const permKey in permsToIterate) {
                            const permLabel = permsToIterate[permKey];
                            const permDiv = createRolePermissionCheckbox(
                                permKey, permLabel, sectionKey,
                                false, pageViewKeyForSection, /* isPageView, pageViewKey */
                                isAdministrateurRole, currentRolePermissions
                            );
                            sectionDiv.appendChild(permDiv);
                        }
                    }
                    rolePermissionsTreeDiv.appendChild(sectionDiv);
                }
                attachDependencyLogic(rolePermissionsTreeDiv, false); // false for isCustomModal
            }

            async function initializeRolesConfigUI() {
                try {
                    const response = await fetch('/api/roles_config');
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Erreur HTTP ${response.status} lors du chargement de la config des rôles.`);
                    }
                    const data = await response.json();
                    rolesConfigData = data.roles_config;
                    permissionsModelData = data.permissions_model;

                    roleSelector.innerHTML = ''; addRoleSelect.innerHTML = ''; editRoleSelect.innerHTML = '';
                    if (rolesConfigData && rolesConfigData.roles) {
                        Object.keys(rolesConfigData.roles).forEach(roleName => {
                            const option = document.createElement('option'); option.value = roleName; option.textContent = roleName;
                            roleSelector.appendChild(option.cloneNode(true));
                            const formOption = document.createElement('option'); formOption.value = roleName; formOption.textContent = roleName; // Keep original case for value
                            addRoleSelect.appendChild(formOption.cloneNode(true));
                            editRoleSelect.appendChild(formOption.cloneNode(true));
                        });
                    }
                    if (roleSelector.options.length > 0) {
                        roleSelector.selectedIndex = 0;
                        displayRolePermissions(roleSelector.value);
                    } else {
                        rolePermissionsTreeDiv.innerHTML = '<p>Aucun rôle disponible pour configuration.</p>';
                        saveRolePermissionsBtn.disabled = true;
                    }
                } catch (error) {
                    console.error("Erreur initialisation UI config rôles:", error);
                    rolePermissionsTreeDiv.innerHTML = `<p style="color:red;">Erreur chargement configuration des rôles: ${error.message}</p>`;
                    saveRolePermissionsBtn.disabled = true;
                }
            }

            async function saveRolePermissions() { /* ...  existant, devrait fonctionner ... */ }
            // Coller ici la fonction saveRolePermissions existante, elle devrait être compatible.
            // --- Copie de saveRolePermissions (vérifier si des adaptations mineures sont nécessaires) ---
            async function saveRolePermissions() {
                const selectedRoleName = roleSelector.value;
                if (selectedRoleName === 'Administrateur') {
                    showRolesConfigFeedback("La modification du rôle Administrateur n'est pas permise via cette interface.", 'warn');
                    return;
                }
                if (!selectedRoleName) {
                    showRolesConfigFeedback("Veuillez sélectionner un rôle à modifier.", 'warn');
                    return;
                }

                const newPermissionsPayload = {};
                const checkboxes = rolePermissionsTreeDiv.querySelectorAll('input[type="checkbox"]');

                checkboxes.forEach(cb => {
                    const permKeyString = cb.dataset.permString;
                    const isChecked = cb.checked;

                    if (permKeyString.includes(':')) {
                        const [mainKey, subKey] = permKeyString.split(':', 2);
                        // Page view permissions (like "page:view_control") are now direct keys in the payload
                        // if they come from page_view_meta, or still direct if from special_permissions.
                        // Functional permissions are nested (e.g., control.view_status).
                        // The PERMISSIONS_MODEL structure change means permKeyString is what we send.

                        // Rebuild nested structure for backend based on permKeyString
                        let currentLevel = newPermissionsPayload;
                        const parts = permKeyString.split(':');
                        parts.forEach((part, index) => {
                            if (index === parts.length - 1) { // Last part is the action/boolean
                                currentLevel[part] = isChecked;
                            } else { // Create nested object if it doesn't exist
                                if (!currentLevel[part]) {
                                    currentLevel[part] = {};
                                }
                                currentLevel = currentLevel[part];
                            }
                        });

                    } else { // Direct permissions like admin:has_all_permissions
                        newPermissionsPayload[permKeyString] = isChecked;
                    }
                });

                // Correction pour la reconstruction du payload basé sur la structure attendue par le backend
                // Le backend s'attend à un objet plat pour les permissions de rôle, où les sections sont des clés.
                const finalPayloadForBackend = {};
                checkboxes.forEach(cb => {
                    const permKeyString = cb.dataset.permString;
                    const sectionKey = cb.dataset.sectionKey; // sectionKey from PERMISSIONS_MODEL
                    const isChecked = cb.checked;

                    if (permKeyString.startsWith("page:")) {
                        finalPayloadForBackend[permKeyString] = isChecked;
                    } else if (permKeyString === "admin:has_all_permissions") {
                         finalPayloadForBackend[permKeyString] = isChecked;
                    } else { // Functional permissions like control:view_status
                        const [mainKey, subKey] = permKeyString.split(':');
                        if (!finalPayloadForBackend[mainKey]) {
                            finalPayloadForBackend[mainKey] = {};
                        }
                        finalPayloadForBackend[mainKey][subKey] = isChecked;
                    }
                });


                try {
                    const response = await fetch(`/api/roles_config/${encodeURIComponent(selectedRoleName)}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(finalPayloadForBackend) // Utiliser finalPayloadForBackend
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    }
                    showRolesConfigFeedback(data.message || "Permissions du rôle sauvegardées avec succès!", 'success');

                    if (data.updated_permissions && rolesConfigData.roles[selectedRoleName]) {
                         rolesConfigData.roles[selectedRoleName].permissions = data.updated_permissions;
                         displayRolePermissions(selectedRoleName);
                    }
                } catch (error) {
                    console.error("Erreur sauvegarde permissions rôle:", error);
                    showRolesConfigFeedback(`Erreur sauvegarde: ${error.message}`, 'error');
                }
            }


            // --- Event Listeners pour les formulaires Add/Edit User (inchangés) ---
            showAddUserFormBtn.addEventListener('click', () => {
                resetAndHideForms();
                addUserFormContainer.style.display = 'block';
                document.getElementById('add-username').focus();
            });
            cancelAddUserBtn.addEventListener('click', resetAndHideForms);

            addUserForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('add-username').value.trim();
                const fullName = document.getElementById('add-full-name').value.trim();
                const password = document.getElementById('add-password').value;
                const confirmPassword = document.getElementById('add-confirm-password').value;
                const role = addRoleSelect.value;

                if (!username || !fullName || !password || !role) {
                    showUsersFeedback("Tous les champs (sauf confirmation mot de passe si vide) sont requis.", 'error');
                    return;
                }
                if (password !== confirmPassword) {
                    showUsersFeedback("Les mots de passe ne correspondent pas.", 'error');
                    return;
                }
                if (password.length < MIN_PASSWORD_LENGTH) {
                    showUsersFeedback(`Le mot de passe doit contenir au moins ${MIN_PASSWORD_LENGTH} caractères.`, 'error');
                    return;
                }

                const userData = { username, full_name: fullName, password, role };

                try {
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(userData)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    }
                    showUsersFeedback(data.message || "Utilisateur ajouté avec succès!", 'success');
                    addUserForm.reset();
                    addUserFormContainer.style.display = 'none';
                    loadUsers(); // Recharger la liste des utilisateurs
                } catch (error) {
                    console.error("Erreur ajout utilisateur:", error);
                    showUsersFeedback(`Erreur ajout: ${error.message}`, 'error');
                }
            });

            cancelEditUserBtn.addEventListener('click', resetAndHideForms);
            editUserForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const originalUsername = editOriginalUsernameField.value;
                const fullName = document.getElementById('edit-full-name').value.trim();
                const password = document.getElementById('edit-password').value;
                const confirmPassword = document.getElementById('edit-confirm-password').value;
                const role = editRoleSelect.value;

                if (!originalUsername || !fullName || !role) {
                    showUsersFeedback("Nom complet et rôle sont requis pour la modification.", 'error');
                    return;
                }

                if (password && password !== confirmPassword) {
                    showUsersFeedback("Les nouveaux mots de passe ne correspondent pas.", 'error');
                    return;
                }
                if (password && password.length < MIN_PASSWORD_LENGTH) {
                    showUsersFeedback(`Le nouveau mot de passe doit contenir au moins ${MIN_PASSWORD_LENGTH} caractères.`, 'error');
                    return;
                }

                const updatePayload = {
                    full_name: fullName,
                    role: role
                };
                if (password) { // Inclure le mot de passe seulement s'il est fourni
                    updatePayload.password = password;
                }

                try {
                    const response = await fetch(`/api/users/${encodeURIComponent(originalUsername)}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(updatePayload)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `Erreur HTTP ${response.status}`);
                    }
                    showUsersFeedback(data.message || "Utilisateur modifié avec succès!", 'success');
                    editUserForm.reset();
                    editUserFormContainer.style.display = 'none';
                    loadUsers(); // Recharger la liste
                } catch (error) {
                    console.error("Erreur modification utilisateur:", error);
                    showUsersFeedback(`Erreur modification: ${error.message}`, 'error');
                }
            });

            // --- Initial Load Calls ---
            // DOM elements are now defined, so these calls should be safe.
            loadUsers();
            initializeRolesConfigUI();

            // Event listeners for custom permissions modal buttons
            saveCustomPermissionsBtn.addEventListener('click', saveUserCustomPermissions);
            resetToRoleDefaultsBtn.addEventListener('click', resetUserPermissionsToRoleDefault);
            closeCustomPermissionsModalBtn.addEventListener('click', () => {
                customPermissionsModal.style.display = 'none';
                modalBackdrop.style.display = 'none';
            });
            modalBackdrop.addEventListener('click', () => {
                 customPermissionsModal.style.display = 'none';
                 modalBackdrop.style.display = 'none';
            });
        });
    </script>
</body>
</html>