<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configuration G√©n√©rale - Sonneries Coll√®ge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>
<body>
    <!-- LIEN DECONNEXION ET NAVIGATION -->
    <div style="text-align: right; margin-bottom: 10px; font-size: 0.9em;">
       {% if current_user and current_user.is_authenticated %}
         Connect√©: <strong>{{ current_user.id }}</strong> |
         {% if user_has_permission('page:view_control') %}<a href="{{ url_for('index') }}">Contr√¥le Principal</a> |{% endif %}
         {% if user_has_permission('page:view_config_general') %}<a href="{{ url_for('config_general_page') }}">Config G√©n√©rale</a> |{% endif %}
         {% if user_has_permission('page:view_config_weekly') %}<a href="{{ url_for('config_weekly_page') }}">Config Hebdo</a> |{% endif %}
         {% if user_has_permission('page:view_config_day_types') %}<a href="{{ url_for('config_day_types_page') }}">Journ√©es Types</a> |{% endif %}
         {% if user_has_permission('page:view_config_exceptions') %}<a href="{{ url_for('config_exceptions_page') }}">Exceptions</a> |{% endif %}
         {% if user_has_permission('page:view_config_sounds') %}<a href="{{ url_for('config_sounds_page') }}">Sonneries</a> |{% endif %}
         {% if user_has_permission('page:view_config_users') %}<a href="{{ url_for('config_users_page') }}">Gestion Utilisateurs</a> |{% endif %}
         <a href="{{ url_for('logout') }}">D√©connexion</a>
       {% else %}
         (Non Connect√©) <a href="{{ url_for('login') }}">Se connecter</a>
       {% endif %}
     </div>
    <!-- FIN LIEN DECONNEXION ET NAVIGATION -->

    {% if user_has_permission('page:view_config_general') %}
    <div class="config-page-container">

    <h1>Configuration G√©n√©rale et Alertes</h1>

    <div class="config-section">
        <h2>Param√®tres des Vacances et Jours F√©ri√©s</h2>
        <div class="form-group">
            <label for="departement">D√©partement :</label>
            <select id="departement" name="departement" onchange="updateZoneDisplay()" {% if not user_has_permission('config_general:edit_settings') %}disabled{% endif %}></select>
        </div>
        <div class="form-group">
            <label for="zone">Zone Acad√©mique :</label>
            <input type="text" id="zone" name="zone" readonly {% if not user_has_permission('config_general:edit_settings') %}disabled{% endif %}> {# Readonly est d√©j√† l√†, mais disabled assure la non-soumission #}
        </div>
        <div class="form-group">
            <label for="vacances_ics_url">URL ICS Manuelle pour Vacances (Optionnel) :</label>
            <input type="url" id="vacances_ics_url" name="vacances_ics_url" placeholder="Laissez vide pour utiliser l'URL par d√©faut (via zone)" {% if not user_has_permission('config_general:edit_settings') %}disabled{% endif %}>
            <p class="help-text">Si renseign√©e, cette URL sera prioritaire sur le t√©l√©chargement automatique par zone.</p>
        </div>
    </div>

    <div class="config-section">
        <h2>Configuration des Sonneries d'Alerte</h2>
        <div class="form-group">
            <label for="sonnerie_ppms">Sonnerie PPMS :</label>
            <div class="sound-control-group">
                <select id="sonnerie_ppms" name="sonnerie_ppms" onchange="onSelectChange('sonnerie_ppms')" {% if not user_has_permission('config_general:edit_alert_sounds') %}disabled{% endif %}></select>
                <button type="button" onclick="previewSound('sonnerie_ppms')" title="√âcouter la sonnerie s√©lectionn√©e" {% if not user_has_permission('sound:preview') %}disabled{% endif %}>üîä √âcouter</button>
            </div>
        </div>

        <div class="form-group">
            <label for="sonnerie_attentat">Sonnerie Attentat :</label>
            <div class="sound-control-group">
                <select id="sonnerie_attentat" name="sonnerie_attentat" onchange="onSelectChange('sonnerie_attentat')" {% if not user_has_permission('config_general:edit_alert_sounds') %}disabled{% endif %}></select>
                <button type="button" onclick="previewSound('sonnerie_attentat')" title="√âcouter la sonnerie s√©lectionn√©e" {% if not user_has_permission('sound:preview') %}disabled{% endif %}>üîä √âcouter</button>
            </div>
        </div>

        <div class="form-group">
            <label for="sonnerie_fin_alerte">Sonnerie Fin d'Alerte :</label>
            <div class="sound-control-group">
                <select id="sonnerie_fin_alerte" name="sonnerie_fin_alerte" onchange="onSelectChange('sonnerie_fin_alerte')" {% if not user_has_permission('config_general:edit_alert_sounds') %}disabled{% endif %}></select>
                <button type="button" onclick="previewSound('sonnerie_fin_alerte')" title="√âcouter la sonnerie s√©lectionn√©e" {% if not user_has_permission('sound:preview') %}disabled{% endif %}>üîä √âcouter</button>
            </div>
        </div>
    </div>

    <div class="config-section">
        <h2>Configuration du P√©riph√©rique Audio de Sortie</h2>
        <div class="form-group">
            <label for="audio_device_select">P√©riph√©rique Audio pour les Sonneries :</label>
            <select id="audio_device_select" name="audio_device_select" {% if not user_has_permission('config_general:edit_settings') %}disabled{% endif %}>
                <!-- Les options seront peupl√©es par JavaScript -->
            </select>
            <p class="help-text">S√©lectionnez le p√©riph√©rique audio sur lequel les sonneries et alertes doivent √™tre jou√©es.
                                 Laissez sur "P√©riph√©rique par d√©faut syst√®me" pour utiliser le r√©glage par d√©faut de Windows.</p>
        </div>
    </div>

    <button class="config-page-save-button" onclick="saveConfig()" {% if not (user_has_permission('config_general:edit_settings') or user_has_permission('config_general:edit_alert_sounds')) %}disabled{% endif %}>Enregistrer les Modifications</button>
    <div id="config-feedback" class="feedback-message" style="display: none;"></div>

    </div> <!-- Fin de config-page-container -->
    {% else %}
    <div class="config-page-container">
        <h1>Acc√®s Refus√©</h1>
        <p>Vous n'avez pas la permission n√©cessaire pour voir cette page.</p>
        <p><a href="{{ url_for('index') }}">Retour √† la page d'accueil</a></p>
    </div>
    {% endif %}
</body>
</html>

<script>
    // --------------------------------------------------
    // 1. Variables Globales pour la page
    // --------------------------------------------------
    const canPreviewSound = {{ user_has_permission('sound:preview') | tojson }};
    let departementsData = {{ constants.DEPARTEMENTS_ZONES | tojson }};
    let listeDepartementsSorted = {{ constants.LISTE_DEPARTEMENTS | tojson }};

    // Variables globales pour la pr√©-√©coute audio
    let globalCurrentAudioInstance = null;
    let globalCurrentPlayingFile = null;
    let globalCurrentButtonPlaying = null; // Le bouton associ√© au son actif

    // --------------------------------------------------
    // 2. Fonctions Utilitaires (Helpers)
    // --------------------------------------------------

    function showConfigFeedback(message, type = 'info', duration = 4000) {
        const feedbackDiv = document.getElementById('config-feedback');
        if (!feedbackDiv) return;
        feedbackDiv.textContent = message;
        feedbackDiv.className = 'feedback-message'; // Reset classes
        feedbackDiv.classList.add(type, 'show');
        feedbackDiv.style.display = 'block';
        setTimeout(() => {
            feedbackDiv.classList.remove('show');
            setTimeout(() => { if (!feedbackDiv.classList.contains('show')) feedbackDiv.style.display = 'none'; }, 500);
        }, duration);
    }

function populateDropdown(selectId, options, selectedValue, addEmptyOptionValue = null) {
    const select = document.getElementById(selectId);
    if (!select) {
        console.error(`[populateDropdown] Select element with ID '${selectId}' not found.`);
        return;
    }
    select.innerHTML = '';
    console.log(`[populateDropdown] Populating: ${selectId}, SelectedValue (entr√©e): '${selectedValue}' (type: ${typeof selectedValue})`);

    if (addEmptyOptionValue !== null && selectId !== 'audio_device_select') {
        const emptyOpt = document.createElement('option');
        emptyOpt.value = "";
        emptyOpt.textContent = addEmptyOptionValue;
        select.appendChild(emptyOpt);
    }

    if (typeof options === 'object' && !Array.isArray(options)) {
        for (const [displayName, fileName] of Object.entries(options)) {
            const option = document.createElement('option');
            option.value = fileName;
            option.textContent = displayName;
            select.appendChild(option);
        }
    } else if (Array.isArray(options)) {
        options.forEach(item => {
            const option = document.createElement('option');
            if (typeof item === 'object' && item !== null && 'id' in item && 'name' in item) {
                option.value = item.id === null ? "" : item.id;
                option.textContent = item.name;
            } else {
                option.value = item;
                option.textContent = item;
            }
            select.appendChild(option);
        });
    }

    console.log(`[populateDropdown] ${selectId} - Attempting to set selected value. Current select.value (before): '${select.value}', Desired selectedValue: '${selectedValue}'`);

    if (selectedValue !== undefined && selectedValue !== null && selectedValue !== "") {
        select.value = selectedValue;
        console.log(`[populateDropdown] ${selectId} - After attempting to set to '${selectedValue}', select.value is now: '${select.value}'`);
        if (select.value !== selectedValue) {
            console.warn(`[populateDropdown] ${selectId} - WARN: select.value ('${select.value}') does not match selectedValue ('${selectedValue}'). Option might be missing or value mismatch.`);
        }
    } else if (selectId === 'audio_device_select' && (selectedValue === null || selectedValue === undefined || selectedValue === "")) {
        select.value = "";
        console.log(`[populateDropdown] ${selectId} - Set to default (value=\"\"). select.value is now: '${select.value}'`);
    } else if (addEmptyOptionValue !== null && selectId !== 'audio_device_select') {
         select.value = "";
         console.log(`[populateDropdown] ${selectId} - Set to empty option (value=\"\"). select.value is now: '${select.value}'`);
    }

    console.log(`[populateDropdown] Final select.value for ${selectId}: '${select.value}'`);
}

    function updateZoneDisplay() {
        const deptSelect = document.getElementById('departement');
        const zoneInput = document.getElementById('zone');
        if (deptSelect && zoneInput) {
            const selectedDept = deptSelect.value;
            zoneInput.value = departementsData[selectedDept] || 'N/A';
        }
    }

    // NOUVELLE FONCTION D√âDI√âE POUR ARR√äTER LE SON EN COURS
    function stopCurrentSound() {
        if (globalCurrentAudioInstance) {
            // console.log(`INFO: Appel stopCurrentSound pour '${globalCurrentPlayingFile}'`); // Moins verbeux
            globalCurrentAudioInstance.pause();
            globalCurrentAudioInstance.currentTime = 0;
            // D√©tacher les gestionnaires pour √©viter les appels tardifs
            globalCurrentAudioInstance.oncanplaythrough = null;
            globalCurrentAudioInstance.onerror = null;
            globalCurrentAudioInstance.onended = null;
            // Important: Ne PAS mettre src="" ici, car √ßa d√©clenche une erreur inutile

            if (globalCurrentButtonPlaying) {
                globalCurrentButtonPlaying.innerHTML = 'üîä √âcouter'; // R√©initialiser bouton
            }

            // Nettoyer √©tat global
            globalCurrentAudioInstance = null;
            globalCurrentPlayingFile = null;
            globalCurrentButtonPlaying = null;
            console.log("INFO: Son arr√™t√© et √©tat nettoy√©.");
            return true; // Indique qu'un son a √©t√© arr√™t√©
        }
        // console.log("INFO: Appel stopCurrentSound mais aucun son ne jouait."); // Log un peu verbeux, peut √™tre retir√©
        return false; // Indique qu'aucun son n'a √©t√© arr√™t√©
    }

    // --------------------------------------------------
    // 3. Fonctions li√©es aux Actions Utilisateur (Callbacks)
    // --------------------------------------------------

    // NOUVELLE FONCTION pour g√©rer le changement dans la liste d√©roulante
    function onSelectChange(selectId) {
        console.log(`--- onSelectChange pour ${selectId} ---`);
        const selectElement = document.getElementById(selectId);
        // Trouver le bouton associ√© (supposant qu'il est le fr√®re suivant)
        const button = selectElement ? selectElement.nextElementSibling : null;

        // V√©rifier si le son qui joue actuellement est celui associ√© √† CE bouton/select
        if (globalCurrentAudioInstance && globalCurrentButtonPlaying === button) {
            console.log(`INFO: S√©lection chang√©e pendant que le son associ√© ('${globalCurrentPlayingFile}') jouait. Arr√™t.`);
            stopCurrentSound(); // Arr√™te le son et r√©initialise l'√©tat et le bouton
        } else {
            // console.log("INFO: S√©lection chang√©e, mais aucun son associ√© ne jouait."); // Optionnel
        }
    }

    // Fonction pour la pr√©-√©coute (appel√©e par les boutons "√âcouter")
    function previewSound(selectId) {
        if (!canPreviewSound) { // Client-side check
            showConfigFeedback("Vous n'avez pas la permission de pr√©-√©couter les sonneries.", 'error');
            return;
        }
        // console.log(`--- previewSound pour ${selectId} ---`); // Moins verbeux
        const selectElement = document.getElementById(selectId);
        const button = selectElement ? selectElement.nextElementSibling : null;

        if (!selectElement || !button) {
             console.error(`√âl√©ments introuvables pour ${selectId}`);
             showConfigFeedback(`Erreur interne: √©l√©ments UI manquants.`, 'error');
             return;
        }

        const fileName = selectElement.value;
        console.log(`Fichier s√©lectionn√©: '${fileName}'`);
        // console.log(`√âtat global avant action: globalCurrentAudioInstance=${globalCurrentAudioInstance}, globalCurrentPlayingFile='${globalCurrentPlayingFile}', globalCurrentButtonPlaying=${globalCurrentButtonPlaying}`); // Optionnel, un peu verbeux

        // ACTION 1: Tenter d'arr√™ter si on clique sur le bouton du son en cours
        if (globalCurrentAudioInstance && !globalCurrentAudioInstance.paused && globalCurrentButtonPlaying === button) {
            console.log(`ACTION: Arr√™t explicite demand√© via bouton pour '${fileName}'`);
            if (stopCurrentSound()) { // Tenter d'arr√™ter et v√©rifier si √ßa a r√©ussi
                 showConfigFeedback(`Lecture de ${fileName.split('/').pop()} arr√™t√©e.`, 'info', 2000);
            }
            // stopCurrentSound s'occupe du nettoyage des globales et du bouton
            return; // Important de sortir ici
        }

        // ACTION 2: Si un son diff√©rent est en train de jouer, l'arr√™ter avant de continuer
        if (globalCurrentAudioInstance /* && globalCurrentButtonPlaying !== button est implicite */) {
            console.log(`INFO: Un son diff√©rent ('${globalCurrentPlayingFile}') jouait. Arr√™t avant de lancer le nouveau.`);
            stopCurrentSound(); // Arr√™te l'ancien son et nettoie les globales/bouton pr√©c√©dent
        }

        // Si "Aucune sonnerie" est s√©lectionn√©e, on s'arr√™te ici apr√®s avoir potentiellement arr√™t√© l'ancien son
        if (!fileName) {
            console.log("INFO: Aucune sonnerie s√©lectionn√©e pour lancement.");
            showConfigFeedback("Aucune sonnerie s√©lectionn√©e pour l'√©coute.", 'info', 2000);
            // S'assurer que le bouton actuel est sur √âcouter (normalement fait par stopCurrentSound si un son jouait avant)
            if (button.innerHTML !== 'üîä √âcouter') button.innerHTML = 'üîä √âcouter';
            return;
        }

        // ACTION 3: Lancer un nouveau son
        const soundUrl = `/api/sound/${encodeURIComponent(fileName)}`;
        console.log(`ACTION: Lancement du son '${fileName}' via URL: ${soundUrl}`);

        const localAudio = new Audio(soundUrl);

        // Assigner aux variables globales
        globalCurrentAudioInstance = localAudio;
        globalCurrentPlayingFile = fileName;
        globalCurrentButtonPlaying = button; // M√©moriser le bouton pour ce son

        button.innerHTML = '‚èπÔ∏è Arr√™ter';

        // --- Gestionnaires d'√©v√©nements ---
        localAudio.oncanplaythrough = function() {
            console.log(`EVENT: Audio '${fileName}' oncanplaythrough`);
            if (globalCurrentAudioInstance === this) {
                showConfigFeedback(`Lecture de: ${fileName.split('/').pop()}`, 'info', 2500);
                this.play().catch(e => {
                     console.error(`ERREUR: play() pour '${fileName}':`, e);
                     showConfigFeedback(`Erreur lecture: ${e.message}`, 'error');
                     stopCurrentSound(); // Nettoyer si play √©choue
                });
            } else { console.warn(`WARN: oncanplaythrough ignor√© pour ${fileName} (n'est plus l'instance globale)`); }
        };

        localAudio.onerror = function() {
            const errorFileName = fileName;
            const errorButton = button;
            console.error(`EVENT: Audio '${errorFileName}' onerror.`);
            showConfigFeedback(`Erreur chargement son: ${errorFileName.split('/').pop()}`, 'error');
            if (globalCurrentAudioInstance === this && globalCurrentButtonPlaying === errorButton) {
                stopCurrentSound(); // Nettoyer si erreur sur son actuel
            }
        };

        localAudio.onended = function() {
            const endedFileName = fileName;
            const endedButton = button;
            console.log(`EVENT: Audio '${endedFileName}' onended`);
            if (globalCurrentAudioInstance === this && globalCurrentButtonPlaying === endedButton) {
                showConfigFeedback(`Fin de lecture: ${endedFileName.split('/').pop()}`, 'info', 2000);
                stopCurrentSound(); // Nettoyer √† la fin normale
            }
        };
    }

    // Fonction pour sauvegarder la configuration (appel√©e par le bouton "Enregistrer")
    function saveConfig() {
        const departement = document.getElementById('departement').value;
        const zone = document.getElementById('zone').value;
        const vacances_ics_url = document.getElementById('vacances_ics_url').value;
        const sonnerie_ppms = document.getElementById('sonnerie_ppms').value;
        const sonnerie_attentat = document.getElementById('sonnerie_attentat').value;
        const sonnerie_fin_alerte = document.getElementById('sonnerie_fin_alerte').value;
        const selected_audio_device = document.getElementById('audio_device_select').value; // Nouvelle ligne

        const configToSave = {
            departement: departement,
            zone: zone,
            vacances_ics_base_url_manuel: vacances_ics_url,
            sonnerie_ppms: sonnerie_ppms,
            sonnerie_attentat: sonnerie_attentat,
            sonnerie_fin_alerte: sonnerie_fin_alerte,
            nom_peripherique_audio_sonneries: selected_audio_device === "" ? null : selected_audio_device // Nouvelle ligne, "" devient null
        };

        // ... (reste de la fonction saveConfig inchang√©) ...
        console.log("Sauvegarde config:", configToSave);
        showConfigFeedback("Sauvegarde en cours...", 'info', 1500);

        fetch('/api/config/general_and_alerts', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configToSave)
        })
        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
        .then(({ ok, status, data }) => {
            if (ok) {
                showConfigFeedback(data.message || "Configuration sauvegard√©e avec succ√®s !", 'success');
                if (confirm("Configuration sauvegard√©e. Voulez-vous demander au serveur de recharger sa configuration maintenant ?")) {
                    fetch('/api/config/reload', { method: 'POST' })
                        .then(reloadResponse => reloadResponse.json().then(reloadData => ({reloadOk: reloadResponse.ok, reloadData}))) // Renommer pour √©viter conflit avec data
                        .then(({reloadOk, reloadData}) => { // Utiliser les noms uniques
                             showConfigFeedback(reloadData.message || "Rechargement demand√©.", reloadOk ? 'info' : 'error', 5000);
                        })
                        .catch(err => showConfigFeedback("Erreur demande rechargement: " + err, 'error'));
                }
            } else { throw new Error(data.error || data.message || `Erreur serveur ${status}`); }
        })
        .catch(error => {
            console.error("Erreur sauvegarde config:", error);
            showConfigFeedback(`Erreur sauvegarde: ${error.message}`, 'error');
        });
        // --- FIN CODE INCHANG√â ---
    }

    // --------------------------------------------------
    // 4. Fonctions d'Initialisation et chargement initial
    // --------------------------------------------------

    function loadAndPopulateForm() {
        console.log("Appel API GET /api/config/general_and_alerts");
        let generalConfigData = null; // Pour stocker les donn√©es de la config g√©n√©rale

        fetch('/api/config/general_and_alerts')
            .then(response => {
                if (!response.ok) { throw new Error(`Erreur HTTP ${response.status} pour general_and_alerts: ${response.statusText}`); }
                return response.json();
            })
            .then(data => {
                generalConfigData = data; // Stocker les donn√©es pour utilisation ult√©rieure
                console.log("Donn√©es de config g√©n√©rale re√ßues:", data);

                populateDropdown('departement', listeDepartementsSorted, data.departement);
                updateZoneDisplay();
                document.getElementById('vacances_ics_url').value = data.vacances_ics_base_url_manuel || '';

                // Peupler les listes d√©roulantes des sonneries d'alerte
                populateDropdown('sonnerie_ppms', data.available_ringtones, data.sonnerie_ppms, "Aucune Sonnerie (PPMS)");
                populateDropdown('sonnerie_attentat', data.available_ringtones, data.sonnerie_attentat, "Aucune Sonnerie (Attentat)");
                populateDropdown('sonnerie_fin_alerte', data.available_ringtones, data.sonnerie_fin_alerte, "Aucune Sonnerie (Fin Alerte)");

                // Maintenant, charger les p√©riph√©riques audio
                console.log("Appel API GET /api/audio_devices");
                return fetch('/api/audio_devices');
            })
            .then(response => {
                if (!response.ok) { throw new Error(`Erreur HTTP ${response.status} pour audio_devices: ${response.statusText}`); }
                return response.json();
            })
            .then(audioDevicesData => {
                console.log("P√©riph√©riques audio re√ßus:", audioDevicesData);
                if (audioDevicesData.audio_devices) {
                    // Utiliser generalConfigData (charg√© pr√©c√©demment) pour la valeur s√©lectionn√©e
                    const selectedAudioDevice = generalConfigData ? generalConfigData.nom_peripherique_audio_sonneries : null;
                    populateDropdown('audio_device_select', audioDevicesData.audio_devices, selectedAudioDevice);
                } else {
                    console.warn("Aucun audio_devices trouv√© dans la r√©ponse de l'API.");
                    populateDropdown('audio_device_select', [{id: null, name: "P√©riph√©rique par d√©faut syst√®me"}], null); // Option par d√©faut
                }
                showConfigFeedback("Configuration actuelle et p√©riph√©riques audio charg√©s.", 'info', 2000);
            })
            .catch(error => {
                console.error("Erreur chargement config ou p√©riph√©riques audio:", error);
                showConfigFeedback(`Erreur chargement: ${error.message}`, 'error');
                // M√™me en cas d'erreur, essayer de peupler les listes d√©roulantes des sonneries si generalConfigData a √©t√© charg√©
                if (generalConfigData && generalConfigData.available_ringtones) {
                     populateDropdown('sonnerie_ppms', generalConfigData.available_ringtones, null, "Aucune Sonnerie (PPMS)");
                     populateDropdown('sonnerie_attentat', generalConfigData.available_ringtones, null, "Aucune Sonnerie (Attentat)");
                     populateDropdown('sonnerie_fin_alerte', generalConfigData.available_ringtones, null, "Aucune Sonnerie (Fin Alerte)");
                }
                // S'assurer que la liste des p√©riph√©riques audio a au moins l'option par d√©faut
                populateDropdown('audio_device_select', [{id: null, name: "P√©riph√©rique par d√©faut syst√®me"}], null);
            });
    }

    function initPage() {
        console.log("Initialisation page config g√©n√©rale...");
        loadAndPopulateForm(); // Charger les donn√©es initiales
    }

    // --------------------------------------------------
    // 5. √âcouteur d'√©v√©nement pour lancer l'initialisation
    // --------------------------------------------------
    document.addEventListener('DOMContentLoaded', initPage);

</script>

</body>
</html>