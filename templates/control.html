{% extends "base.html" %}

{% block title %}Contrôle Principal - {{ super() }}{% endblock %}

{% block page_title %}Tableau de Bord & Contrôle{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12 mb-3"> {# Colonne pour les alertes - prend toute la largeur #}
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> Actions d'Alerte
                </div>
                <div class="card-body text-center">

                    <div class="btn-toolbar justify-content-center" role="toolbar" aria-label="Toolbar avec groupes de boutons d'alerte">
                        <div class="btn-group me-2" role="group" aria-label="Alerte PPMS">
                            <button type="button" class="btn btn-lg btn-warning px-3" id="btn-alert-ppms" title="Double-clic pour gérer l'alerte PPMS">
                                <i class="bi bi-shield-fill-exclamation me-1"></i>PPMS
                            </button>
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="Alerte Attentat">
                            <button type="button" class="btn btn-lg btn-danger px-3" id="btn-alert-attentat" title="Double-clic pour gérer l'alerte Attentat">
                                <i class="bi bi-cone-striped me-1"></i>ATTENTAT
                            </button>
                        </div>
                        <div class="btn-group" role="group" aria-label="Fin Alerte">
                            <button type="button" class="btn btn-lg btn-success px-3" id="btn-end-alert" title="Terminer l'alerte en cours avec le son de fin" disabled>
                                <i class="bi bi-check-circle-fill me-1"></i>Sonnerie Fin d'Alerte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {# Ancienne colonne "Autres Contrôles" supprimée #}
    </div>

    <!-- Zone pour afficher les messages de feedback des contrôles (doit être conservée) -->
    <div id="control-message" class="feedback-message" style="display: none; margin-top: 15px;"></div>

    <!-- Section Calendrier -->
    <div id="calendar-section" class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap"> {# flex-wrap pour les petits écrans #}
            <h2 class="mb-0 me-auto">Calendrier <span id="calendar-title-year">Annuel</span></h2> {# me-auto pour pousser le sélecteur à droite si besoin #}

            {% if user_has_permission('control:view_calendar') %}
            <div id="calendar-selector" class="ms-3 d-flex align-items-center"> {# d-flex et align-items-center pour le label et select #}
                <label for="academic-year-select" class="form-label mb-0 me-2" style="white-space: nowrap; flex-shrink: 0;">Année scolaire :</label> {# mb-0 car c'est un form-label dans un flex #}
                <select id="academic-year-select" class="form-select form-select-sm" style="min-width: 120px;" onchange="changeAcademicYear()">
                    <!-- Options ajoutées par JS -->
                </select>
            </div>
            {% endif %}
        </div>

        {% if user_has_permission('control:view_calendar') %}
        <div id="calendar-container">
            <p>Chargement du calendrier...</p>
        </div>
        {% else %}
        <p><em>Vous n'avez pas la permission de voir le calendrier.</em></p>
        {% endif %}
    </div>

    <!-- Fenêtre Modale (initialement cachée) -->
    <div id="modal-overlay" class="modal-overlay" onclick="if (event.target === this) { closeModal(); }">
        <div id="modal-box" class="modal-box">
            <button id="modal-close-btn" class="modal-close-btn" onclick="closeModal()">×</button>
            <div id="modal-content">
                <p>Chargement des détails...</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }} {# Important si base.html a des scripts dans son bloc scripts #}
    <script>
// --- Variables Globales pour control.html ---
let currentStatus = { alert_active: false, alert_type: null };
let configSettings = { alert_files: { ppms: null, attentat: null } };
let selectedAcademicYear; // Sera initialisée par getDefaultAcademicYear dans DOMContentLoaded

// Variables pour la logique d'alerte
let ppmsClickTimer = null;
let attentatClickTimer = null;
let endAlertClickTimer = null;
const DBL_CLICK_DELAY = 300;
let btnAlertPpms, btnAlertAttentat, btnEndAlert; // Seront initialisées dans DOMContentLoaded

// --- Fonctions Utilitaires Existantes (Calendrier, Modale, Feedback - CONSERVER CELLES-CI) ---
function getDefaultAcademicYear() {
    const now = new Date(); const currentYear = now.getFullYear(); const currentMonth = now.getMonth();
    const startYear = (currentMonth < 8) ? currentYear - 1 : currentYear;
    return `${startYear}-${startYear + 1}`;
}

function populateAcademicYearSelector() {
    const selectElement = document.getElementById('academic-year-select'); if (!selectElement) return; selectElement.innerHTML = '';
    const currentStartYear = parseInt(selectedAcademicYear.split('-')[0]); const yearsToShow = 3;
    for (let i = -yearsToShow; i <= yearsToShow; i++) {
        const startYear = currentStartYear + i; const yearString = `${startYear}-${startYear + 1}`;
        const option = document.createElement('option'); option.value = yearString; option.textContent = yearString; selectElement.appendChild(option);
    } selectElement.value = selectedAcademicYear;
}
function changeAcademicYear() {
     const selectElement = document.getElementById('academic-year-select'); if (selectElement) { selectedAcademicYear = selectElement.value; console.log(`Changement année scolaire: ${selectedAcademicYear}`); showCalendar(); }
 }
function closeModal() {
    const modalOverlay = document.getElementById('modal-overlay'); if (modalOverlay) { modalOverlay.classList.remove('visible'); setTimeout(() => { const mc = document.getElementById('modal-content'); if (mc) mc.innerHTML = '<p>Chargement...</p>'; }, 300); }
}

function showFeedback(message, type = 'info', duration = 4000) {
    const feedbackDiv = document.getElementById('control-message');
    if (!feedbackDiv) {
        console.error("Élément #control-message introuvable pour le feedback.");
        return;
    }
    feedbackDiv.textContent = message;
    feedbackDiv.classList.remove('success', 'error', 'info', 'show'); // Nettoyer anciennes classes
    feedbackDiv.classList.add(type); // Ajouter le type de message (success, error, info)
    feedbackDiv.style.display = 'block'; // Assurer la visibilité
    void feedbackDiv.offsetWidth; // Forcer un reflow pour que l'animation CSS prenne effet
    feedbackDiv.classList.add('show'); // Ajouter la classe 'show' pour l'animation d'apparition

    setTimeout(() => {
        feedbackDiv.classList.remove('show'); // Retirer 'show' pour l'animation de disparition
        setTimeout(() => {
            // S'assurer que le display:none n'est appliqué que si 'show' n'a pas été rajouté entre-temps
            if (!feedbackDiv.classList.contains('show')) {
               feedbackDiv.style.display = 'none';
            }
        }, 500); // Laisser le temps à l'animation de disparition de se terminer (doit correspondre à la durée de transition CSS)
    }, duration);
}


// --- Fonctions Calendrier Existantes - CONSERVER CELLES-CI ---
function showCalendar() {
     console.log(`Début showCalendar pour année scolaire: ${selectedAcademicYear}`); const titleElement = document.getElementById('calendar-title-year'); if (titleElement) titleElement.textContent = `Scolaire ${selectedAcademicYear}`;
     const calendarContainer = document.getElementById('calendar-container'); if (calendarContainer) calendarContainer.innerHTML = '<p>Chargement calendrier...</p>';
     const apiUrl = `/api/calendar_view?year=${selectedAcademicYear}`; console.log(`Appel API calendrier: ${apiUrl}`);
     fetch(apiUrl)
         .then(response => { console.log(`Réponse ${apiUrl}, statut: ${response.status}`); if (!response.ok) { return response.json().then(err => {throw new Error(`Erreur HTTP ${response.status}: ${err.error||response.statusText}`)}).catch(() => {throw new Error(`Erreur HTTP ${response.status}`)}); } return response.json(); })
         .then(data => { console.log("[Calendar] Données API:", data); if (data.error) { throw new Error(`Erreur API calendrier: ${data.error}`); } console.log("Appel generateCalendar:", data); generateCalendar(data, selectedAcademicYear); console.log("generateCalendar exécuté."); })
         .catch(error => { console.error("Erreur showCalendar:", error); if (calendarContainer) calendarContainer.innerHTML = `<p>Erreur chargement: ${error.message}</p>`; });
     console.log("Fin showCalendar (fetch lancé)");
 }

function generateCalendar(apiData, academicYear) {
    console.log(`Entrée generateCalendar pour année: ${academicYear}`);
    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) { console.error("Conteneur #calendar-container introuvable !"); return; }
    calendarContainer.innerHTML = '';
    const today = new Date();
    const currentDay = today.getDate(); const currentMonth = today.getMonth() + 1; const currentYearToday = today.getFullYear();
    const todayStr = `${currentYearToday}-${String(currentMonth).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
    console.log(`Date actuelle: ${todayStr}`);
    if (!apiData || typeof apiData !== 'object' || !apiData.days || typeof apiData.days !== 'object') { console.error("Données calendrier invalides:", apiData); calendarContainer.innerHTML = "<p>Erreur: Données calendrier invalides.</p>"; return; }
    const daysData = apiData.days;
    const [startYear, endYear] = academicYear.split('-').map(Number);
    console.log(`Affichage de Sept ${startYear} à Août ${endYear}`);
    for (let m = 0; m < 12; m++) {
        let month, year;
        if (m < 4) { month = m + 9; year = startYear; }
        else { month = m - 3; year = endYear; }
        const monthDiv = document.createElement('div'); monthDiv.classList.add('calendar-month');
        const monthDate = new Date(year, month - 1, 1);
        const monthName = monthDate.toLocaleString('fr-FR', { month: 'long' });
        monthDiv.innerHTML = `<h3>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}</h3>`;
        const daysInMonth = new Date(year, month, 0).getDate();
        const firstDayWeekday = (monthDate.getDay() + 6) % 7;
        const daysContainer = document.createElement('div'); daysContainer.classList.add('calendar-days');
        const weekDays = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
        weekDays.forEach(wd => { const d = document.createElement('div'); d.classList.add('calendar-weekday'); d.textContent = wd; daysContainer.appendChild(d); });
        for (let i = 0; i < firstDayWeekday; i++) { const emptyCell = document.createElement('div'); emptyCell.classList.add('calendar-day', 'empty'); daysContainer.appendChild(emptyCell); }
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div'); dayCell.classList.add('calendar-day'); dayCell.textContent = day;
            const monthStrPad = String(month).padStart(2, '0'); const dayStrPad = String(day).padStart(2, '0');
            const dateKey = `${year}-${monthStrPad}-${dayStrPad}`;
            const dayData = daysData[dateKey];
            if (dateKey === todayStr) { dayCell.classList.add('today'); }
            if (dayData) {
                let cssClass = ''; let tooltipText = dayData.description || dayData.type || '';
                const typeValue = dayData.type || 'ERREUR'; const typeLower = typeValue.toLowerCase().trim();
                if (typeLower.startsWith('exception (silence)')) { cssClass = 'exception-silence'; tooltipText = dayData.description || "Journée Silence (Exception)"; }
                else if (typeLower.startsWith('exception (utiliser_jt')) { cssClass = 'exception-jt'; tooltipText = dayData.description || "Exception : Journée Type Spécifique"; }
                else if (typeLower === 'férié') { cssClass = 'ferie'; }
                else if (typeLower === 'vacances') { cssClass = 'vacances'; }
                else if (typeLower === 'weekend') { cssClass = 'weekend'; }
                else if (typeLower.startsWith('classe')) { cssClass = 'classe'; tooltipText = dayData.description || typeValue; }
                else if (typeLower === 'autre' || typeLower === 'erreur') { console.warn(`Type jour 'Autre' ou 'Erreur' reçu: '${typeValue}' pour ${dateKey}`); tooltipText = dayData.description || typeValue; }
                else { console.error(`!!! Type jour INCONNU: '${typeValue}' (lower: '${typeLower}') pour ${dateKey} !!!`); cssClass = 'erreur-donnees'; tooltipText = `Type Inconnu: ${typeValue}`; }
                console.log(`[Cal Apply] ${dateKey}: Type='${typeValue}' -> CSS Class='${cssClass || 'aucune'}'`);
                if (cssClass) { dayCell.classList.add(cssClass); }
                if (tooltipText) { dayCell.title = tooltipText; }
                dayCell.style.cursor = 'pointer'; dayCell.onclick = () => showDailySchedule(year, month, day);
            } else { console.warn(`Aucune donnée API pour ${dateKey}`); dayCell.classList.add('erreur-donnees'); dayCell.title = "Données manquantes"; }
            daysContainer.appendChild(dayCell);
        }
        monthDiv.appendChild(daysContainer); calendarContainer.appendChild(monthDiv);
    }
    console.log("Fin de generateCalendar");
}

function showDailySchedule(year, month, day) {
     console.log(`>>> Début showDailySchedule ${year}-${month}-${day}`);
     const monthStr = month.toString().padStart(2, '0'); const dayStr = day.toString().padStart(2, '0');
     const dateStr = `${year}-${monthStr}-${dayStr}`; console.log(`   Date: ${dateStr}`);
     const modalOverlay = document.getElementById('modal-overlay'); const modalContent = document.getElementById('modal-content');
     if (!modalOverlay || !modalContent) { console.error("   Elts modale manquants !"); return; }
	 modalContent.innerHTML = `<p>Chargement des horaires pour ${dayStr}/${monthStr}/${year}...</p>`; modalOverlay.classList.add('visible');
     const apiUrl = `/api/daily_schedule?date=${dateStr}`; console.log(`   Fetch: ${apiUrl}`);
     try {
         fetch(apiUrl)
             .then(response => {
                 console.log(`   Réponse ${apiUrl}, statut: ${response.status}`);
                 if (!response.ok) { return response.json().then(err => { throw new Error(`Erreur ${response.status}: ${err.error || err.message || response.statusText}`) }).catch(() => { throw new Error(`Erreur HTTP ${response.status}`) }); }
                 return response.json();
             })
             .then(data => {
                  console.log("   Détails reçus:", data);
                  let htmlModalContent = `<h4>Détails du ${dayStr}/${monthStr}/${year}</h4>`;
                  let dayInfoText = data.message || data.day_type || "Information indisponible";
                  htmlModalContent += `<span class="day-type-info">${dayInfoText}</span>`;
                  if (data.error) { htmlModalContent += `<p style="color: red;">Erreur: ${data.error}</p>`; }
                  else if (data.schedule && Array.isArray(data.schedule) && data.schedule.length > 0) {
                      htmlModalContent += `<table><thead><tr><th>Heure</th><th>Événement</th><th>Sonnerie</th></tr></thead><tbody>`;
                      data.schedule.forEach(item => { const timeFormatted = item.time.substring(0, 5); htmlModalContent += `<tr><td>${timeFormatted}</td><td>${item.event||'N/A'}</td><td><em>${item.sonnerie||'Silence'}</em></td></tr>`; });
                      htmlModalContent += `</tbody></table>`;
                  } else { htmlModalContent += `<p><em>Aucune sonnerie planifiée.</em></p>`; }
                  modalContent.innerHTML = htmlModalContent; console.log("   Affichage détails OK (modale).");
             })
             .catch(error => { console.error(`   Erreur dans showDailySchedule pour ${dateStr}:`, error); modalContent.innerHTML = `<p style="color: red;">Impossible de charger les détails.<br>${error.message}</p>`; });
     } catch (fetchError) { console.error(`   Erreur synchrone showDailySchedule:`, fetchError); modalContent.innerHTML = `<p style="color: red;">Erreur JS.<br>${fetchError.message}</p>`; }
     console.log(`<<< Fin appel synchrone showDailySchedule pour ${dateStr}`);
}

// --- NOUVELLE LOGIQUE POUR LES ALERTES ---

function loadConfigSettings() {
    console.log("[control.html] Chargement settings via /api/config/settings...");
    return fetch('/api/config/settings')
        .then(response => {
            if (!response.ok) throw new Error(`Erreur HTTP settings: ${response.status} ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            console.log("[control.html] Settings reçus:", data);
            if (data) {
                configSettings = data; // Stocker tous les settings (inclut alert_files, alert_click_mode, etc.)
                // Assurer une valeur par défaut pour alert_files si non présent
                if (!configSettings.alert_files) {
                    console.warn("[control.html] configSettings.alert_files manquant après chargement. Initialisation par défaut.");
                    configSettings.alert_files = { ppms: null, attentat: null };
                }
                // Assurer une valeur par défaut pour alert_click_mode si non présent
                if (configSettings.alert_click_mode === undefined) {
                    console.warn("[control.html] configSettings.alert_click_mode manquant. Défaut à 'double'.");
                    configSettings.alert_click_mode = "double";
                }
            } else {
                console.warn("[control.html] Données de settings API null ou vides. Utilisation des valeurs par défaut.");
                configSettings = {
                    alert_files: { ppms: null, attentat: null },
                    alert_click_mode: "double"
                };
            }
        })
        .catch(error => {
            console.error("[control.html] Erreur critique chargement settings:", error);
            configSettings = {
                alert_files: { ppms: null, attentat: null },
                alert_click_mode: "double"
            };
            if (typeof showFeedback === 'function') showFeedback("Erreur chargement configuration des alertes. Fonctionnalité d'alerte affectée.", "error");
            throw error;
        });
}

function updateAlertButtonsUI(statusData) {
    if (!statusData) {
        console.warn("[control.html] updateAlertButtonsUI: statusData est null.");
        if(btnAlertPpms) btnAlertPpms.disabled = true;
        if(btnAlertAttentat) btnAlertAttentat.disabled = true;
        if(btnEndAlert) btnEndAlert.disabled = true;
        return;
    }
    if (!btnAlertPpms || !btnAlertAttentat || !btnEndAlert) {
        console.warn("[control.html] updateAlertButtonsUI: Un ou plusieurs éléments de bouton ne sont pas encore initialisés.");
        return;
    }
    if (!configSettings || !configSettings.alert_files || configSettings.alert_files.ppms === undefined || configSettings.alert_files.attentat === undefined) {
        console.warn("[control.html] updateAlertButtonsUI: configSettings.alert_files non disponible ou incomplet.", configSettings);
        if (typeof showFeedback === 'function') showFeedback("Config alerte incomplète. Boutons désactivés.", "error", 7000);
        btnAlertPpms.disabled = true; btnAlertPpms.title = "Config PPMS manquante";
        btnAlertAttentat.disabled = true; btnAlertAttentat.title = "Config Attentat manquante";
        btnEndAlert.disabled = true;
        return;
    }

    const ppmsFile = configSettings.alert_files.ppms;
    const attentatFile = configSettings.alert_files.attentat;

    let isPpmsActiveBackend = (statusData.alert_active && statusData.alert_type === ppmsFile);
    let isAttentatActiveBackend = (statusData.alert_active && statusData.alert_type === attentatFile);

    console.log(`[control.html] updateAlertButtonsUI: PPMS Active? ${isPpmsActiveBackend}, Attentat Actif? ${isAttentatActiveBackend}, Alerte Active Générique? ${statusData.alert_active}, Type: ${statusData.alert_type}`);

    btnAlertPpms.classList.remove('btn-danger', 'active', 'btn-warning', 'blinking-alert'); // Nettoyer blinking-alert
    btnAlertPpms.disabled = false;
    if (isPpmsActiveBackend) {
        btnAlertPpms.classList.add('btn-danger', 'active', 'blinking-alert'); // Ajouter blinking-alert
        btnAlertPpms.innerHTML = '<i class="bi bi-shield-fill-exclamation me-1"></i>PPMS ACTIVE';
        btnAlertPpms.title = "Double-clic pour ARRETER l'alerte PPMS";
        btnAlertAttentat.disabled = true;
    } else {
        btnAlertPpms.classList.add('btn-warning');
        btnAlertPpms.innerHTML = '<i class="bi bi-shield-fill-exclamation me-1"></i>PPMS';
        btnAlertPpms.title = "Double-clic pour DECLENCHER l'alerte PPMS";
        if (isAttentatActiveBackend) btnAlertPpms.disabled = true;
    }

    btnAlertAttentat.classList.remove('btn-dark', 'active', 'btn-danger', 'blinking-alert'); // Nettoyer 'btn-dark' aussi
    btnAlertAttentat.disabled = false;

    if (isAttentatActiveBackend) {
        btnAlertAttentat.classList.add('btn-danger', 'active', 'blinking-alert'); // <<< CHANGEMENT ICI : btn-danger au lieu de btn-dark
        btnAlertAttentat.innerHTML = '<i class="bi bi-cone-striped me-1"></i>ATTENTAT ACTIF';
        btnAlertAttentat.title = "Double-clic pour ARRETER l'alerte Attentat";
        btnAlertPpms.disabled = true;
    } else {
        btnAlertAttentat.classList.add('btn-danger'); // Couleur par défaut reste btn-danger
        btnAlertAttentat.innerHTML = '<i class="bi bi-cone-striped me-1"></i>ATTENTAT';
        btnAlertAttentat.title = "Double-clic pour DECLENCHER l'alerte Attentat";
        if (isPpmsActiveBackend) btnAlertAttentat.disabled = true;
    }

    if (statusData.alert_active && !isPpmsActiveBackend && !isAttentatActiveBackend) {
        btnAlertPpms.disabled = true;
        btnAlertAttentat.disabled = true;
    }

    btnEndAlert.disabled = !statusData.alert_active;
}

function fetchPageStatusAndUpdateAlertUI() {
    console.log("[control.html] fetchPageStatusAndUpdateAlertUI: Récupération du statut...");
    return fetch('/api/status')
        .then(response => {
            if (!response.ok) {
                return response.json().catch(() => null).then(errData => {
                    const errorMsg = errData && errData.error ? errData.error : `Erreur HTTP status: ${response.status} ${response.statusText}`;
                    throw new Error(errorMsg);
                });
            }
            return response.json();
        })
        .then(data => {
            currentStatus = data;
            console.log("[control.html] Statut local mis à jour:", currentStatus);
            updateAlertButtonsUI(currentStatus);
            if (typeof fetchGlobalStatus === 'function') fetchGlobalStatus();
        })
        .catch(error => {
            console.error("[control.html] Erreur fetchPageStatusAndUpdateAlertUI:", error);
            if (typeof showFeedback === 'function') showFeedback(`Erreur statut: ${error.message}`, 'error');
            updateAlertButtonsUI({ alert_active: false, alert_type: null });
        });
}

function callApiAndRefresh(apiUrl, method = 'POST', actionText = 'Action') {
    console.log(`[control.html] Appel API: ${actionText} -> ${apiUrl}`);
    if(btnAlertPpms) btnAlertPpms.disabled = true;
    if(btnAlertAttentat) btnAlertAttentat.disabled = true;
    if(btnEndAlert) btnEndAlert.disabled = true;

    return fetch(apiUrl, { method: method })
        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
        .then(({ ok, status, data }) => {
            const message = data.message || (ok ? `${actionText} réussie.` : `Erreur ${actionText} (${status})`);
            if (typeof showFeedback === 'function') showFeedback(message, ok ? 'success' : 'error');
            if (!ok && data.error) console.error(`[control.html] Erreur API ${actionText}: ${data.error}`);
        })
        .catch(error => {
            console.error(`[control.html] Erreur réseau/serveur (${actionText}): ${error.message}`);
            if (typeof showFeedback === 'function') showFeedback(`Erreur réseau (${actionText}): ${error.message}`, 'error');
        })
        .finally(() => {
            if (typeof fetchPageStatusAndUpdateAlertUI === 'function') {
                fetchPageStatusAndUpdateAlertUI();
            }
        });
}

function callTriggerAlertAPI(alertType) {
    if (!configSettings || !configSettings.alert_files) { showFeedback("Erreur: Config alertes non chargée.", 'error'); return Promise.reject("Config non chargée"); }
    let key = alertType.toLowerCase();
    let file = configSettings.alert_files[key];
    if (!file) { showFeedback(`Sonnerie pour ${alertType} non configurée!`, 'error'); return Promise.reject("Fichier non configuré"); }
    return callApiAndRefresh(`/api/alert/trigger/${encodeURIComponent(file)}`, 'POST', `Déclenchement ${alertType}`);
}

function callStopAlertAPI() { return callApiAndRefresh('/api/alert/stop', 'POST', "Arrêt Urgence Alerte"); }
function callEndAlertAPI() { return callApiAndRefresh('/api/alert/end', 'POST', "Fin d'Alerte Programmée"); }

// --- Initialisation ---
document.addEventListener('DOMContentLoaded', function() {
    console.log("[control.html] DOMContentLoaded: Initialisation de la page de contrôle...");

    selectedAcademicYear = getDefaultAcademicYear(); // Initialisation pour le calendrier

    btnAlertPpms = document.getElementById('btn-alert-ppms');
    btnAlertAttentat = document.getElementById('btn-alert-attentat');
    btnEndAlert = document.getElementById('btn-end-alert');

    if (typeof populateAcademicYearSelector === 'function') populateAcademicYearSelector();

    if (typeof loadConfigSettings === 'function') {
        loadConfigSettings()
            .then(() => {
                console.log("[control.html] DOMContentLoaded: Config settings chargées.");
                if (typeof fetchPageStatusAndUpdateAlertUI === 'function') {
                    return fetchPageStatusAndUpdateAlertUI();
                } else {
                     console.error("[control.html] fetchPageStatusAndUpdateAlertUI non définie !");
                }
            })
            .then(() => {
                console.log("[control.html] DOMContentLoaded: Statut initial chargé et UI alertes mise à jour.");
                if (typeof showCalendar === 'function') showCalendar();
            })
            .catch(error => {
                console.error("[control.html] DOMContentLoaded: Erreur dans la séquence d'initialisation.", error);
                updateAlertButtonsUI({ alert_active: false, alert_type: null });
            });
    } else {
        console.error("[control.html] loadConfigSettings n'est pas définie! Initialisation incomplète.");
        updateAlertButtonsUI({ alert_active: false, alert_type: null });
    }

    if (btnAlertPpms) {
        btnAlertPpms.addEventListener('click', function() {
            if (this.disabled) return;

            const performActionPpms = () => {
                const ppmsFile = configSettings.alert_files ? configSettings.alert_files.ppms : null;
                const isActive = (currentStatus && currentStatus.alert_active && currentStatus.alert_type === ppmsFile);
                console.log(`[control.html] Action PPMS (mode: ${configSettings.alert_click_mode || 'double'}). Actif? ${isActive}`);
                if (isActive) callStopAlertAPI();
                else if (currentStatus && !currentStatus.alert_active) callTriggerAlertAPI('PPMS');
                else if (typeof showFeedback === 'function') showFeedback("Action PPMS impossible: autre alerte active ou statut inconnu.", "warning");
            };

            const currentAlertClickMode = configSettings.alert_click_mode || 'double'; // Récupérer ou défaut

            if (currentAlertClickMode === 'single') {
                performActionPpms();
            } else { // Mode double-clic (par défaut)
                if (ppmsClickTimer === null) {
                    ppmsClickTimer = setTimeout(() => { ppmsClickTimer = null; }, DBL_CLICK_DELAY);
                } else {
                    clearTimeout(ppmsClickTimer); ppmsClickTimer = null;
                    performActionPpms();
                }
            }
        });
    } else { console.error("Bouton #btn-alert-ppms non trouvé."); }

    if (btnAlertAttentat) {
        btnAlertAttentat.addEventListener('click', function() {
            if (this.disabled) return;

            const performActionAttentat = () => {
                const attentatFile = configSettings.alert_files ? configSettings.alert_files.attentat : null;
                const isActive = (currentStatus && currentStatus.alert_active && currentStatus.alert_type === attentatFile);
                console.log(`[control.html] Action Attentat (mode: ${configSettings.alert_click_mode || 'double'}). Actif? ${isActive}`);
                if (isActive) callStopAlertAPI();
                else if (currentStatus && !currentStatus.alert_active) callTriggerAlertAPI('Attentat');
                else if (typeof showFeedback === 'function') showFeedback("Action Attentat impossible: autre alerte active ou statut inconnu.", "warning");
            };

            const currentAlertClickMode = configSettings.alert_click_mode || 'double';

            if (currentAlertClickMode === 'single') {
                performActionAttentat();
            } else { // Mode double-clic
                if (attentatClickTimer === null) {
                    attentatClickTimer = setTimeout(() => { attentatClickTimer = null; }, DBL_CLICK_DELAY);
                } else {
                    clearTimeout(attentatClickTimer); attentatClickTimer = null;
                    performActionAttentat();
                }
            }
        });
    } else { console.error("Bouton #btn-alert-attentat non trouvé."); }

    if (btnEndAlert) {
        btnEndAlert.addEventListener('click', function() {
            if (this.disabled) return;

            const performActionEndAlert = () => {
                console.log(`[control.html] Action Fin d'Alerte (mode: ${configSettings.alert_click_mode || 'double'}).`);
                if (typeof callEndAlertAPI === 'function') {
                    callEndAlertAPI();
                } else {
                    console.error("[control.html] La fonction callEndAlertAPI n'est pas définie !");
                }
            };

            const currentAlertClickMode = configSettings.alert_click_mode || 'double';

            if (currentAlertClickMode === 'single') {
                performActionEndAlert();
            } else { // Mode double-clic
                if (endAlertClickTimer === null) {
                    endAlertClickTimer = setTimeout(() => {
                        endAlertClickTimer = null;
                        console.log("[control.html] Simple clic sur Sonnerie Fin d'Alerte (ignoré en mode double-clic)");
                    }, DBL_CLICK_DELAY);
                } else {
                    clearTimeout(endAlertClickTimer);
                    endAlertClickTimer = null;
                    performActionEndAlert();
                }
            }
        });
    } else { console.error("Bouton #btn-end-alert non trouvé pour attacher listener."); }

    console.log("[control.html] DOMContentLoaded: Fin de l'initialisation.");
});

    </script>
{% endblock %}