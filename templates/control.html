{% extends "base.html" %}

{% block title %}Contrôle Principal - {{ super() }}{% endblock %}

{% block page_title %}Tableau de Bord & Contrôle{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12 mb-3"> {# Colonne pour les alertes - prend toute la largeur #}
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> Actions d'Alerte
                </div>
                <div class="card-body text-center">

                    <div class="btn-toolbar justify-content-center" role="toolbar" aria-label="Toolbar avec groupes de boutons d'alerte">
                        <div class="btn-group me-2" role="group" aria-label="Alerte PPMS">
                            <button type="button" class="btn btn-lg btn-warning px-3" id="btn-alert-ppms" title="Double-clic pour gérer l'alerte PPMS">
                                <i class="bi bi-shield-fill-exclamation me-1"></i>PPMS
                            </button>
                        </div>
                        <div class="btn-group me-2" role="group" aria-label="Alerte Attentat">
                            <button type="button" class="btn btn-lg btn-danger px-3" id="btn-alert-attentat" title="Double-clic pour gérer l'alerte Attentat">
                                <i class="bi bi-cone-striped me-1"></i>ATTENTAT
                            </button>
                        </div>
                        <div class="btn-group" role="group" aria-label="Fin Alerte">
                            <button type="button" class="btn btn-lg btn-success px-3" id="btn-end-alert" title="Terminer l'alerte en cours avec le son de fin" disabled>
                                <i class="bi bi-check-circle-fill me-1"></i>Sonnerie Fin d'Alerte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {# Ancienne colonne "Autres Contrôles" supprimée #}
    </div>

    <!-- Zone pour afficher les messages de feedback des contrôles (doit être conservée) -->
    <div id="control-message" class="feedback-message" style="display: none; margin-top: 15px;"></div>

    <!-- Section Calendrier -->
    <div id="calendar-section" class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
{# --- DÉBUT DE LA STRUCTURE HTML DE RÉFÉRENCE --- #}

{# Le titre doit être ici #}
<h2 class="mb-0 me-auto">Calendrier <span id="calendar-title-year">Annuel</span></h2>

{% if user_has_permission('control:view_calendar') %}
    {# Les sélecteurs sont maintenant des enfants directs du conteneur flex principal #}
    <div id="calendar-view-selector" class="d-flex align-items-center me-3">
        <label for="calendar-view-type-select" class="form-label mb-0 me-2">Vue :</label>
        <select id="calendar-view-type-select" class="form-select form-select-sm" style="min-width: 120px;" onchange="changeCalendarView(event)">
            <option value="year">Annuelle</option>
            <option value="semester">Semestrielle</option>
            <option value="trimester">Trimestrielle</option>
            <option value="month">Mensuelle</option>
            <option value="week">Hebdomadaire</option>
            <option value="day">Journalière</option>
        </select>
    </div>

    <div id="calendar-period-controls" class="d-flex align-items-center flex-wrap">
        {# Sélecteur d'Année Scolaire #}
        <div id="academic-year-selector-container" class="d-flex align-items-center me-3">
            <label for="academic-year-select" class="form-label mb-0 me-2">Année scolaire :</label>
            <select id="academic-year-select" class="form-select form-select-sm" style="min-width: 120px;" onchange="changeCalendarView(event)"></select>
        </div>
        {# Sélecteur de Semestre #}
        <div id="semester-selector-container" class="d-flex align-items-center me-3">
            <label for="semester-select" class="form-label mb-0 me-2">Semestre :</label>
            <select id="semester-select" class="form-select form-select-sm" style="min-width: 150px;" onchange="changeCalendarView(event)">
                <option value="1">S1 (Sept - Fev)</option>
                <option value="2">S2 (Mar - Aoû)</option>
            </select>
        </div>

        {# Sélecteur de Trimestre #}
        <div id="trimester-selector-container" class="d-flex align-items-center me-3">
            <label for="trimester-select" class="form-label mb-0 me-2">Trimestre :</label>
            <select id="trimester-select" class="form-select form-select-sm" style="min-width: 150px;" onchange="changeCalendarView(event)">
                <option value="1">T1 (Sept - Déc)</option>
                <option value="2">T2 (Jan - Avr)</option>
                <option value="3">T3 (Mai - Aoû)</option>
            </select>
        </div>

        {# Sélecteur de Mois #}
        <div id="month-selector-container" class="d-flex align-items-center me-3">
            <label for="month-select" class="form-label mb-0 me-2">Mois :</label>
            <select id="month-select" class="form-select form-select-sm" style="min-width: 130px;" onchange="changeCalendarView(event)"></select>
        </div>

        {# Sélecteur de Semaine #}
        <div id="week-selector-container" class="d-flex align-items-center me-3">
            <label for="week-date-select" class="form-label mb-0 me-2">Semaine du :</label>
            <input type="date" id="week-date-select" class="form-control form-control-sm" style="width: auto;" onchange="changeCalendarView(event)">
            <div class="btn-group btn-group-sm ms-2" role="group">
                <button type="button" class="btn btn-outline-secondary" id="prev-week-btn" title="Semaine précédente"><i class="bi bi-chevron-left"></i></button>
                <button type="button" class="btn btn-outline-secondary" id="next-week-btn" title="Semaine suivante"><i class="bi bi-chevron-right"></i></button>
            </div>
            <span id="week-info-display" class="ms-2 small"></span>
        </div>

        {# Sélecteur de Jour #}
        <div id="day-selector-container" class="d-flex align-items-center">
            <label for="day-date-select" class="form-label mb-0 me-2">Jour :</label>
            <input type="date" id="day-date-select" class="form-control form-control-sm" style="width: auto;" onchange="changeCalendarView(event)">
            <div class="btn-group btn-group-sm ms-2" role="group">
                <button type="button" class="btn btn-outline-secondary" id="prev-day-btn" title="Jour précédent"><i class="bi bi-chevron-left"></i></button>
                <button type="button" class="btn btn-outline-secondary" id="next-day-btn" title="Jour suivant"><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <div class="ms-auto align-self-center"> {# Le bouton Mémoriser est maintenant ici #}
         <button type="button" class="btn btn-outline-primary btn-sm" id="btn-save-default-view" title="Enregistrer la vue actuelle comme affichage par défaut">
             <i class="bi bi-star me-1"></i> Mémoriser cette vue
         </button>
    </div>
{% endif %}
        </div>

        {% if user_has_permission('control:view_calendar') %}
        <div id="calendar-container">
            <p>Chargement du calendrier...</p>
        </div>
        {% else %}
        <p><em>Vous n'avez pas la permission de voir le calendrier.</em></p>
        {% endif %}
    </div>

    <!-- Fenêtre Modale (initialement cachée) -->
    <div id="modal-overlay" class="modal-overlay" onclick="if (event.target === this) { closeModal(); }">
        <div id="modal-box" class="modal-box">
            <button id="modal-close-btn" class="modal-close-btn" onclick="closeModal()">×</button>
            <div id="modal-content">
                <p>Chargement des détails...</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }} {# Important si base.html a des scripts dans son bloc scripts #}
    <script>
// --- Variables Globales pour control.html ---
let currentStatus = { alert_active: false, alert_type: null };
let configSettings = { alert_files: { ppms: null, attentat: null } };

// --- Fonctions Utilitaires ---
function getISOWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7; // Remapper Dimanche (0) à 7
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}
let selectedAcademicYear; // Sera initialisée par getDefaultAcademicYear dans DOMContentLoaded
let selectedCalendarView = 'year'; // Valeur par défaut
let selectedMonth = new Date().getMonth() + 1; // Mois actuel par défaut (1-12)
let selectedWeekStartDate = null; // Stockera l'objet Date du début de la semaine sélectionnée
let selectedSpecificDay = null; // Stockera l'objet Date du jour sélectionné
let selectedSemester = 1; // 1 pour S1, 2 pour S2
let selectedTrimester = 1; // 1, 2, ou 3

// --- NOUVELLE Fonction pour appliquer la préférence de VUE UNIQUEMENT ---
function applyUserDefaultView(viewPreference) {
    if (viewPreference) {
        console.log(`[control.html] Préférence de vue trouvée: "${viewPreference}". Application.`);
        selectedCalendarView = viewPreference;
        const viewSelect = document.getElementById('calendar-view-type-select');
        if (viewSelect) {
            viewSelect.value = selectedCalendarView;
        }
    } else {
        console.log("[control.html] Aucune préférence de vue, utilisation de la vue par défaut (Annuelle).");
        selectedCalendarView = 'year'; // Définir la vue par défaut si aucune n'est sauvegardée
        const viewSelect = document.getElementById('calendar-view-type-select');
        if (viewSelect) { // S'assurer de mettre à jour le sélecteur aussi pour la vue par défaut
            viewSelect.value = selectedCalendarView;
        }
    }
    // Les variables de période (selectedAcademicYear, selectedMonth, etc.)
    // seront initialisées à leur valeur par défaut (basée sur la date actuelle)
    // dans la fonction changeCalendarView().
    // selectedAcademicYear est déjà initialisé par getDefaultAcademicYear() plus tôt.
    // Les autres (selectedMonth, selectedWeekStartDate, selectedSpecificDay) seront gérés
    // par la logique interne de changeCalendarView() qui s'assure qu'ils ont des valeurs
    // par défaut appropriées pour la vue sélectionnée (souvent basées sur la date actuelle).
    console.log("[control.html applyUserDefaultView] FIN - selectedCalendarView:", selectedCalendarView);
}


// Variables pour la logique d'alerte
let ppmsClickTimer = null;
let attentatClickTimer = null;
let endAlertClickTimer = null;
const DBL_CLICK_DELAY = 300;
let btnAlertPpms, btnAlertAttentat, btnEndAlert; // Seront initialisées dans DOMContentLoaded

// --- Fonctions Utilitaires Existantes (Calendrier, Modale, Feedback - CONSERVER CELLES-CI) ---
function getDefaultAcademicYear() {
    const now = new Date(); const currentYear = now.getFullYear(); const currentMonth = now.getMonth();
    const startYear = (currentMonth < 8) ? currentYear - 1 : currentYear;
    return `${startYear}-${startYear + 1}`;
}

function populateAcademicYearSelector() {
    const selectElement = document.getElementById('academic-year-select'); if (!selectElement) return; selectElement.innerHTML = '';
    const currentStartYear = parseInt(selectedAcademicYear.split('-')[0]); const yearsToShow = 3;
    for (let i = -yearsToShow; i <= yearsToShow; i++) {
        const startYear = currentStartYear + i; const yearString = `${startYear}-${startYear + 1}`;
        const option = document.createElement('option'); option.value = yearString; option.textContent = yearString; selectElement.appendChild(option);
    } selectElement.value = selectedAcademicYear;
}

function populateMonthSelector(academicYear) {
    const monthSelect = document.getElementById('month-select');
    if (!monthSelect) return;
    monthSelect.innerHTML = ''; // Vider les options existantes
    const [startYear, endYear] = academicYear.split('-').map(Number);

    const moisNoms = ["Septembre", "Octobre", "Novembre", "Décembre", "Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août"];
    const moisValeurs = [9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8]; // Numéros de mois (1-12)

    for (let i = 0; i < 12; i++) {
        const option = document.createElement('option');
        option.value = moisValeurs[i]; // Utiliser le numéro du mois comme valeur
        let anneePourCeMois = (moisValeurs[i] >= 9) ? startYear : endYear;
        option.textContent = `${moisNoms[i]} ${anneePourCeMois}`;
        monthSelect.appendChild(option);
    }

    // Sélectionner le mois actuel par défaut si possible, ou le premier mois
    const now = new Date();
    const currentRealMonth = now.getMonth() + 1; // Mois réel (1-12)
    const currentRealYear = now.getFullYear();
    let defaultMonthSelected = false;

    // Tenter de sélectionner le mois en cours de l'année en cours si elle fait partie de l'année scolaire
    if ((currentRealMonth >= 9 && currentRealYear === startYear) || (currentRealMonth <= 8 && currentRealYear === endYear)) {
        monthSelect.value = currentRealMonth;
        selectedMonth = currentRealMonth; // Mettre à jour la variable globale
        defaultMonthSelected = true;
    }

    if (!defaultMonthSelected) { // Sinon, sélectionner le premier mois de la liste (Septembre)
        if (monthSelect.options.length > 0) { // S'assurer qu'il y a des options
            monthSelect.value = moisValeurs[0]; // Septembre
            selectedMonth = moisValeurs[0];
        }
    }
}

function closeModal() {
    const modalOverlay = document.getElementById('modal-overlay'); if (modalOverlay) { modalOverlay.classList.remove('visible'); setTimeout(() => { const mc = document.getElementById('modal-content'); if (mc) mc.innerHTML = '<p>Chargement...</p>'; }, 300); }
}

function showFeedback(message, type = 'info', duration = 4000) {
    const feedbackDiv = document.getElementById('control-message');
    if (!feedbackDiv) {
        console.error("Élément #control-message introuvable pour le feedback.");
        return;
    }
    feedbackDiv.textContent = message;
    feedbackDiv.classList.remove('success', 'error', 'info', 'show'); // Nettoyer anciennes classes
    feedbackDiv.classList.add(type); // Ajouter le type de message (success, error, info)
    feedbackDiv.style.display = 'block'; // Assurer la visibilité
    void feedbackDiv.offsetWidth; // Forcer un reflow pour que l'animation CSS prenne effet
    feedbackDiv.classList.add('show'); // Ajouter la classe 'show' pour l'animation d'apparition

    setTimeout(() => {
        feedbackDiv.classList.remove('show'); // Retirer 'show' pour l'animation de disparition
        setTimeout(() => {
            // S'assurer que le display:none n'est appliqué que si 'show' n'a pas été rajouté entre-temps
            if (!feedbackDiv.classList.contains('show')) {
               feedbackDiv.style.display = 'none';
            }
        }, 500); // Laisser le temps à l'animation de disparition de se terminer (doit correspondre à la durée de transition CSS)
    }, duration);
}

// --- NOUVELLES Fonctions Calendrier ---
function changeCalendarView(event) {
    console.clear(); // Nettoyer la console pour voir clairement les logs de cette exécution
    console.log("--- Début Exécution changeCalendarView ---");

    // --- ÉTAPE 1: RÉCUPÉRATION DES ÉLÉMENTS ---
    const viewSelect = document.getElementById('calendar-view-type-select');
    const academicYearSelectorContainer = document.getElementById('academic-year-selector-container');
    const semesterSelectorContainer = document.getElementById('semester-selector-container');
    const trimesterSelectorContainer = document.getElementById('trimester-selector-container');
    const monthSelectorContainer = document.getElementById('month-selector-container');
    const weekSelectorContainer = document.getElementById('week-selector-container');
    const daySelectorContainer = document.getElementById('day-selector-container');

    // Afficher dans une table si les conteneurs ont été trouvés ou non
    console.table({
        viewSelect: !!viewSelect,
        academicYearContainer: !!academicYearSelectorContainer,
        semesterContainer: !!semesterSelectorContainer,
        trimesterContainer: !!trimesterSelectorContainer,
        monthContainer: !!monthSelectorContainer,
        weekContainer: !!weekSelectorContainer,
        dayContainer: !!daySelectorContainer
    });

    // Si un des conteneurs est 'false' dans la table, l'ID dans le HTML est incorrect.

    const allPeriodSelectors = [
        academicYearSelectorContainer, semesterSelectorContainer, trimesterSelectorContainer,
        monthSelectorContainer, weekSelectorContainer, daySelectorContainer
    ];

    // Récupération des inputs/selects internes (pour la logique de mise à jour des variables globales)
    const yearSelect = document.getElementById('academic-year-select');
    const semesterSelect = document.getElementById('semester-select');
    const trimesterSelect = document.getElementById('trimester-select');
    const monthSelect = document.getElementById('month-select');
    const weekDateSelect = document.getElementById('week-date-select');
    const dayDateSelect = document.getElementById('day-date-select');
    const calendarTitleSpan = document.getElementById('calendar-title-year');


    // Vérification rapide que les éléments principaux existent (viewSelect et calendarTitleSpan)
    if (!viewSelect || !calendarTitleSpan) {
        console.error("Éléments de base du calendrier manquants (viewSelect ou calendarTitleSpan). Arrêt de la fonction.");
        console.log("--- Fin Exécution changeCalendarView (Erreur) ---");
        return;
    }

    const previousSelectedView = selectedCalendarView; // Garder en mémoire l'ancienne vue
    if (viewSelect) selectedCalendarView = viewSelect.value; // Mettre à jour la vue globale

    const eventSourceId = event ? event.target.id : null;
    const previousAcademicYear = selectedAcademicYear;
    if (yearSelect) selectedAcademicYear = yearSelect.value; // Mettre à jour l'année globale


    // --- ÉTAPE 2: MASQUAGE SYSTÉMATIQUE ---
    console.log("Étape 2: Masquage de tous les sélecteurs de période via la classe .d-none...");
    allPeriodSelectors.forEach(container => {
        if (container) {
            // Assure-toi qu'ils ont .d-flex (pour quand on les montrera) et .d-none (pour les cacher)
            // On va juste ajouter .d-none.
            container.classList.add('d-none');
            // On pourrait aussi vouloir retirer .d-flex mais ce n'est pas nécessaire si .d-none l'emporte.
        }
    });

    // --- ÉTAPE 3: DÉTERMINATION DE LA VUE ET AFFICHAGE ---
    // selectedCalendarView est déjà mis à jour à partir de viewSelect.value plus haut
    console.log(`Étape 3: Vue sélectionnée = "${selectedCalendarView}". Application de la logique d'affichage...`);

    switch (selectedCalendarView) {
        case 'year':
            if (academicYearSelectorContainer) academicYearSelectorContainer.classList.remove('d-none');
            // selectedAcademicYear est déjà à jour
            break;
        case 'semester':
            if (academicYearSelectorContainer) academicYearSelectorContainer.classList.remove('d-none');
            if (semesterSelectorContainer) semesterSelectorContainer.classList.remove('d-none');
            if (semesterSelect) selectedSemester = parseInt(semesterSelect.value);
            break;
        case 'trimester':
            if (academicYearSelectorContainer) academicYearSelectorContainer.classList.remove('d-none');
            if (trimesterSelectorContainer) trimesterSelectorContainer.classList.remove('d-none');
            if (trimesterSelect) selectedTrimester = parseInt(trimesterSelect.value);
            break;
        case 'month':
            if (academicYearSelectorContainer) academicYearSelectorContainer.classList.remove('d-none');
            if (monthSelectorContainer) monthSelectorContainer.classList.remove('d-none');
            if (monthSelect) {
                if (eventSourceId === 'calendar-view-type-select' || previousAcademicYear !== selectedAcademicYear || !monthSelect.options.length || typeof selectedMonth === 'undefined') {
                    populateMonthSelector(selectedAcademicYear);
                }
                selectedMonth = parseInt(monthSelect.value);
            }
            break;
        case 'week':
            if (weekSelectorContainer) weekSelectorContainer.classList.remove('d-none');
            if (weekDateSelect) {
                if (eventSourceId === 'week-date-select') {
                    if (weekDateSelect.valueAsDate) {
                        selectedWeekStartDate = new Date(weekDateSelect.valueAsDate.valueOf());
                    } else if (weekDateSelect.value === '') {
                        selectedWeekStartDate = new Date();
                    }
                } else if (eventSourceId === 'calendar-view-type-select' || !selectedWeekStartDate || previousSelectedView !== 'week') {
                    if (!weekDateSelect.value || previousSelectedView !== 'week') {
                        selectedWeekStartDate = new Date();
                    } else if (weekDateSelect.valueAsDate) {
                        selectedWeekStartDate = new Date(weekDateSelect.valueAsDate.valueOf());
                    } else {
                        selectedWeekStartDate = new Date();
                    }
                }
                if (!selectedWeekStartDate) selectedWeekStartDate = new Date();
                weekDateSelect.value = selectedWeekStartDate.toISOString().split('T')[0];
            }
            break;
        case 'day':
            if (daySelectorContainer) daySelectorContainer.classList.remove('d-none');
            if (dayDateSelect) {
                if (eventSourceId === 'day-date-select') {
                    if (dayDateSelect.valueAsDate) {
                        selectedSpecificDay = new Date(dayDateSelect.valueAsDate.valueOf());
                    } else if (dayDateSelect.value === '') {
                        selectedSpecificDay = new Date();
                    }
                } else if (eventSourceId === 'calendar-view-type-select' || !selectedSpecificDay || previousSelectedView !== 'day') {
                    if (!dayDateSelect.value || previousSelectedView !== 'day') {
                        selectedSpecificDay = new Date();
                    } else if (dayDateSelect.valueAsDate) {
                        selectedSpecificDay = new Date(dayDateSelect.valueAsDate.valueOf());
                    } else {
                        selectedSpecificDay = new Date();
                    }
                }
                if (!selectedSpecificDay) selectedSpecificDay = new Date();
                dayDateSelect.value = selectedSpecificDay.toISOString().split('T')[0];
            }
            break;
        default:
            console.error(`Cas non traité dans le switch pour la vue: "${selectedCalendarView}"`);
    }

    // --- VÉRIFICATION FINALE ---
    console.log("Vérification finale des classes des conteneurs :");
    allPeriodSelectors.forEach(container => {
        if (container && container.id) { // Vérifier que l'ID existe
             console.log(`- ${container.id}: contient .d-none ? ${container.classList.contains('d-none')}`);
        }
    });

    // Le reste de la fonction (mise à jour des variables, du titre, et appel à showSelectedCalendarView)
    // doit suivre ici.
    console.log(`[FIN changeCalendarView - AVANT MàJ TITRE ET APPEL showSelectedCalendarView] Vue: ${selectedCalendarView}, Année: ${selectedAcademicYear}, Semestre: ${selectedSemester}, Trimestre: ${selectedTrimester}, Mois: ${selectedMonth}, Semaine Début: ${selectedWeekStartDate ? selectedWeekStartDate.toISOString().split('T')[0] : 'null'}, Jour Spécifique: ${selectedSpecificDay ? selectedSpecificDay.toISOString().split('T')[0] : 'null'}`);

    if (calendarTitleSpan) {
        if (selectedCalendarView === 'year') {
            calendarTitleSpan.textContent = `Scolaire ${selectedAcademicYear}`;
        } else if (selectedCalendarView === 'semester' && selectedAcademicYear) {
            calendarTitleSpan.textContent = `Semestre ${selectedSemester} (${selectedAcademicYear})`;
        } else if (selectedCalendarView === 'trimester' && selectedAcademicYear) {
            calendarTitleSpan.textContent = `Trimestre ${selectedTrimester} (${selectedAcademicYear})`;
        } else if (selectedCalendarView === 'month') {
            const monthName = monthSelect && monthSelect.options.length > 0 && monthSelect.selectedIndex !== -1 ? monthSelect.options[monthSelect.selectedIndex].text : `Mois ${selectedMonth}`;
            calendarTitleSpan.textContent = `${monthName}`;
        } else if (selectedCalendarView === 'week') {
            if (selectedWeekStartDate) {
                const weekInfoDisplay = document.getElementById('week-info-display');
                let mondayOfSelectedWeek = new Date(selectedWeekStartDate.valueOf());
                let dayOfWeek = mondayOfSelectedWeek.getDay();
                let diffToMonday = mondayOfSelectedWeek.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                mondayOfSelectedWeek.setDate(diffToMonday);

                const sundayOfSelectedWeek = new Date(mondayOfSelectedWeek.valueOf());
                sundayOfSelectedWeek.setDate(mondayOfSelectedWeek.getDate() + 6);
                const weekNumber = getISOWeekNumber(mondayOfSelectedWeek);

                const titleText = `Sem. ${weekNumber} (du ${mondayOfSelectedWeek.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'})} au ${sundayOfSelectedWeek.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'})} ${mondayOfSelectedWeek.getFullYear()})`;
                
                if (weekInfoDisplay) weekInfoDisplay.textContent = titleText;
                calendarTitleSpan.textContent = titleText;
            } else {
                calendarTitleSpan.textContent = "Hebdomadaire (date non définie)";
            }
        } else if (selectedCalendarView === 'day') {
            if (selectedSpecificDay) {
                calendarTitleSpan.textContent = `Jour du ${selectedSpecificDay.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            } else {
                calendarTitleSpan.textContent = "Journalier (date non définie)";
            }
        } else {
            calendarTitleSpan.textContent = selectedAcademicYear || new Date().getFullYear();
        }
    }
    showSelectedCalendarView();

    console.log("--- Fin Exécution changeCalendarView ---");
}

function showSelectedCalendarView() {
    console.log(`Affichage calendrier pour vue: ${selectedCalendarView}, année: ${selectedAcademicYear}, mois: ${selectedMonth}, semaine: ${selectedWeekStartDate}, jour: ${selectedSpecificDay}`);
    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) return;

    calendarContainer.innerHTML = '<p>Chargement de la vue du calendrier...</p>';
    let apiUrl = '';

    if (selectedCalendarView === 'year') {
        // Utiliser l'API et la fonction de génération existantes pour la vue annuelle
        apiUrl = `/api/calendar_view?year=${selectedAcademicYear}`; // API existante
        console.log(`Appel API calendrier (year view): ${apiUrl}`);
        fetch(apiUrl)
            .then(response => {
                console.log(`Réponse ${apiUrl}, statut: ${response.status}`);
                if (!response.ok) {
                    return response.json().then(err => {throw new Error(`Erreur HTTP ${response.status}: ${err.error||response.statusText}`)}).catch(() => {throw new Error(`Erreur HTTP ${response.status}`)});
                }
                return response.json();
            })
            .then(data => {
                console.log("[Calendar Year View] Données API:", data);
                if (data.error) {
                    throw new Error(`Erreur API calendrier: ${data.error}`);
                }
                console.log("Appel generateCalendar:", data);
                generateCalendar(data, selectedAcademicYear); // Fonction existante pour la vue annuelle
                console.log("generateCalendar exécuté pour la vue annuelle.");
            })
            .catch(error => {
                console.error("Erreur showSelectedCalendarView (year):", error);
                if (calendarContainer) calendarContainer.innerHTML = `<p>Erreur chargement vue annuelle: ${error.message}</p>`;
            });
    } else if (selectedCalendarView === 'month') {
        // S'assurer que selectedMonth est bien défini et est un nombre
        if (typeof selectedMonth !== 'number' && document.getElementById('month-select')) {
            const monthValue = parseInt(document.getElementById('month-select').value);
            if (!isNaN(monthValue)) {
                selectedMonth = monthValue;
            } else {
                console.error("selectedMonth n'a pas pu être déterminé à partir du sélecteur.");
                if (typeof selectedMonth !== 'number') { // Fallback
                    selectedMonth = new Date().getMonth() + 1;
                }
            }
        } else if (typeof selectedMonth !== 'number') {
            console.warn("selectedMonth est indéfini et le sélecteur de mois n'est pas disponible. Utilisation du mois actuel.");
            selectedMonth = new Date().getMonth() + 1; // Fallback ultime
        }

        apiUrl = `/api/calendar_view?year=${selectedAcademicYear}&month=${selectedMonth}&view_type=month`;
        console.log(`API call for Monthly view: ${apiUrl}`);
        calendarContainer.innerHTML = `<p>Chargement de la vue mensuelle pour ${selectedAcademicYear}, Mois ${selectedMonth}...</p>`;

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {throw new Error(`Erreur HTTP ${response.status}: ${err.error||response.statusText}`)}).catch(() => {throw new Error(`Erreur HTTP ${response.status}`)});
                }
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(`Erreur API calendrier (mois): ${data.error}`);
                generateMonthCalendar(data, selectedAcademicYear, selectedMonth);
            })
            .catch(error => {
                console.error("Erreur showSelectedCalendarView (month):", error);
                calendarContainer.innerHTML = `<p>Erreur chargement vue mensuelle: ${error.message}</p>`;
            });
    } else if (selectedCalendarView === 'semester') {
        apiUrl = `/api/calendar_view?year=${selectedAcademicYear}&semester=${selectedSemester}&view_type=semester`;
        console.log(`API call for Semester view: ${apiUrl}`);
        calendarContainer.innerHTML = `<p>Chargement de la vue semestrielle pour ${selectedAcademicYear}, Semestre ${selectedSemester}...</p>`;

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    // Essayer de lire le corps de l'erreur JSON si possible
                    return response.json().then(err => {throw new Error(`Erreur HTTP ${response.status}: ${err.error || response.statusText}`)}).catch(() => {throw new Error(`Erreur HTTP ${response.status}`)});
                }
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(`Erreur API calendrier (semestre): ${data.error}`);
                generateSemesterView(data, selectedAcademicYear, selectedSemester); // APPEL À LA NOUVELLE FONCTION
            })
            .catch(error => {
                console.error("Erreur showSelectedCalendarView (semester):", error);
                calendarContainer.innerHTML = `<p>Erreur chargement vue semestrielle: ${error.message}</p>`;
            });
    } else if (selectedCalendarView === 'trimester') {
        apiUrl = `/api/calendar_view?year=${selectedAcademicYear}&trimester=${selectedTrimester}&view_type=trimester`;
        console.log(`API call for Trimester view: ${apiUrl}`);
        calendarContainer.innerHTML = `<p>Chargement de la vue trimestrielle pour ${selectedAcademicYear}, Trimestre ${selectedTrimester}...</p>`;

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    // Essayer de lire le corps de l'erreur JSON si possible
                    return response.json().then(err => {throw new Error(`Erreur HTTP ${response.status}: ${err.error || response.statusText}`)}).catch(() => {throw new Error(`Erreur HTTP ${response.status}`)});
                }
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(`Erreur API calendrier (trimestre): ${data.error}`);
                generateTrimesterView(data, selectedAcademicYear, selectedTrimester); // APPEL À LA NOUVELLE FONCTION
            })
            .catch(error => {
                console.error("Erreur showSelectedCalendarView (trimester):", error);
                calendarContainer.innerHTML = `<p>Erreur chargement vue trimestrielle: ${error.message}</p>`;
            });
    } else if (selectedCalendarView === 'week') {
        if (!selectedWeekStartDate) {
            calendarContainer.innerHTML = "<p>Veuillez sélectionner une date pour la vue hebdomadaire.</p>";
            return;
        }
        // Calculer le début (Lundi) et la fin (Dimanche) de la semaine
        let dayOfWeek = selectedWeekStartDate.getDay(); // 0=Dim, 1=Lun, ..., 6=Sam
        let diffToMonday = selectedWeekStartDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajuster pour Lundi
        let mondayOfSelectedWeek = new Date(new Date(selectedWeekStartDate).setDate(diffToMonday)); // Crée une nouvelle instance pour ne pas modifier selectedWeekStartDate
        let sundayOfSelectedWeek = new Date(new Date(mondayOfSelectedWeek).setDate(mondayOfSelectedWeek.getDate() + 6)); // Not strictly needed for API call if backend handles 7 days

        const startDateStr = mondayOfSelectedWeek.toISOString().split('T')[0]; // YYYY-MM-DD

        // Utiliser /api/calendar_view comme pour les autres vues, maintenant qu'il supporte 'week'
        // Le backend s'attend à 'start_date' et 'view_type=week'.
        // 'year' pourrait être utile au backend pour un contexte, même si start_date est absolu.
        apiUrl = `/api/calendar_view?start_date=${startDateStr}&view_type=week&year=${selectedAcademicYear}`;

        console.log(`API call for Weekly view: ${apiUrl}`);
        calendarContainer.innerHTML = `<p>Chargement de la vue hebdomadaire pour la semaine du ${mondayOfSelectedWeek.toLocaleDateString('fr-FR')}...</p>`;

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                     return response.json().then(err => {throw new Error(`Erreur HTTP ${response.status}: ${err.error||response.statusText}`)}).catch(() => {throw new Error(`Erreur HTTP ${response.status}`)});
                }
                return response.json();
            })
            .then(data => {
                console.log("[control.html] Données pour vue hebdomadaire reçues:", data);
                if (data.error) { // Vérifier si l'API elle-même a renvoyé une erreur dans le JSON
                    throw new Error(`Erreur API calendrier (semaine): ${data.error}`);
                }
                // La structure attendue de 'data' est { days: { "YYYY-MM-DD": dayData, ... } }
                // comme pour les autres appels à /api/calendar_view
                const daysDataForWeek = data.days;
                if (!daysDataForWeek) {
                    throw new Error("Format de données incorrect pour la vue hebdomadaire: 'days' manquant.");
                }
                generateWeekView(daysDataForWeek, mondayOfSelectedWeek);
            })
            .catch(error => {
                console.error("Erreur showSelectedCalendarView (week):", error);
                calendarContainer.innerHTML = `<p>Erreur chargement vue hebdomadaire: ${error.message}</p>`;
            });
    } else if (selectedCalendarView === 'day') {
        if (!selectedSpecificDay) {
            calendarContainer.innerHTML = "<p>Veuillez sélectionner une date pour la vue journalière.</p>";
            return;
        }
        const dateStr = selectedSpecificDay.toISOString().split('T')[0]; // YYYY-MM-DD
        apiUrl = `/api/daily_schedule?date=${dateStr}`;

        console.log(`API call for Daily view: ${apiUrl}`);
        calendarContainer.innerHTML = `<p>Chargement de la vue journalière pour le ${selectedSpecificDay.toLocaleDateString('fr-FR')}...</p>`;

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    // Essayer de lire le corps de l'erreur JSON si possible
                    return response.json().catch(() => null).then(err => {throw new Error(`Erreur HTTP ${response.status}: ${err.error || err.message || response.statusText}`)}).catch(() => {throw new Error(`Erreur HTTP ${response.status}`)});
                }
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(`Erreur API calendrier (jour): ${data.error}`);
                console.log("[control.html] Données pour vue journalière reçues:", data);
                generateDayView(data, selectedSpecificDay); // APPEL À LA NOUVELLE FONCTION
            })
            .catch(error => {
                console.error("Erreur showSelectedCalendarView (day):", error);
                calendarContainer.innerHTML = `<p>Erreur chargement vue journalière: ${error.message}</p>`;
            });
    } else {
        calendarContainer.innerHTML = `<p>Type de vue '${selectedCalendarView}' non supporté pour le moment.</p>`;
    }
}

// --- Fonctions Calendrier Existantes (celles qui restent) ---
// La fonction showCalendar() a été supprimée car sa logique est maintenant dans showSelectedCalendarView() et changeCalendarView().

function generateDayView(dayApiData, dateObject) {
     console.log(`[control.html] generateDayView pour:`, dateObject.toLocaleDateString('fr-FR'), "avec données:", dayApiData);
     const calendarContainer = document.getElementById('calendar-container');
     if (!calendarContainer) { console.error("Conteneur #calendar-container introuvable !"); return; }
     calendarContainer.innerHTML = ''; // Vider le conteneur
     calendarContainer.className = 'calendar-day-view-container'; // Classe pour ciblage CSS optionnel

     if (!dayApiData) {
         calendarContainer.innerHTML = "<p>Aucune donnée reçue pour la vue journalière.</p>";
         console.error("generateDayView: Données API manquantes.", dayApiData);
         return;
     }

     // Créer la structure d'affichage pour un seul jour
     const dayViewDiv = document.createElement('div');
     dayViewDiv.className = 'card'; // Utiliser une carte pour un look cohérent

     const cardHeader = document.createElement('div');
     cardHeader.className = 'card-header text-center fs-5 fw-bold'; // fs-5 pour une police un peu plus grande
     // Formater la date : Jour de la semaine, JJ Mois AAAA
     const formattedDate = dateObject.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
     cardHeader.textContent = formattedDate;
     dayViewDiv.appendChild(cardHeader);

     const cardBody = document.createElement('div');
     cardBody.className = 'card-body';
     dayViewDiv.appendChild(cardBody);

     // Appliquer une couleur de fond basée sur dayApiData.day_type (similaire à generateWeekView)
     const typeLower = (dayApiData.day_type || '').toLowerCase().trim();
     let bgColorClass = '';
     if (typeLower.startsWith('exception (silence)')) { bgColorClass = 'bg-light text-muted'; }
     else if (typeLower.startsWith('exception (utiliser_jt')) { bgColorClass = 'bg-info-subtle'; }
     else if (typeLower === 'férié') { bgColorClass = 'bg-warning-subtle'; }
     else if (typeLower === 'vacances') { bgColorClass = 'bg-success-subtle'; }
     else if (dateObject.getDay() === 0) { bgColorClass = 'bg-danger-subtle'; } // Dimanche
     else if (dateObject.getDay() === 6) { bgColorClass = 'bg-secondary-subtle'; } // Samedi
     else if (typeLower.startsWith('classe')) { bgColorClass = 'bg-white';}
     else { bgColorClass = 'bg-light';}
     dayViewDiv.classList.add(bgColorClass); // Appliquer sur la carte entière

     // Afficher le type de jour / description
     const dayTypeInfo = document.createElement('p');
     dayTypeInfo.className = 'text-center fst-italic mb-3';
     dayTypeInfo.textContent = dayApiData.message || dayApiData.day_type || "Type de jour non spécifié";
     cardBody.appendChild(dayTypeInfo);

     // Afficher le planning des sonneries
     if (dayApiData.schedule && Array.isArray(dayApiData.schedule) && dayApiData.schedule.length > 0) {
         const scheduleTable = document.createElement('table');
         scheduleTable.className = 'table table-sm table-striped table-bordered'; // Table Bootstrap
         const thead = document.createElement('thead');
         thead.innerHTML = `<tr>
                              <th scope="col">Période</th>
                              <th scope="col">Début</th>
                              <th scope="col">Fin</th>
                              <th scope="col">Son. Début</th>
                              <th scope="col">Son. Fin</th>
                            </tr>`;
         scheduleTable.appendChild(thead);

         const tbody = document.createElement('tbody');
         const schedule = dayApiData.schedule;

         for (let i = 0; i < schedule.length; i += 2) {
             const periodStart = schedule[i];
             const periodEnd = (i + 1 < schedule.length) ? schedule[i+1] : null;

             const tr = document.createElement('tr');

             let periodName = "N/A";
             if (periodStart && periodStart.event) {
                 periodName = periodStart.event.replace(/^Début\s*/i, '').trim();
             }

             const heureDebutDisplay = (periodStart && periodStart.time && typeof periodStart.time === 'string')
                                     ? periodStart.time.substring(0,5)
                                     : '-';

             const heureFinDisplay = (periodEnd && periodEnd.time && typeof periodEnd.time === 'string')
                                   ? periodEnd.time.substring(0,5)
                                   : '-';

             let sonnerieDebutDisplay = '-';
             if (periodStart && periodStart.sonnerie && typeof periodStart.sonnerie === 'string' && periodStart.sonnerie.toLowerCase() !== 'aucune' && periodStart.sonnerie.toLowerCase() !== 'silence' && periodStart.sonnerie.trim() !== '') {
                 sonnerieDebutDisplay = periodStart.sonnerie.replace('.mp3', '');
             } else if (periodStart && periodStart.sonnerie && (periodStart.sonnerie.toLowerCase() === 'aucune' || periodStart.sonnerie.toLowerCase() === 'silence')) {
                 sonnerieDebutDisplay = '-'; // Explicitly set to '-' for "Aucune" or "Silence"
             }

             let sonnerieFinDisplay = '-';
             if (periodEnd && periodEnd.sonnerie && typeof periodEnd.sonnerie === 'string' && periodEnd.sonnerie.toLowerCase() !== 'aucune' && periodEnd.sonnerie.toLowerCase() !== 'silence' && periodEnd.sonnerie.trim() !== '') {
                 sonnerieFinDisplay = periodEnd.sonnerie.replace('.mp3', '');
             } else if (periodEnd && periodEnd.sonnerie && (periodEnd.sonnerie.toLowerCase() === 'aucune' || periodEnd.sonnerie.toLowerCase() === 'silence')) {
                 sonnerieFinDisplay = '-'; // Explicitly set to '-' for "Aucune" or "Silence"
             }

             // Basic check for pair consistency (optional, but good for robustness)
             // This is a simple check, could be made more robust
             if (periodEnd && periodStart.event && periodEnd.event) {
                 const startEventName = periodStart.event.replace(/^Début\s*/i, '').trim();
                 const endEventName = periodEnd.event.replace(/^Fin\s*/i, '').trim();
                 if (startEventName !== endEventName) {
                     console.warn(`Possible mismatch between Start/End events: ${periodStart.event} and ${periodEnd.event}`);
                     // Potentially alter display or add a visual cue if mismatched
                 }
             } else if (periodStart && !periodEnd && schedule.length % 2 !== 0 && i === schedule.length -1 ) {
                 // This is the last event and it's an odd one out (likely a start without an end)
                 console.warn(`Orphaned start event found: ${periodStart.event}`);
                 // heureFinDisplay, sonnerieFinDisplay will remain '-'
             }


             tr.innerHTML = `
                 <td>${periodName}</td>
                 <td>${heureDebutDisplay}</td>
                 <td>${heureFinDisplay}</td>
                 <td>${sonnerieDebutDisplay}</td>
                 <td>${sonnerieFinDisplay}</td>
             `;
             tbody.appendChild(tr);
         }
         scheduleTable.appendChild(tbody);
         cardBody.appendChild(scheduleTable);
     } else {
         const noScheduleMsg = document.createElement('p');
         noScheduleMsg.className = 'text-center text-muted';
         noScheduleMsg.textContent = "Aucun planning de sonneries pour ce jour.";
         cardBody.appendChild(noScheduleMsg);
     }
     calendarContainer.appendChild(dayViewDiv);
     console.log("[control.html] Fin de generateDayView");
 }

function generateSemesterView(apiResponseData, academicYearString, semesterNumber) {
    console.log(`generateSemesterView pour Année: ${academicYearString}, Semestre: ${semesterNumber}`);
    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) { console.error("Conteneur #calendar-container introuvable !"); return; }
    calendarContainer.innerHTML = '';

    if (!apiResponseData || !apiResponseData.days) {
        calendarContainer.innerHTML = "<p>Aucune donnée reçue pour la vue semestrielle.</p>";
        return;
    }

    const [startYear, endYear] = academicYearString.split('-').map(Number);
    const daysDataFromApi = apiResponseData.days;

    let monthsToDisplay = []; // Array de {month: (1-12), year: YYYY}
    if (semesterNumber === 1) { // S1: Sept, Oct, Nov, Déc (start_year), Jan, Fev (end_year)
        monthsToDisplay = [
            {month: 9, year: startYear}, {month: 10, year: startYear},
            {month: 11, year: startYear}, {month: 12, year: startYear},
            {month: 1, year: endYear}, {month: 2, year: endYear} // CHANGEMENT ICI
        ];
    } else if (semesterNumber === 2) { // S2: Mar, Avr, Mai, Jui, Jul, Aoû (end_year)
        monthsToDisplay = [
            {month: 3, year: endYear}, {month: 4, year: endYear},
            {month: 5, year: endYear}, {month: 6, year: endYear},
            {month: 7, year: endYear}, {month: 8, year: endYear} // CHANGEMENT ICI
        ];
    } else {
        calendarContainer.innerHTML = "<p>Numéro de semestre invalide.</p>";
        return;
    }

    const today = new Date();
    const currentDayNum = today.getDate();
    const currentMonthNum = today.getMonth() + 1;
    const currentYearToday = today.getFullYear();
    const todayStr = `${currentYearToday}-${String(currentMonthNum).padStart(2, '0')}-${String(currentDayNum).padStart(2, '0')}`;

    for (const monthInfo of monthsToDisplay) {
        const monthForLoop = monthInfo.month;
        const yearForLoop = monthInfo.year;

        const monthDiv = document.createElement('div');
        monthDiv.classList.add('calendar-month');
        const monthDateObject = new Date(yearForLoop, monthForLoop - 1, 1);
        const monthName = monthDateObject.toLocaleString('fr-FR', { month: 'long' });
        monthDiv.innerHTML = `<h3>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${yearForLoop}</h3>`;
        const daysInCurrentMonth = new Date(yearForLoop, monthForLoop, 0).getDate();
        const firstDayWeekdayOffset = (monthDateObject.getDay() + 6) % 7;
        const daysGridContainer = document.createElement('div');
        daysGridContainer.classList.add('calendar-days');
        const weekDayLabels = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
        weekDayLabels.forEach(wdText => { const wdCell = document.createElement('div'); wdCell.classList.add('calendar-weekday'); wdCell.textContent = wdText; daysGridContainer.appendChild(wdCell); });
        for (let i = 0; i < firstDayWeekdayOffset; i++) { const emptyCell = document.createElement('div'); emptyCell.classList.add('calendar-day', 'empty'); daysGridContainer.appendChild(emptyCell); }

        for (let dayNum = 1; dayNum <= daysInCurrentMonth; dayNum++) {
            const dayCell = document.createElement('div');
            dayCell.classList.add('calendar-day');
            dayCell.textContent = dayNum;
            const currentDateObject = new Date(yearForLoop, monthForLoop - 1, dayNum);
            const dateKey = `${yearForLoop}-${String(monthForLoop).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
            const dayData = daysDataFromApi[dateKey];
            const dayOfWeek = currentDateObject.getDay();
            let cssClass = '';
            let tooltipText = '';
            if (dateKey === todayStr) dayCell.classList.add('today');
            if (dayData) {
                const typeValue = dayData.type || 'ERREUR';
                const typeLower = typeValue.toLowerCase().trim();
                tooltipText = dayData.description || typeValue;
                if (typeLower.startsWith('exception (silence)')) { cssClass = 'exception-silence'; }
                else if (typeLower.startsWith('exception (utiliser_jt')) { cssClass = 'exception-jt'; }
                else if (typeLower === 'férié') { cssClass = 'ferie'; }
                else if (typeLower === 'vacances') { cssClass = 'vacances'; }
                else if (dayOfWeek === 0) { cssClass = 'weekend-dimanche'; if (!dayData.description && !typeLower.startsWith('classe')) tooltipText = "Dimanche"; }
                else if (dayOfWeek === 6) { cssClass = 'weekend-samedi'; if (!dayData.description && !typeLower.startsWith('classe')) tooltipText = "Samedi"; }
                else if (typeLower.startsWith('classe')) { cssClass = 'classe'; }
                else if (typeLower === 'weekend') { cssClass = (dayOfWeek === 0) ? 'weekend-dimanche' : (dayOfWeek === 6 ? 'weekend-samedi' : 'classe'); console.warn(`Jour ${dateKey} marqué 'weekend' par backend mais dayOfWeek=${dayOfWeek}. Appliqué: ${cssClass}`);}
                else if (typeLower === 'autre' || typeLower.includes('erreur')) { cssClass = 'erreur-donnees'; console.warn(`Type jour 'Autre' ou 'Erreur': '${typeValue}' pour ${dateKey}`);}
                else { cssClass = 'erreur-donnees'; console.error(`Type jour INCONNU du backend: '${typeValue}' pour ${dateKey}`);}
            } else {
                if (dayOfWeek === 0) { cssClass = 'weekend-dimanche'; tooltipText = "Dimanche"; }
                else if (dayOfWeek === 6) { cssClass = 'weekend-samedi'; tooltipText = "Samedi"; }
                else { cssClass = 'classe'; tooltipText = "Jour de classe (par défaut)"; }
            }
            if (cssClass) dayCell.classList.add(cssClass);
            dayCell.title = tooltipText;
            dayCell.style.cursor = 'pointer';
            dayCell.onclick = () => showDailySchedule(currentDateObject.getFullYear(), currentDateObject.getMonth() + 1, dayNum);
            daysGridContainer.appendChild(dayCell);
        }
        monthDiv.appendChild(daysGridContainer);
        calendarContainer.appendChild(monthDiv);
    }
    console.log("Fin de generateSemesterView");
}

function generateTrimesterView(apiResponseData, academicYearString, trimesterNumber) {
    console.log(`generateTrimesterView pour Année: ${academicYearString}, Trimestre: ${trimesterNumber}`);
    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) { console.error("Conteneur #calendar-container introuvable !"); return; }
    calendarContainer.innerHTML = ''; // Vider le conteneur

    if (!apiResponseData || !apiResponseData.days) {
        calendarContainer.innerHTML = "<p>Aucune donnée reçue pour la vue trimestrielle.</p>";
        console.error("generateTrimesterView: Données API manquantes ou incorrectes.", apiResponseData);
        return;
    }

    const [startYear, endYear] = academicYearString.split('-').map(Number);
    const daysDataFromApi = apiResponseData.days; // Contient les jours UNIQUEMENT pour ce trimestre

    let monthsToDisplay = []; // Array de {month: (1-12), year: YYYY}
    if (trimesterNumber === 1) {
        monthsToDisplay = [{month: 9, year: startYear}, {month: 10, year: startYear}, {month: 11, year: startYear}, {month: 12, year: startYear}];
    } else if (trimesterNumber === 2) {
        monthsToDisplay = [{month: 1, year: endYear}, {month: 2, year: endYear}, {month: 3, year: endYear}, {month: 4, year: endYear}];
    } else if (trimesterNumber === 3) {
        monthsToDisplay = [{month: 5, year: endYear}, {month: 6, year: endYear}, {month: 7, year: endYear}, {month: 8, year: endYear}];
    } else {
        calendarContainer.innerHTML = "<p>Numéro de trimestre invalide.</p>";
        console.error("generateTrimesterView: Numéro de trimestre invalide:", trimesterNumber);
        return;
    }

    const today = new Date();
    const currentDayNum = today.getDate();
    const currentMonthNum = today.getMonth() + 1;
    const currentYearToday = today.getFullYear();
    const todayStr = `${currentYearToday}-${String(currentMonthNum).padStart(2, '0')}-${String(currentDayNum).padStart(2, '0')}`;

    for (const monthInfo of monthsToDisplay) {
        const monthForLoop = monthInfo.month;
        const yearForLoop = monthInfo.year;

        const monthDiv = document.createElement('div');
        monthDiv.classList.add('calendar-month'); // Classe existante pour le style

        const monthDateObject = new Date(yearForLoop, monthForLoop - 1, 1);
        const monthName = monthDateObject.toLocaleString('fr-FR', { month: 'long' });
        monthDiv.innerHTML = `<h3>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${yearForLoop}</h3>`;

        const daysInCurrentMonth = new Date(yearForLoop, monthForLoop, 0).getDate();
        const firstDayWeekdayOffset = (monthDateObject.getDay() + 6) % 7; // 0 pour Lundi

        const daysGridContainer = document.createElement('div');
        daysGridContainer.classList.add('calendar-days'); // Classe existante pour le style

        const weekDayLabels = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
        weekDayLabels.forEach(wdText => {
            const wdCell = document.createElement('div');
            wdCell.classList.add('calendar-weekday');
            wdCell.textContent = wdText;
            daysGridContainer.appendChild(wdCell);
        });

        for (let i = 0; i < firstDayWeekdayOffset; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('calendar-day', 'empty');
            daysGridContainer.appendChild(emptyCell);
        }

        for (let dayNum = 1; dayNum <= daysInCurrentMonth; dayNum++) {
            const dayCell = document.createElement('div');
            dayCell.classList.add('calendar-day');
            dayCell.textContent = dayNum;

            const currentDateObject = new Date(yearForLoop, monthForLoop - 1, dayNum);
            const dateKey = `${yearForLoop}-${String(monthForLoop).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
            const dayData = daysDataFromApi[dateKey];
            const dayOfWeek = currentDateObject.getDay(); // 0=Dim, 1=Lun, ..., 6=Sam

            let cssClass = '';
            let tooltipText = '';

            if (dateKey === todayStr) {
                dayCell.classList.add('today');
            }

            if (dayData) {
                const typeValue = dayData.type || 'ERREUR';
                const typeLower = typeValue.toLowerCase().trim();
                tooltipText = dayData.description || typeValue;

                if (typeLower.startsWith('exception (silence)')) { cssClass = 'exception-silence'; }
                else if (typeLower.startsWith('exception (utiliser_jt')) { cssClass = 'exception-jt'; }
                else if (typeLower === 'férié') { cssClass = 'ferie'; }
                else if (typeLower === 'vacances') { cssClass = 'vacances'; }
                else if (dayOfWeek === 0) { cssClass = 'weekend-dimanche'; if (!dayData.description && !typeLower.startsWith('classe')) tooltipText = "Dimanche"; }
                else if (dayOfWeek === 6) { cssClass = 'weekend-samedi'; if (!dayData.description && !typeLower.startsWith('classe')) tooltipText = "Samedi"; }
                else if (typeLower.startsWith('classe')) { cssClass = 'classe'; }
                else if (typeLower === 'weekend') { // Fallback si backend envoie 'weekend' pour un jour de semaine
                    cssClass = (dayOfWeek === 0) ? 'weekend-dimanche' : (dayOfWeek === 6 ? 'weekend-samedi' : 'classe');
                    console.warn(`Jour ${dateKey} marqué 'weekend' par backend mais dayOfWeek=${dayOfWeek}. Appliqué: ${cssClass}`);
                }
                else if (typeLower === 'autre' || typeLower.includes('erreur')) { cssClass = 'erreur-donnees'; console.warn(`Type jour 'Autre' ou 'Erreur': '${typeValue}' pour ${dateKey}`); }
                else { cssClass = 'erreur-donnees'; console.error(`Type jour INCONNU du backend: '${typeValue}' pour ${dateKey}`); }
            } else { // Pas de données API pour ce jour (ne devrait pas arriver car le backend filtre pour le trimestre)
                 console.warn(`generateTrimesterView: Aucune donnée API pour ${dateKey}. Application des styles par défaut.`);
                 if (dayOfWeek === 0) { cssClass = 'weekend-dimanche'; tooltipText = "Dimanche"; }
                 else if (dayOfWeek === 6) { cssClass = 'weekend-samedi'; tooltipText = "Samedi"; }
                 else { cssClass = 'classe'; tooltipText = "Jour de classe (par défaut)"; }
            }

            if (cssClass) dayCell.classList.add(cssClass);
            dayCell.title = tooltipText;
            dayCell.style.cursor = 'pointer';
            dayCell.setAttribute('data-date', dateKey); // Utile pour débogage
            dayCell.onclick = () => showDailySchedule(currentDateObject.getFullYear(), currentDateObject.getMonth() + 1, dayNum);
            daysGridContainer.appendChild(dayCell);
        }
        monthDiv.appendChild(daysGridContainer);
        calendarContainer.appendChild(monthDiv);
    }
    console.log("Fin de generateTrimesterView");
}

function generateWeekView(weekScheduleData, mondayDate) {
    console.log(`[control.html] generateWeekView pour la semaine commençant le:`, mondayDate, "avec données:", weekScheduleData);
    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) { console.error("Conteneur #calendar-container introuvable !"); return; }
    calendarContainer.innerHTML = ''; // Vider le conteneur

    if (!weekScheduleData) {
        calendarContainer.innerHTML = "<p>Aucune donnée reçue pour la vue hebdomadaire.</p>";
        console.error("generateWeekView: Données API manquantes ou incorrectes.", weekScheduleData);
        return;
    }

    const weekDaysNames = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
    const today = new Date();
    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

    const weekFlexContainer = document.createElement('div');
    weekFlexContainer.className = 'd-flex flex-row flex-wrap justify-content-start calendar-week-view-container'; 
    calendarContainer.appendChild(weekFlexContainer);

    for (let i = 0; i < 7; i++) {
        const currentDayIter = new Date(mondayDate);
        currentDayIter.setDate(mondayDate.getDate() + i);
        const dateKey = currentDayIter.toISOString().split('T')[0];

        const dayData = weekScheduleData[dateKey];

        const dayDiv = document.createElement('div');
        dayDiv.className = 'card m-1 flex-fill';
        dayDiv.style.minWidth = '220px'; // Augmenté pour un peu plus d'espace
        dayDiv.style.maxWidth = '300px'; // Max width pour éviter trop d'étirement
        dayDiv.style.flexBasis = 'calc(100% / 4 - 0.5rem)'; // Pour environ 4 cartes par ligne sur grands écrans, puis wrap

        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header text-center fw-bold';
        cardHeader.textContent = `${weekDaysNames[i]} ${currentDayIter.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'})}`;
        dayDiv.appendChild(cardHeader);

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body p-2 d-flex flex-column'; // d-flex et flex-column pour gestion hauteur
        dayDiv.appendChild(cardBody);

        if (dateKey === todayStr) {
            cardHeader.classList.add('bg-info', 'text-white'); // Mettre en évidence le jour actuel avec une couleur différente
        }

        if (dayData) {
            const typeLower = (dayData.type || '').toLowerCase().trim();
            let bgColorClass = '';
            let mainInfoHtml = '';

            if (typeLower.startsWith('exception (silence)')) {
                bgColorClass = 'bg-light text-muted';
                mainInfoHtml = `<p class="text-center fst-italic small">${dayData.description || dayData.type}</p>`;
            } else if (typeLower.startsWith('exception (utiliser_jt')) {
                bgColorClass = 'bg-info-subtle';
                mainInfoHtml = `<p class="text-center fst-italic small">${dayData.description || dayData.type}</p>`;
            } else if (typeLower === 'férié') {
                bgColorClass = 'bg-warning-subtle';
                mainInfoHtml = `<p class="text-center fw-bold">${dayData.type}</p>`;
            } else if (typeLower === 'vacances') {
                bgColorClass = 'bg-success-subtle';
                mainInfoHtml = `<p class="text-center fw-bold">${dayData.type}</p>`;
            } else if (currentDayIter.getDay() === 0) { // Dimanche
                bgColorClass = 'bg-danger-subtle';
                if (!dayData.schedule || dayData.schedule.length === 0) mainInfoHtml = `<p class="text-center text-muted small"><em>Dimanche</em></p>`;
            } else if (currentDayIter.getDay() === 6) { // Samedi
                bgColorClass = 'bg-secondary-subtle';
                if (!dayData.schedule || dayData.schedule.length === 0) mainInfoHtml = `<p class="text-center text-muted small"><em>Samedi</em></p>`;
            } else if (typeLower.startsWith('classe')) {
                bgColorClass = 'bg-white';
            } else {
                bgColorClass = 'bg-light';
            }

            dayDiv.classList.add(bgColorClass);
            cardBody.innerHTML = mainInfoHtml; // Afficher l'info principale (Férié, Vacances, etc.)

            if (dayData.schedule && dayData.schedule.length > 0) {
                const scheduleList = document.createElement('ul');
                scheduleList.className = 'list-unstyled mb-0 small mt-2 flex-grow-1'; // mt-2 pour espacement, flex-grow-1
                dayData.schedule.forEach(period => {
                    const li = document.createElement('li');
                    li.className = 'mb-1 border-bottom pb-1'; // Style pour séparer les périodes
                    let periodText = `<strong>${period.heure_debut.substring(0,5)} - ${period.heure_fin.substring(0,5)}:</strong> ${period.nom}`;

                    let sonnerieDebutText = "";
                    if (period.sonnerie_debut && period.sonnerie_debut.toLowerCase() !== 'aucune' && period.sonnerie_debut.toLowerCase() !== 'silence') {
                        sonnerieDebutText = `<small class="ms-2 text-muted">🔔 D: <em>${period.sonnerie_debut.replace('.mp3','')}</em></small>`;
                    } else if (period.sonnerie_debut && (period.sonnerie_debut.toLowerCase() === 'aucune' || period.sonnerie_debut.toLowerCase() === 'silence')) {
                        sonnerieDebutText = `<small class="ms-2 text-muted">🔔 D: <em>Silence</em></small>`;
                    }

                    let sonnerieFinText = "";
                     if (period.sonnerie_fin && period.sonnerie_fin.toLowerCase() !== 'aucune' && period.sonnerie_fin.toLowerCase() !== 'silence') {
                        sonnerieFinText = `<small class="ms-2 text-muted">🔔 F: <em>${period.sonnerie_fin.replace('.mp3','')}</em></small>`;
                    } else if (period.sonnerie_fin && (period.sonnerie_fin.toLowerCase() === 'aucune' || period.sonnerie_fin.toLowerCase() === 'silence')) {
                         sonnerieFinText = `<small class="ms-2 text-muted">🔔 F: <em>Silence</em></small>`;
                    }

                    if (sonnerieDebutText || sonnerieFinText) {
                         periodText += `<br>${sonnerieDebutText}${sonnerieDebutText && sonnerieFinText ? " " : ""}${sonnerieFinText}`;
                    }

                    li.innerHTML = periodText;
                    scheduleList.appendChild(li);
                });
                cardBody.appendChild(scheduleList);
            } else if (mainInfoHtml === '' && (!dayData.type || dayData.type.toLowerCase().startsWith('classe'))) {
                // Si c'est un jour de classe sans planning spécifique affiché et sans info principale
                cardBody.innerHTML += `<p class="text-center text-muted small mt-2 flex-grow-1"><em>Aucun planning spécifique</em></p>`;
            }
        } else {
            dayDiv.classList.add('bg-light');
            cardBody.innerHTML = `<p class="text-center text-muted small mt-2 flex-grow-1"><em>Données non disponibles</em></p>`;
        }
        weekFlexContainer.appendChild(dayDiv);
    }
    console.log("[control.html] Fin de generateWeekView");
}

function generateMonthCalendar(apiResponseData, academicYearString, monthNumber) {
    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) { console.error("Conteneur #calendar-container introuvable !"); return; }
    calendarContainer.innerHTML = ''; // Vider le conteneur

    const [startAcademicYear, endAcademicYear] = academicYearString.split('-').map(Number);
    // Déterminer l'année civile correcte pour le mois donné
    const targetYear = (monthNumber >= 9 && monthNumber <= 12) ? startAcademicYear : endAcademicYear;

    const monthDate = new Date(targetYear, monthNumber - 1, 1); // monthNumber est 1-12, le constructeur Date attend 0-11 pour les mois
    const monthName = monthDate.toLocaleString('fr-FR', { month: 'long' });

    // Le titre principal du calendrier est déjà géré par changeCalendarView.
    // Si un sous-titre spécifique au mois affiché était nécessaire, on l'ajouterait ici.
    // Exemple:
    // const monthTitleDiv = document.createElement('h4'); // Un h4 pour un sous-titre
    // monthTitleDiv.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${targetYear}`;
    // monthTitleDiv.classList.add('text-center', 'mb-3'); // Classes Bootstrap pour style
    // calendarContainer.appendChild(monthTitleDiv);

    const daysInMonth = new Date(targetYear, monthNumber, 0).getDate(); // Obtenir le nombre de jours dans le mois
    const firstDayWeekday = (monthDate.getDay() + 6) % 7; // 0 pour Lundi, 1 pour Mardi, ..., 6 pour Dimanche

    const daysGridContainer = document.createElement('div');
    // Utiliser une classe spécifique pour permettre un style différent de la vue annuelle si besoin
    // et réutiliser .calendar-days pour les aspects communs de la grille.
    daysGridContainer.classList.add('calendar-days', 'month-view-grid');

    // En-têtes des jours de la semaine
    const weekDays = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
    weekDays.forEach(wd => {
        const weekdayCell = document.createElement('div');
        weekdayCell.classList.add('calendar-weekday');
        weekdayCell.textContent = wd;
        daysGridContainer.appendChild(weekdayCell);
    });

    // Cellules vides pour les jours avant le début du mois
    for (let i = 0; i < firstDayWeekday; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.classList.add('calendar-day', 'empty');
        daysGridContainer.appendChild(emptyCell);
    }

    // Cellules des jours du mois
    const daysDataFromApi = apiResponseData.days; // Supposons que apiResponseData.days est bien l'objet des jours pour le mois
    const today = new Date();
    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.classList.add('calendar-day');
        dayCell.textContent = day;

        // Créer l'objet Date pour le jour courant du mois
        // monthNumber est 1-indexé, mais le constructeur Date attend 0-indexé pour le mois
        const currentDateObject = new Date(targetYear, monthNumber - 1, day);
        const dateKey = `${targetYear}-${String(monthNumber).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const dayData = daysDataFromApi ? daysDataFromApi[dateKey] : null; // Vérifier si daysDataFromApi existe
        
        // Déterminer le jour de la semaine (0 = Dimanche, 1 = Lundi, ..., 6 = Samedi)
        const dayOfWeek = currentDateObject.getDay(); // Utilisation directe de getDay()

        let cssClass = '';
        let tooltipText = ''; // Initialiser le tooltip

        if (dateKey === todayStr) {
            dayCell.classList.add('today'); // La classe 'today' peut coexister avec d'autres
        }

        if (dayData) { // Si des données existent pour ce jour depuis l'API
            const typeValue = dayData.type || 'ERREUR';
            const typeLower = typeValue.toLowerCase().trim();
            tooltipText = dayData.description || typeValue; // Description prioritaire, sinon le type

            // 1. Priorité absolue aux types spécifiques de l'API (Exception, Férié, Vacances)
            if (typeLower.startsWith('exception (silence)')) {
                cssClass = 'exception-silence';
            } else if (typeLower.startsWith('exception (utiliser_jt')) {
                cssClass = 'exception-jt';
            } else if (typeLower === 'férié') {
                cssClass = 'ferie';
            } else if (typeLower === 'vacances') {
                cssClass = 'vacances';
            } 
            // 2. Si ce n'est pas un des types ci-dessus, on regarde si c'est un weekend ou un jour de classe
            else if (dayOfWeek === 0) { // Dimanche
                cssClass = 'weekend-dimanche'; // Ta classe pour dimanche (rouge)
                if (!tooltipText && !typeLower.startsWith('classe')) tooltipText = "Dimanche"; // Tooltip par défaut si pas d'info API pertinente
            } else if (dayOfWeek === 6) { // Samedi
                cssClass = 'weekend-samedi'; // Ta classe pour samedi
                if (!tooltipText && !typeLower.startsWith('classe')) tooltipText = "Samedi"; // Tooltip par défaut
            } else if (typeLower.startsWith('classe')) {
                cssClass = 'classe';
            } else if (typeLower === 'weekend') { 
                // Cas où le backend dit 'weekend' mais ce n'est ni Sam ni Dim (peut arriver si la logique backend est différente)
                // On applique une couleur weekend générique ou on se fie au jour de la semaine
                cssClass = (dayOfWeek === 0) ? 'weekend-dimanche' : (dayOfWeek === 6 ? 'weekend-samedi' : 'classe'); // fallback plus sûr
                console.warn(`Jour ${dateKey} marqué 'weekend' par backend mais dayOfWeek=${dayOfWeek}. Appliqué: ${cssClass}`);
            } else if (typeLower === 'autre' || typeLower.includes('erreur')) { // 'erreurhm' inclus par .includes('erreur')
                cssClass = 'erreur-donnees';
                console.warn(`Type jour 'Autre' ou 'Erreur': '${typeValue}' pour ${dateKey}`);
            } else { // Type inconnu du backend
                cssClass = 'erreur-donnees';
                console.error(`Type jour INCONNU du backend: '${typeValue}' pour ${dateKey}`);
            }
        } else { // Pas de dayData du backend pour ce jour (comportement par défaut)
            if (dayOfWeek === 0) { // Dimanche
                cssClass = 'weekend-dimanche';
                tooltipText = "Dimanche";
            } else if (dayOfWeek === 6) { // Samedi
                cssClass = 'weekend-samedi';
                tooltipText = "Samedi";
            } else { // Jour de semaine normal sans info spécifique (Lundi-Vendredi)
                cssClass = 'classe'; // Par défaut, on considère que c'est un jour de classe
                tooltipText = "Jour de classe (par défaut)";
            }
        }

        if (cssClass) {
            dayCell.classList.add(cssClass);
        }
        dayCell.title = tooltipText; // Appliquer le tooltip
        
        // Ajout du data-attribute pour le débogage (optionnel)
        dayCell.setAttribute('data-date', dateKey);
        dayCell.setAttribute('data-day-type-api', dayData ? dayData.type : 'N/A');
        dayCell.setAttribute('data-day-of-week', dayOfWeek);
        dayCell.setAttribute('data-final-css', cssClass);


        dayCell.style.cursor = 'pointer';
        // Utiliser currentDateObject pour showDailySchedule car monthNumber est 1-indexé et getMonth est 0-indexé.
        dayCell.onclick = () => showDailySchedule(currentDateObject.getFullYear(), currentDateObject.getMonth() + 1, day);
        daysGridContainer.appendChild(dayCell);
    }
    calendarContainer.appendChild(daysGridContainer);
    console.log(`[control.html] Vue mensuelle pour ${monthName} ${targetYear} générée.`);
}

function generateCalendar(apiData, academicYear) {
    console.log(`Entrée generateCalendar pour année: ${academicYear}`);
    const calendarContainer = document.getElementById('calendar-container');
    if (!calendarContainer) { console.error("Conteneur #calendar-container introuvable !"); return; }
    calendarContainer.innerHTML = ''; // Vider le conteneur

    const today = new Date();
    const currentDayNum = today.getDate(); 
    const currentMonthNum = today.getMonth() + 1; // 1-12
    const currentYearToday = today.getFullYear();
    const todayStr = `${currentYearToday}-${String(currentMonthNum).padStart(2, '0')}-${String(currentDayNum).padStart(2, '0')}`;
    console.log(`Date actuelle pour 'today' highlight: ${todayStr}`);

    if (!apiData || typeof apiData !== 'object' || !apiData.days || typeof apiData.days !== 'object') { 
        console.error("Données calendrier invalides reçues par generateCalendar:", apiData); 
        calendarContainer.innerHTML = "<p>Erreur: Données calendrier invalides.</p>"; 
        return; 
    }
    const daysDataFromApi = apiData.days; // daysDataFromApi contient les données pour toute l'année scolaire

    const [startYear, endYear] = academicYear.split('-').map(Number);
    console.log(`Affichage de Sept ${startYear} à Août ${endYear}`);

    for (let m = 0; m < 12; m++) { // Boucle sur les 12 mois de l'année scolaire
        let monthForLoop, yearForLoop; // Variables pour le mois (1-12) et l'année civile du mois courant
        if (m < 4) { // Sept, Oct, Nov, Dec
            monthForLoop = m + 9; 
            yearForLoop = startYear; 
        } else { // Jan, Fev, ..., Aou
            monthForLoop = m - 3; 
            yearForLoop = endYear; 
        }

        const monthDiv = document.createElement('div'); 
        monthDiv.classList.add('calendar-month');
        
        // monthForLoop est 1-indexé. Pour new Date(), le mois est 0-indexé.
        const monthDateObject = new Date(yearForLoop, monthForLoop - 1, 1); 
        const monthName = monthDateObject.toLocaleString('fr-FR', { month: 'long' });
        monthDiv.innerHTML = `<h3>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${yearForLoop}</h3>`;
        
        const daysInCurrentMonth = new Date(yearForLoop, monthForLoop, 0).getDate(); // Nombre de jours dans le mois courant
        const firstDayWeekdayOffset = (monthDateObject.getDay() + 6) % 7; // 0 pour Lundi, 1 pour Mardi ... 6 pour Dimanche

        const daysGridContainer = document.createElement('div'); 
        daysGridContainer.classList.add('calendar-days');
        
        const weekDayLabels = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
        weekDayLabels.forEach(wd => { 
            const d = document.createElement('div'); 
            d.classList.add('calendar-weekday'); 
            d.textContent = wd; 
            daysGridContainer.appendChild(d); 
        });
        
        // Cellules vides pour les jours avant le début du mois
        for (let i = 0; i < firstDayWeekdayOffset; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('calendar-day', 'empty');
            daysGridContainer.appendChild(emptyCell);
        }

        // Cellules des jours du mois
        for (let dayNum = 1; dayNum <= daysInCurrentMonth; dayNum++) {
            const dayCell = document.createElement('div');
            dayCell.classList.add('calendar-day');
            dayCell.textContent = dayNum;

            // Créer l'objet Date pour le jour courant du mois
            const currentDateObject = new Date(yearForLoop, monthForLoop - 1, dayNum);
            const dateKey = `${yearForLoop}-${String(monthForLoop).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
            
            const dayData = daysDataFromApi[dateKey]; // Récupérer les données de l'API pour ce jour
            
            // Déterminer le jour de la semaine (0 = Dimanche, 1 = Lundi, ..., 6 = Samedi)
            const dayOfWeek = currentDateObject.getDay(); 

            let cssClass = '';
            let tooltipText = '';

            if (dateKey === todayStr) {
                dayCell.classList.add('today');
            }

            if (dayData) { // Si des données existent pour ce jour depuis l'API
                const typeValue = dayData.type || 'ERREUR';
                const typeLower = typeValue.toLowerCase().trim();
                tooltipText = dayData.description || typeValue;

                // 1. Priorité absolue aux types spécifiques de l'API
                if (typeLower.startsWith('exception (silence)')) {
                    cssClass = 'exception-silence';
                } else if (typeLower.startsWith('exception (utiliser_jt')) {
                    cssClass = 'exception-jt';
                } else if (typeLower === 'férié') {
                    cssClass = 'ferie';
                } else if (typeLower === 'vacances') {
                    cssClass = 'vacances';
                } 
                // 2. Si pas un type prioritaire, vérifier weekend
                else if (dayOfWeek === 0) { // Dimanche
                    cssClass = 'weekend-dimanche';
                    if (!dayData.description && !typeLower.startsWith('classe')) tooltipText = "Dimanche";
                } else if (dayOfWeek === 6) { // Samedi
                    cssClass = 'weekend-samedi';
                    if (!dayData.description && !typeLower.startsWith('classe')) tooltipText = "Samedi";
                } else if (typeLower.startsWith('classe')) {
                    cssClass = 'classe';
                } else if (typeLower === 'weekend') { // Fallback si le backend envoie 'weekend' explicitement
                    cssClass = (dayOfWeek === 0) ? 'weekend-dimanche' : (dayOfWeek === 6 ? 'weekend-samedi' : 'classe');
                    console.warn(`Jour ${dateKey} marqué 'weekend' par backend mais dayOfWeek=${dayOfWeek}. Appliqué: ${cssClass}`);
                } else if (typeLower === 'autre' || typeLower.includes('erreur')) {
                    cssClass = 'erreur-donnees';
                    console.warn(`Type jour 'Autre' ou 'Erreur': '${typeValue}' pour ${dateKey}`);
                } else { 
                    cssClass = 'erreur-donnees';
                    console.error(`Type jour INCONNU du backend: '${typeValue}' pour ${dateKey}`);
                }
            } else { // Pas de dayData du backend pour ce jour (comportement par défaut)
                if (dayOfWeek === 0) { // Dimanche
                    cssClass = 'weekend-dimanche';
                    tooltipText = "Dimanche";
                } else if (dayOfWeek === 6) { // Samedi
                    cssClass = 'weekend-samedi';
                    tooltipText = "Samedi";
                } else { // Jour de semaine normal sans info spécifique
                    cssClass = 'classe'; 
                    tooltipText = "Jour de classe (par défaut)";
                }
            }

            if (cssClass) {
                dayCell.classList.add(cssClass);
            }
            dayCell.title = tooltipText;
            
            // Attributs de débogage (optionnel)
            dayCell.setAttribute('data-date', dateKey);
            dayCell.setAttribute('data-day-type-api', dayData ? dayData.type : 'N/A');
            dayCell.setAttribute('data-day-of-week', dayOfWeek);
            dayCell.setAttribute('data-final-css', cssClass);

            dayCell.style.cursor = 'pointer';
            dayCell.onclick = () => showDailySchedule(currentDateObject.getFullYear(), currentDateObject.getMonth() + 1, dayNum);
            daysGridContainer.appendChild(dayCell);
        }
        monthDiv.appendChild(daysGridContainer); 
        calendarContainer.appendChild(monthDiv);
    }
    console.log("Fin de generateCalendar (vue annuelle)");
}

function showDailySchedule(year, month, day) {
     console.log(`>>> Début showDailySchedule ${year}-${month}-${day}`);
     const monthStr = month.toString().padStart(2, '0'); const dayStr = day.toString().padStart(2, '0');
     const dateStr = `${year}-${monthStr}-${dayStr}`; console.log(`   Date: ${dateStr}`);
     const modalOverlay = document.getElementById('modal-overlay'); const modalContent = document.getElementById('modal-content');
     if (!modalOverlay || !modalContent) { console.error("   Elts modale manquants !"); return; }
	 modalContent.innerHTML = `<p>Chargement des horaires pour ${dayStr}/${monthStr}/${year}...</p>`; modalOverlay.classList.add('visible');
     const apiUrl = `/api/daily_schedule?date=${dateStr}`; console.log(`   Fetch: ${apiUrl}`);
     try {
         fetch(apiUrl)
             .then(response => {
                 console.log(`   Réponse ${apiUrl}, statut: ${response.status}`);
                 if (!response.ok) { return response.json().then(err => { throw new Error(`Erreur ${response.status}: ${err.error || err.message || response.statusText}`) }).catch(() => { throw new Error(`Erreur HTTP ${response.status}`) }); }
                 return response.json();
             })
             .then(data => {
                  console.log("   Détails reçus:", data);
                  let htmlModalContent = `<h4>Détails du ${dayStr}/${monthStr}/${year}</h4>`;
                  let dayInfoText = data.message || data.day_type || "Information indisponible";
                  htmlModalContent += `<span class="day-type-info">${dayInfoText}</span>`;
                  if (data.error) { htmlModalContent += `<p style="color: red;">Erreur: ${data.error}</p>`; }
                  else if (data.schedule && Array.isArray(data.schedule) && data.schedule.length > 0) {
                      htmlModalContent += `<table><thead><tr><th>Heure</th><th>Événement</th><th>Sonnerie</th></tr></thead><tbody>`;
                      data.schedule.forEach(item => { const timeFormatted = item.time.substring(0, 5); htmlModalContent += `<tr><td>${timeFormatted}</td><td>${item.event||'N/A'}</td><td><em>${item.sonnerie||'Silence'}</em></td></tr>`; });
                      htmlModalContent += `</tbody></table>`;
                  } else { htmlModalContent += `<p><em>Aucune sonnerie planifiée.</em></p>`; }
                  modalContent.innerHTML = htmlModalContent; console.log("   Affichage détails OK (modale).");
             })
             .catch(error => { console.error(`   Erreur dans showDailySchedule pour ${dateStr}:`, error); modalContent.innerHTML = `<p style="color: red;">Impossible de charger les détails.<br>${error.message}</p>`; });
     } catch (fetchError) { console.error(`   Erreur synchrone showDailySchedule:`, fetchError); modalContent.innerHTML = `<p style="color: red;">Erreur JS.<br>${fetchError.message}</p>`; }
     console.log(`<<< Fin appel synchrone showDailySchedule pour ${dateStr}`);
}

// --- NOUVELLE LOGIQUE POUR LES ALERTES ---

function loadConfigSettings() {
    console.log("[control.html] Chargement settings via /api/config/settings...");
    return fetch('/api/config/settings')
        .then(response => {
            if (!response.ok) throw new Error(`Erreur HTTP settings: ${response.status} ${response.statusText}`);
            return response.json();
        })
        .then(data => {
            console.log("[control.html] Settings reçus:", data);
            if (data) {
                configSettings = data; // Stocker tous les settings (inclut alert_files, alert_click_mode, etc.)
                // Assurer une valeur par défaut pour alert_files si non présent
                if (!configSettings.alert_files) {
                    console.warn("[control.html] configSettings.alert_files manquant après chargement. Initialisation par défaut.");
                    configSettings.alert_files = { ppms: null, attentat: null };
                }
                // Assurer une valeur par défaut pour alert_click_mode si non présent
                if (configSettings.alert_click_mode === undefined) {
                    console.warn("[control.html] configSettings.alert_click_mode manquant. Défaut à 'double'.");
                    configSettings.alert_click_mode = "double";
                }
            } else {
                console.warn("[control.html] Données de settings API null ou vides. Utilisation des valeurs par défaut.");
                configSettings = {
                    alert_files: { ppms: null, attentat: null },
                    alert_click_mode: "double"
                };
            }
        })
        .catch(error => {
            console.error("[control.html] Erreur critique chargement settings:", error);
            configSettings = {
                alert_files: { ppms: null, attentat: null },
                alert_click_mode: "double"
            };
            if (typeof showFeedback === 'function') showFeedback("Erreur chargement configuration des alertes. Fonctionnalité d'alerte affectée.", "error");
            throw error;
        });
}

function updateAlertButtonsUI(statusData) {
    if (!statusData) {
        console.warn("[control.html] updateAlertButtonsUI: statusData est null.");
        if(btnAlertPpms) btnAlertPpms.disabled = true;
        if(btnAlertAttentat) btnAlertAttentat.disabled = true;
        if(btnEndAlert) btnEndAlert.disabled = true;
        return;
    }
    if (!btnAlertPpms || !btnAlertAttentat || !btnEndAlert) {
        console.warn("[control.html] updateAlertButtonsUI: Un ou plusieurs éléments de bouton ne sont pas encore initialisés.");
        return;
    }
    if (!configSettings || !configSettings.alert_files || configSettings.alert_files.ppms === undefined || configSettings.alert_files.attentat === undefined) {
        console.warn("[control.html] updateAlertButtonsUI: configSettings.alert_files non disponible ou incomplet.", configSettings);
        if (typeof showFeedback === 'function') showFeedback("Config alerte incomplète. Boutons désactivés.", "error", 7000);
        btnAlertPpms.disabled = true; btnAlertPpms.title = "Config PPMS manquante";
        btnAlertAttentat.disabled = true; btnAlertAttentat.title = "Config Attentat manquante";
        btnEndAlert.disabled = true;
        return;
    }

    const ppmsFile = configSettings.alert_files.ppms;
    const attentatFile = configSettings.alert_files.attentat;

    let isPpmsActiveBackend = (statusData.alert_active && statusData.alert_type === ppmsFile);
    let isAttentatActiveBackend = (statusData.alert_active && statusData.alert_type === attentatFile);

    console.log(`[control.html] updateAlertButtonsUI: PPMS Active? ${isPpmsActiveBackend}, Attentat Actif? ${isAttentatActiveBackend}, Alerte Active Générique? ${statusData.alert_active}, Type: ${statusData.alert_type}`);

    btnAlertPpms.classList.remove('btn-danger', 'active', 'btn-warning', 'blinking-alert'); // Nettoyer blinking-alert
    btnAlertPpms.disabled = false;
    if (isPpmsActiveBackend) {
        btnAlertPpms.classList.add('btn-danger', 'active', 'blinking-alert'); // Ajouter blinking-alert
        btnAlertPpms.innerHTML = '<i class="bi bi-shield-fill-exclamation me-1"></i>PPMS ACTIVE';
        btnAlertPpms.title = "Double-clic pour ARRETER l'alerte PPMS";
        btnAlertAttentat.disabled = true;
    } else {
        btnAlertPpms.classList.add('btn-warning');
        btnAlertPpms.innerHTML = '<i class="bi bi-shield-fill-exclamation me-1"></i>PPMS';
        btnAlertPpms.title = "Double-clic pour DECLENCHER l'alerte PPMS";
        if (isAttentatActiveBackend) btnAlertPpms.disabled = true;
    }

    btnAlertAttentat.classList.remove('btn-dark', 'active', 'btn-danger', 'blinking-alert'); // Nettoyer 'btn-dark' aussi
    btnAlertAttentat.disabled = false;

    if (isAttentatActiveBackend) {
        btnAlertAttentat.classList.add('btn-danger', 'active', 'blinking-alert'); // <<< CHANGEMENT ICI : btn-danger au lieu de btn-dark
        btnAlertAttentat.innerHTML = '<i class="bi bi-cone-striped me-1"></i>ATTENTAT ACTIF';
        btnAlertAttentat.title = "Double-clic pour ARRETER l'alerte Attentat";
        btnAlertPpms.disabled = true;
    } else {
        btnAlertAttentat.classList.add('btn-danger'); // Couleur par défaut reste btn-danger
        btnAlertAttentat.innerHTML = '<i class="bi bi-cone-striped me-1"></i>ATTENTAT';
        btnAlertAttentat.title = "Double-clic pour DECLENCHER l'alerte Attentat";
        if (isPpmsActiveBackend) btnAlertAttentat.disabled = true;
    }

    if (statusData.alert_active && !isPpmsActiveBackend && !isAttentatActiveBackend) {
        btnAlertPpms.disabled = true;
        btnAlertAttentat.disabled = true;
    }

    btnEndAlert.disabled = !statusData.alert_active;
}

function fetchPageStatusAndUpdateAlertUI() {
    console.log("[control.html] fetchPageStatusAndUpdateAlertUI: Récupération du statut...");
    return fetch('/api/status')
        .then(response => {
            if (!response.ok) {
                return response.json().catch(() => null).then(errData => {
                    const errorMsg = errData && errData.error ? errData.error : `Erreur HTTP status: ${response.status} ${response.statusText}`;
                    throw new Error(errorMsg);
                });
            }
            return response.json();
        })
        .then(data => {
            currentStatus = data;
            console.log("[control.html] Statut local mis à jour:", currentStatus);
            updateAlertButtonsUI(currentStatus);
            if (typeof fetchGlobalStatus === 'function') fetchGlobalStatus();
        })
        .catch(error => {
            console.error("[control.html] Erreur fetchPageStatusAndUpdateAlertUI:", error);
            if (typeof showFeedback === 'function') showFeedback(`Erreur statut: ${error.message}`, 'error');
            updateAlertButtonsUI({ alert_active: false, alert_type: null });
        });
}

function callApiAndRefresh(apiUrl, method = 'POST', actionText = 'Action') {
    console.log(`[control.html] Appel API: ${actionText} -> ${apiUrl}`);
    if(btnAlertPpms) btnAlertPpms.disabled = true;
    if(btnAlertAttentat) btnAlertAttentat.disabled = true;
    if(btnEndAlert) btnEndAlert.disabled = true;

    return fetch(apiUrl, { method: method })
        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
        .then(({ ok, status, data }) => {
            const message = data.message || (ok ? `${actionText} réussie.` : `Erreur ${actionText} (${status})`);
            if (typeof showFeedback === 'function') showFeedback(message, ok ? 'success' : 'error');
            if (!ok && data.error) console.error(`[control.html] Erreur API ${actionText}: ${data.error}`);
        })
        .catch(error => {
            console.error(`[control.html] Erreur réseau/serveur (${actionText}): ${error.message}`);
            if (typeof showFeedback === 'function') showFeedback(`Erreur réseau (${actionText}): ${error.message}`, 'error');
        })
        .finally(() => {
            if (typeof fetchPageStatusAndUpdateAlertUI === 'function') {
                fetchPageStatusAndUpdateAlertUI();
            }
        });
}

function callTriggerAlertAPI(alertType) {
    if (!configSettings || !configSettings.alert_files) { showFeedback("Erreur: Config alertes non chargée.", 'error'); return Promise.reject("Config non chargée"); }
    let key = alertType.toLowerCase();
    let file = configSettings.alert_files[key];
    if (!file) { showFeedback(`Sonnerie pour ${alertType} non configurée!`, 'error'); return Promise.reject("Fichier non configuré"); }
    return callApiAndRefresh(`/api/alert/trigger/${encodeURIComponent(file)}`, 'POST', `Déclenchement ${alertType}`);
}

function callStopAlertAPI() { return callApiAndRefresh('/api/alert/stop', 'POST', "Arrêt Urgence Alerte"); }
function callEndAlertAPI() { return callApiAndRefresh('/api/alert/end', 'POST', "Fin d'Alerte Programmée"); }

// --- Initialisation ---
document.addEventListener('DOMContentLoaded', function() {
    console.log("[control.html] DOMContentLoaded: Initialisation de la page de contrôle...");

    // Initialisations de base (variables globales, éléments DOM pour les alertes)
    selectedAcademicYear = getDefaultAcademicYear();
    btnAlertPpms = document.getElementById('btn-alert-ppms');
    btnAlertAttentat = document.getElementById('btn-alert-attentat');
    btnEndAlert = document.getElementById('btn-end-alert');
    // ... récupérer les autres boutons (prev/next week/day) et éléments de sélecteurs ici ...
    const viewSelect = document.getElementById('calendar-view-type-select');
    const yearSelect = document.getElementById('academic-year-select');
    const monthSelect = document.getElementById('month-select');
    const semesterSelect = document.getElementById('semester-select');
    const trimesterSelect = document.getElementById('trimester-select');
    const weekDateSelect = document.getElementById('week-date-select');
    const dayDateSelect = document.getElementById('day-date-select');

    if (typeof populateAcademicYearSelector === 'function') {
        populateAcademicYearSelector(); // Peupler l'année scolaire d'abord
    }

    // Séquence d'initialisation MISE À JOUR
    if (typeof loadConfigSettings === 'function') {
        loadConfigSettings()
            .then(() => {
                console.log("[control.html] DOMContentLoaded: Config settings chargées.");
                // Récupérer la préférence de vue
                return fetch('/api/user/get_calendar_preference');
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => { throw new Error(errData.error || `Erreur HTTP ${response.status} (get_calendar_preference)`); }).catch(() => { throw new Error(`Erreur HTTP ${response.status} (get_calendar_preference)`); });
                }
                return response.json();
            })
            .then(preferenceData => {
                // preferenceData devrait être {"calendar_default_view": "valeur"} ou {"calendar_default_view": null}
                applyUserDefaultView(preferenceData.calendar_default_view); // NOUVELLE FONCTION
                return fetchPageStatusAndUpdateAlertUI(); // Charger statut des alertes
            })
            .then(() => {
                console.log("[control.html] DOMContentLoaded: Préférences de VUE appliquées et statut alertes chargé.");
                if (typeof changeCalendarView === 'function') {
                    changeCalendarView(); // Appeler changeCalendarView QUI VA initialiser les dates/périodes
                } else {
                     console.error("[control.html] changeCalendarView n'est pas définie !");
                }
            })
            .catch(error => {
                console.error("[control.html] DOMContentLoaded: Erreur majeure dans la séquence d'initialisation:", error);
                if (typeof showFeedback === 'function') showFeedback("Erreur d'initialisation de la page: " + error.message, "error");
                // Fallback: appliquer la vue par défaut et tenter d'afficher le calendrier
                applyUserDefaultView(null); // Appliquer la vue par défaut (ex: 'year')
                if (typeof changeCalendarView === 'function') {
                    changeCalendarView();
                }
                if (typeof updateAlertButtonsUI === 'function') updateAlertButtonsUI({ alert_active: false, alert_type: null });
            });
    } else {
        console.error("[control.html] loadConfigSettings n'est pas définie! Impossible de charger la configuration et les préférences correctement.");
        // Fallback minimal si loadConfigSettings n'existe pas du tout
        applyUserDefaultView(null);
        if (typeof changeCalendarView === 'function') changeCalendarView();
        if (typeof fetchPageStatusAndUpdateAlertUI === 'function') fetchPageStatusAndUpdateAlertUI(); // Tenter de charger le statut des alertes
    }
    // --- FIN Séquence d'initialisation MISE À JOUR ---


    // Attacher les listeners (y compris celui de btnSaveDefaultView)
    // ... (code existant pour les listeners des boutons d'alerte, navigation semaine/jour) ...
    if (btnAlertPpms) {
        btnAlertPpms.addEventListener('click', function() {
            if (this.disabled) return;

            const performActionPpms = () => {
                const ppmsFile = configSettings.alert_files ? configSettings.alert_files.ppms : null;
                const isActive = (currentStatus && currentStatus.alert_active && currentStatus.alert_type === ppmsFile);
                console.log(`[control.html] Action PPMS (mode: ${configSettings.alert_click_mode || 'double'}). Actif? ${isActive}`);
                if (isActive) callStopAlertAPI();
                else if (currentStatus && !currentStatus.alert_active) callTriggerAlertAPI('PPMS');
                else if (typeof showFeedback === 'function') showFeedback("Action PPMS impossible: autre alerte active ou statut inconnu.", "warning");
            };

            const currentAlertClickMode = configSettings.alert_click_mode || 'double'; // Récupérer ou défaut

            if (currentAlertClickMode === 'single') {
                performActionPpms();
            } else { // Mode double-clic (par défaut)
                if (ppmsClickTimer === null) {
                    ppmsClickTimer = setTimeout(() => { ppmsClickTimer = null; }, DBL_CLICK_DELAY);
                } else {
                    clearTimeout(ppmsClickTimer); ppmsClickTimer = null;
                    performActionPpms();
                }
            }
        });
    } else { console.error("Bouton #btn-alert-ppms non trouvé."); }

    if (btnAlertAttentat) {
        btnAlertAttentat.addEventListener('click', function() {
            if (this.disabled) return;

            const performActionAttentat = () => {
                const attentatFile = configSettings.alert_files ? configSettings.alert_files.attentat : null;
                const isActive = (currentStatus && currentStatus.alert_active && currentStatus.alert_type === attentatFile);
                console.log(`[control.html] Action Attentat (mode: ${configSettings.alert_click_mode || 'double'}). Actif? ${isActive}`);
                if (isActive) callStopAlertAPI();
                else if (currentStatus && !currentStatus.alert_active) callTriggerAlertAPI('Attentat');
                else if (typeof showFeedback === 'function') showFeedback("Action Attentat impossible: autre alerte active ou statut inconnu.", "warning");
            };

            const currentAlertClickMode = configSettings.alert_click_mode || 'double';

            if (currentAlertClickMode === 'single') {
                performActionAttentat();
            } else { // Mode double-clic
                if (attentatClickTimer === null) {
                    attentatClickTimer = setTimeout(() => { attentatClickTimer = null; }, DBL_CLICK_DELAY);
                } else {
                    clearTimeout(attentatClickTimer); attentatClickTimer = null;
                    performActionAttentat();
                }
            }
        });
    } else { console.error("Bouton #btn-alert-attentat non trouvé."); }

    if (btnEndAlert) {
        btnEndAlert.addEventListener('click', function() {
            if (this.disabled) return;

            const performActionEndAlert = () => {
                console.log(`[control.html] Action Fin d'Alerte (mode: ${configSettings.alert_click_mode || 'double'}).`);
                if (typeof callEndAlertAPI === 'function') {
                    callEndAlertAPI();
                } else {
                    console.error("[control.html] La fonction callEndAlertAPI n'est pas définie !");
                }
            };

            const currentAlertClickMode = configSettings.alert_click_mode || 'double';

            if (currentAlertClickMode === 'single') {
                performActionEndAlert();
            } else { // Mode double-clic
                if (endAlertClickTimer === null) {
                    endAlertClickTimer = setTimeout(() => {
                        endAlertClickTimer = null;
                        console.log("[control.html] Simple clic sur Sonnerie Fin d'Alerte (ignoré en mode double-clic)");
                    }, DBL_CLICK_DELAY);
                } else {
                    clearTimeout(endAlertClickTimer);
                    endAlertClickTimer = null;
                    performActionEndAlert();
                }
            }
        });
    } else { console.error("Bouton #btn-end-alert non trouvé pour attacher listener."); }

    // Gestionnaires pour les boutons de navigation semaine
    const prevWeekBtn = document.getElementById('prev-week-btn');
    const nextWeekBtn = document.getElementById('next-week-btn');
    const weekDateSelectInput = document.getElementById('week-date-select'); // Récupérer l'input date

    if (prevWeekBtn) {
        prevWeekBtn.addEventListener('click', function() {
            if (!selectedWeekStartDate) { // Initialiser si null
                console.warn("prevWeekBtn: selectedWeekStartDate non initialisée. Tentative d'init depuis input ou aujourd'hui.");
                selectedWeekStartDate = weekDateSelectInput && weekDateSelectInput.valueAsDate 
                                        ? new Date(weekDateSelectInput.valueAsDate.valueOf()) 
                                        : new Date();
            }
            selectedWeekStartDate.setDate(selectedWeekStartDate.getDate() - 7);
            if(weekDateSelectInput) {
                // Mettre à jour l'input. Utiliser valueAsDate pour affecter un objet Date.
                // Il est crucial de créer une NOUVELLE instance de Date pour valueAsDate.
                weekDateSelectInput.valueAsDate = new Date(selectedWeekStartDate.valueOf());
            }
            changeCalendarView({target: {id: 'prev-week-btn'}});
        });
    }

    if (nextWeekBtn) {
        nextWeekBtn.addEventListener('click', function() {
            if (!selectedWeekStartDate) { // Initialiser si null
                console.warn("nextWeekBtn: selectedWeekStartDate non initialisée. Tentative d'init depuis input ou aujourd'hui.");
                selectedWeekStartDate = weekDateSelectInput && weekDateSelectInput.valueAsDate 
                                        ? new Date(weekDateSelectInput.valueAsDate.valueOf()) 
                                        : new Date();
            }
            selectedWeekStartDate.setDate(selectedWeekStartDate.getDate() + 7);
            if(weekDateSelectInput) {
                weekDateSelectInput.valueAsDate = new Date(selectedWeekStartDate.valueOf());
            }
            changeCalendarView({target: {id: 'next-week-btn'}});
        });
    }

    // Gestionnaires pour les boutons de navigation JOUR
    const prevDayBtn = document.getElementById('prev-day-btn');
    const nextDayBtn = document.getElementById('next-day-btn');
    const dayDateSelectInputForNav = document.getElementById('day-date-select'); 

    if (prevDayBtn) {
        prevDayBtn.addEventListener('click', function() {
            if (!selectedSpecificDay) {
                console.warn("prevDayBtn: selectedSpecificDay non initialisée. Tentative d'init depuis input ou aujourd'hui.");
                selectedSpecificDay = dayDateSelectInputForNav && dayDateSelectInputForNav.valueAsDate
                                      ? new Date(dayDateSelectInputForNav.valueAsDate.valueOf())
                                      : new Date();
            }
            selectedSpecificDay.setDate(selectedSpecificDay.getDate() - 1);
            if(dayDateSelectInputForNav) {
                dayDateSelectInputForNav.valueAsDate = new Date(selectedSpecificDay.valueOf());
            }
            changeCalendarView({target: {id: 'prev-day-btn'}});
        });
    }

    if (nextDayBtn) {
        nextDayBtn.addEventListener('click', function() {
            if (!selectedSpecificDay) {
                console.warn("nextDayBtn: selectedSpecificDay non initialisée. Tentative d'init depuis input ou aujourd'hui.");
                selectedSpecificDay = dayDateSelectInputForNav && dayDateSelectInputForNav.valueAsDate
                                      ? new Date(dayDateSelectInputForNav.valueAsDate.valueOf())
                                      : new Date();
            }
            selectedSpecificDay.setDate(selectedSpecificDay.getDate() + 1);
            if(dayDateSelectInputForNav) {
                dayDateSelectInputForNav.valueAsDate = new Date(selectedSpecificDay.valueOf());
            }
            changeCalendarView({target: {id: 'next-day-btn'}});
        });
    }

    // Script pour le bouton "Mémoriser cette vue" - NOUVELLE VERSION
    const btnSaveDefaultView = document.getElementById('btn-save-default-view');
    if (btnSaveDefaultView) {
        btnSaveDefaultView.addEventListener('click', function() {
            // selectedCalendarView est mis à jour par changeCalendarView() et par applyUserDefaultView()
            // On s'assure juste qu'elle a une valeur.
            // Le selecteur HTML '#calendar-view-type-select' devrait être la source de vérité si l'utilisateur
            // a changé la vue sans que `selectedCalendarView` soit mise à jour pour une raison X,
            // mais normalement `changeCalendarView` s'en occupe.
            // Par sécurité, on peut relire la valeur du selecteur ici:
            const viewSelectElement = document.getElementById('calendar-view-type-select');
            const currentSelectedViewInUI = viewSelectElement ? viewSelectElement.value : selectedCalendarView;

            if (currentSelectedViewInUI) { // Utiliser la valeur du sélecteur s'il existe, sinon la variable globale
                const preferenceToSave = { view: currentSelectedViewInUI };
                console.log("Sauvegarde du type de vue par défaut:", JSON.stringify(preferenceToSave));

                fetch('/api/user/set_calendar_preference', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(preferenceToSave)
                })
                .then(response => response.json()) // On s'attend à ce que le backend renvoie un JSON même en cas d'erreur métier
                .then(data => {
                    // Le backend devrait renvoyer un champ "success": true/false ou "message"/"error"
                    if (data.success || (data.message && !data.error)) { // Adapter selon la réponse exacte du backend
                        showFeedback(data.message || "Vue par défaut enregistrée !", "success");
                    } else {
                        showFeedback(`Erreur sauvegarde: ${data.error || data.message || 'Erreur inconnue'}`, "error");
                    }
                })
                .catch(error => {
                    console.error("Erreur réseau sauvegarde préférence:", error);
                    showFeedback("Erreur réseau lors de la sauvegarde.", "error");
                });

            } else {
                console.error("Impossible de sauvegarder : currentSelectedViewInUI (ou selectedCalendarView) est vide.");
                showFeedback("Erreur : Impossible de déterminer la vue actuelle.", "error");
            }
        });
    } else {
        console.warn("Bouton #btn-save-default-view non trouvé.");
    }
    // FIN NOUVELLE VERSION btnSaveDefaultView

    console.log("[control.html] DOMContentLoaded: Fin de l'initialisation.");
});

    </script>
{% endblock %}